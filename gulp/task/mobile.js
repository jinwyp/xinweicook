var gulp = require('gulp'),
    replace = require('gulp-replace'),
    concat = require('gulp-concat'),
    minifyHtml = require("gulp-minify-html"),
    ngTemplateCache = require('gulp-angular-templatecache');

gulp.task('mobile-ng-templates', function () {
    return gulp.src('app/public/mobile/src/js/directives/*.html')
        .pipe(minifyHtml({empty: true, quotes: true}))
        .pipe(ngTemplateCache('templates.js', { module:'xw.directives'}))
        .pipe(gulp.dest('app/public/mobile/src/js/'));
});

gulp.task('errcode', function () {
    return gulp.src(['app/libs/errcode.js', 'app/public/mobile/src/js/_config.js'])
        .pipe(replace(/^[^{]+module\.exports[^{]+(\{[\w\W]+})\s*$/, function (_, m) {
            return '//generated by gulp errcode' +
                    '\nangular.module("xw.config").constant("errCode", function(){' +
                    '\nreturn ' + m +
                    '\n});'
        }))
        .pipe(concat('config.js'))
        .pipe(gulp.dest('app/public/mobile/src/js'));
});

//gulp.watch('app/libs/errcode.js', ['errcode']).on('change', function (event) {
//    console.log('File ' + event.path + ' was ' + event.type + ', running tasks `errcode`');
//})