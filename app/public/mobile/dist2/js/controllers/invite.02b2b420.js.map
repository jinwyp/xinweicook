{"version":3,"names":[],"mappings":"","sources":["invite.js"],"sourcesContent":["angular.module('xw.controllers').controller('inviteCtrl', function ($scope, Debug, Weixin, User, Utils) {\n\n    $scope.css = {\n        showTip: false\n    };\n    $scope.ready = false;\n\n    $scope.roles = [\n        '吴咽祖','梨意疯','蔬荠','黄脖', '笋烘蕾',\n        '王俎籃', '赵煨', '徐蒸', '煲贝儿', '糊哥',\n        '鹌祖拉baby','果必停','糯一','榴墙咚','粥杰伦',\n        '梨命好','饭冰冰','京腥','凳炒','望风',\n        '梅梅','卷腐','豆森','低卡葡黎熬','掰掰合',\n        '橙薏逊', '羊幂', '糖淹', '甲奶酿', '瞪籽荠',\n        '松成鲜', '淋汁苓', '煌削茗', '鱼沉庆', '油红明',\n        'TFGirls','柠则饕','榴烨'\n    ];\n\n    $scope.places = [\n        '鹿夹嘴', '仁敏广场', '老地方', '他家', '她家',\n        '海腩岛', '续加惠', '精鹌撕', '馨舔底', '麻耳呆夫',\n        '挤粥岛'\n    ].map(function (place) {\n        return {\n            inner: place,\n            display: '约你一起去' + place + '吃便当'\n        }\n    });\n\n    $scope.role = $scope.roles[0];\n    $scope.place = $scope.places[0].inner;\n\n    function init() {\n        var avatar;\n        var avatarCount = 16; // todo:头像数量. 用gulp来替换也许比较好\n        var link = '';\n        var code = '';\n        var prefix = '';\n        User.getUserInfo().then(function (res) {\n            $scope.user = res.data;\n            var id = $scope.user._id;\n            id = '0x' + id.substr(17, 6);\n            avatar = +id % avatarCount + 1;\n            avatar = Utils.utf2b64(avatar);\n            code = Utils.utf2b64($scope.user.invitationSendCode);\n            prefix = '/' + avatar + '/' + code;\n            Debug.alert('getUser绑定share');\n            bindShare($scope.role, $scope.place)\n        }).catch(function (res) {\n            Debug.alert('获取用户信息后出错');\n            Debug.alert(res);\n        });\n\n        function bindShare(name, place) {\n            try {\n                var queries = prefix +\n                    '/' + Utils.utf2b64(name) +\n                    '/' + Utils.utf2b64(place);\n                link = location.href.replace('invite', 'invited' + queries).replace(/\\?.*/, '');\n                var title = name + '约你一起去' + place + '吃便当';\n\n                Debug.alert(link);\n                Weixin.shareAppMessage({\n                    title: title,\n                    link: link,\n                    imgUrl: 'http://m.xinweicook.com/mobile/src/img/xw_square.jpg',\n                    desc: '平时我这么高冷，今天来带你一起飞。男神女神做庄，还不快喊小伙伴一起乖乖坐好等我上菜！',\n                    //todo: 需要复用success\n                    success: function (res) {\n                        Debug.alert('分享至朋友成功');\n                        Debug.alert(res);\n                        $scope.css.showTip = false;\n                        alert('分享成功!');\n                    },\n                    cancel: function (res) {\n                        Debug.alert('取消分享朋友');\n                        Debug.alert(res);\n                    },\n                    fail: function (res) {\n                        Debug.alert('分享至朋友失败');\n                        Debug.alert(res);\n                    }\n                });\n                Weixin.shareTimeline({\n                    title: name + '约你一起去' + place + '吃便当',\n                    link: link,\n                    imgUrl: 'http://m.xinweicook.com/mobile/src/img/xw_square.jpg',\n                    success: function (res) {\n                        Debug.alert('分享至朋友圈成功');\n                        Debug.alert(res);\n                        $scope.css.showTip = false;\n                        User.invitedFriends().then(function () {\n                            alert('分享成功!');\n                        }).catch(Debug.promiseErrFn('分享至朋友圈后成功分享失败'))\n                    },\n                    cancel: function (res) {\n                        Debug.alert('取消分享至朋友圈');\n                        Debug.alert(res);\n                    },\n                    fail: function (res) {\n                        Debug.alert('分享至朋友圈失败');\n                        Debug.alert(res);\n                    }\n                });\n            } catch (e) {\n                Debug.alert('绑定share出错');\n                Debug.alert(e)\n            }\n\n\n        }\n\n        $scope.$watchGroup(['role', 'place'], function (newValues) {\n            if (!$scope.user) return;\n            Debug.alert('role, place更改绑定share');\n            bindShare(newValues[0], newValues[1]);\n        });\n\n        Weixin.getJsconfig().then(function (res) {\n\n            Weixin.config({\n                nonceStr :res.data.noncestr,\n                timestamp: res.data.timestamp,\n                signature: res.data.signature\n            });\n\n            Weixin.ready(function () {\n                Debug.alert('ready');\n                bindShare($scope.role, $scope.place);\n                $scope.ready = true;\n            })\n        }).catch(function (res) {\n            Debug.alert('获取jsconfig失败');\n            Debug.alert(res);\n        })\n    }\n\n    init();\n})"],"file":"js/controllers/invite.02b2b420.js","sourceRoot":"/source/"}