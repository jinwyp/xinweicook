{"version":3,"names":[],"mappings":"","sources":["wxpay.js"],"sourcesContent":["angular.module('xw.controllers').controller('wxpayCtrl', wxpayCtrl);\n\nfunction wxpayCtrl($scope, Orders, Debug, $localStorage) {\n\n\n    // fail1 订单号异常, fail2 支付失败, fail3 支付失败之跨号支付\n    $scope.state = 'processing';\n    $scope.showShareInfo = true;\n\n\n    function init() {\n        var paths = location.href.split('/');\n        var orderId = paths[paths.length - 1];\n        var paid = false;\n\n        if (orderId == 'NOORDERID') { // NOORDERID来自二维码\n            if ($localStorage.orderId) {\n                orderId = $localStorage.orderId;\n                delete $localStorage.orderId;\n            }\n            if ($localStorage.chargeOnline) {\n                delete $localStorage.chargeOnline;\n                orderId = 'CHARGEBALANCE'\n            }\n        }\n\n        if (orderId == 'CHARGEBALANCE') {\n            if ($localStorage.wxInfo) {\n                $scope.showShareInfo = false;\n                var wxInfo = $localStorage.wxInfo;\n                delete $localStorage.wxInfo;\n\n                function onBridgeReady() {\n\n                    WeixinJSBridge.invoke(\n                        'getBrandWCPayRequest', {\n                            \"appId\": wxInfo.appId, //\"wx37a1323e488cef84\",     //公众号名称，由商户传入\n                            \"timeStamp\": wxInfo.timeStamp,         //时间戳，自1970年以来的秒数\n                            \"nonceStr\": wxInfo.nonceStr, //随机串\n                            \"package\": wxInfo.package,\n                            \"signType\": wxInfo.signType,         //微信签名方式：\n                            \"paySign\": wxInfo.paySign //微信签名\n                        },\n                        function (res) {\n                            if (/\\bok\\b/.test(res.err_msg)) {\n                                $scope.$apply(function () {\n                                    $scope.state = 'success';\n                                    setTimeout(function () {\n                                        location.href = '/mobile/balance';\n                                    }, 2000);\n                                });\n                            } else {    // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。\n                                Debug.alert('支付失败');\n                                Debug.alert(res);\n                                $scope.$apply(function () {\n                                    $scope.state = 'fail2';\n                                    //  跨号支付\n                                    if (typeof res.err_desc == 'string' &&\n                                        res.err_desc.indexOf('跨号') != -1) {\n                                        $localStorage.orderId = orderId;\n                                        $localStorage.chargeOnline = true;\n                                        alert(res.err_desc);\n                                        $scope.state = 'fail3';\n                                    }\n                                });\n                            }\n                        }\n                    );\n                }\n\n                if (typeof WeixinJSBridge == \"undefined\") {\n                    if (document.addEventListener) {\n                        document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);\n                    } else if (document.attachEvent) {\n                        document.attachEvent('WeixinJSBridgeReady', onBridgeReady);\n                        document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);\n                    }\n                } else {\n                    onBridgeReady();\n                }\n            } else {\n                alert('支付失败:无余额充值信息');\n            }\n            return;\n        }\n\n        if (!/^\\w{24}$/.test(orderId)) {\n            alert('支付失败, 请稍后重试');\n            $scope.state = 'fail1';\n            return;\n        }\n\n        Debug.alert('订单ID' + orderId);\n        Orders.getUnifiedOrder({\n            _id: orderId,\n            trade_type: 'JSAPI'\n        }).then(function (res) {\n            $scope.order = res.data;\n            var wxInfo = res.data.paymentWeixinpay.mobileSign;\n            // todo: weixin h5 pay https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_7\n            function onBridgeReady() {\n                if (paid) return;\n                WeixinJSBridge.invoke(\n                    'getBrandWCPayRequest', {\n                        \"appId\": \"wx37a1323e488cef84\",     //公众号名称，由商户传入\n                        \"timeStamp\": wxInfo.timeStamp,         //时间戳，自1970年以来的秒数\n                        \"nonceStr\": wxInfo.nonceStr, //随机串\n                        \"package\": wxInfo.package,\n                        \"signType\": wxInfo.signType,         //微信签名方式：\n                        \"paySign\": wxInfo.paySign //微信签名\n                    },\n                    function (res) {\n                        if (/\\bok\\b/.test(res.err_msg)) {\n                            delete $localStorage.confirmedBag;\n                            Orders.updateOrder(orderId, {isPaymentPaid: 'true'});\n                            $scope.$apply(function () {\n                                $scope.state = 'success';\n                            });\n                        } else {    // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。\n                            Debug.alert('支付失败');\n                            Debug.alert(res);\n                            Orders.updateOrder(orderId, {isPaymentPaid: 'false'});\n                            $scope.$apply(function () {\n                                $scope.state = 'fail2';\n                                //  跨号支付\n                                if (typeof res.err_desc == 'string' &&\n                                    res.err_desc.indexOf('跨号') != -1) {\n                                    $localStorage.orderId = orderId;\n                                    alert(res.err_desc);\n                                    $scope.state = 'fail3';\n                                }\n                            });\n                        }\n                    }\n                );\n                paid = true;\n            }\n\n            if (typeof WeixinJSBridge == \"undefined\") {\n                if (document.addEventListener) {\n                    document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);\n                } else if (document.attachEvent) {\n                    document.attachEvent('WeixinJSBridgeReady', onBridgeReady);\n                    document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);\n                }\n            } else {\n                onBridgeReady();\n            }\n\n        }).catch(function (res) {\n            Debug.alert(res);\n            setTimeout(function () {\n                Orders.getOrder(orderId).then(function (order) {\n                    if (order.status == 'paid') {\n                        $scope.state = 'success'\n                    } else {\n                        Orders.getOrder(orderId + encodeURIComponent(navigator.userAgent));\n                        //alert('亲,生成订单出了点意外,请在 我的订单 中重新支付!');\n                        //setTimeout(function () {\n                        //    location.href = '/mobile/orderlist';\n                        //}, 100);\n                    }\n                })\n            }, 1000);\n        })\n    }\n    init();\n}\n"],"file":"js/controllers/wxpay.91faf7fd.js","sourceRoot":"/source/"}