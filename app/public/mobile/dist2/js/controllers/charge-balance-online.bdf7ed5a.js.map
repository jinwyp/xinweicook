{"version":3,"names":[],"mappings":"","sources":["charge-balance-online.js"],"sourcesContent":["angular.module('xw.controllers').controller('chargeBalanceOnlineCtrl', function ($localStorage, $scope, Debug, Alert, Balance, User) {\n\n    var isWeiXin = /MicroMessenger/i.test(navigator.userAgent);\n    var openid = '';\n    var chargeSelections;\n\n    $scope.chargeOnline = function () {\n        //todo: 如果在微信里边,但是没有从用户对象上到openid,则需要先通过微信获取openid\n        if (isWeiXin && !openid) {\n            // todo: to be Completed\n            // 访问微信服务器,通过用户授权,微信重定向到一个url,并附上wxstate和授权id,\n            // 然后自己服务器拿着授权id再去问微信要openid,拿到后然后重定向用户请求到支付页面,\n            // 然后浏览器端发起统一支付订单请求,返回后再调用微信api进行支付\n            // 这里的问题在于:\n            //  1.wxstate原来是orderid,但充值浏览器端并没有获取到一个orderid;\n            //  2.而充值的统一支付订单这里无需浏览器主动发起.(问题:似乎需要在微信支付页面发起充值请求)\n        }\n\n        var data = {\n            addAmount: chargeSelections[chargeSelections.selected].price,\n            payment: isWeiXin ? 'weixinpay' : 'alipay direct',\n            device_info: 'WEB',\n            spbill_create_ip: '8.8.8.8',\n            trade_type: 'JSAPI',\n            url: '',\n            openid: openid\n        };\n\n        Balance.chargeOnline(data).then(function (res) {\n            if (!isWeiXin) {\n                location.href = res.data.aliPaySign.fullurl;\n                return;\n            }\n\n            $localStorage.wxInfo = res.data.weixinPayUnifiedOrder.wxPay_mobileSign;\n\n            setTimeout(function () {\n                location.href = '/mobile/wxpay/CHARGEBALANCE';\n            }, 200);\n        })\n    };\n\n    function init() {\n        chargeSelections = $scope.chargeSelections = [\n            {\n                price: 480,\n                coin: 500\n            },\n            {\n                price: 980,\n                coin: 1080\n            },\n            {\n                price: 1980,\n                coin: 2200\n            },\n            {\n                price: 2980,\n                coin: 3400\n            }\n        ];\n        $scope.chargeSelections.selected = 0;\n\n        Balance.balance().then(function (res) {\n            $scope.balance = res.data.balance;\n        }).catch(Debug.promiseErrFn('查询余额失败'));\n\n        User.getUserInfo().then(function (res) {\n            var weixinId = res.data.weixinId;\n            if (weixinId && weixinId.openid) {\n                openid = weixinId.openid;\n            }\n        })\n    }\n\n    init();\n\n});"],"file":"js/controllers/charge-balance-online.bdf7ed5a.js","sourceRoot":"/source/"}