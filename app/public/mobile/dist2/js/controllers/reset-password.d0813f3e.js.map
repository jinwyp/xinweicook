{"version":3,"names":[],"mappings":"","sources":["reset-password.js"],"sourcesContent":["angular.module('xw.controllers').controller('resetPasswordCtrl', resetPasswordCtrl);\n\nfunction resetPasswordCtrl($scope, User, $location, Alert, Weixin, $localStorage) {\n    $scope.loginData = {};\n    $scope.signupData = {};\n    $scope.resetPwdData = {};\n    $scope.path = '';\n\n    $scope.sms = {\n        state: 'init' // 短信按钮的状态\n    };\n\n    $scope.css = {\n        pending: false,\n        triggered: false, // 表示是否已经尝试发送短信码\n        hasVoiceSent: false // 表示是否已经尝试发送语音短信\n    };\n\n    var pwdErrTimes = 0;\n    $scope.login = function () {\n        $scope.css.pending = true;\n        User.login($scope.loginData.username, $scope.loginData.password, couponcode)\n            .then(redirect)\n            .catch(function (res) {\n                resetPending();\n                if (res.data) {\n                    if (res.data.validationStatus == 1111) {\n                        if (++pwdErrTimes >= 2) {\n                            alert('密码错误, 请重试. \\n提示: 新味PC网站(xinweicook.com)的帐号与新味便当暂不兼容, 如果您是PC版老用户, 烦请重新注册!')\n                        } else {\n                            alert('密码错误, 请重试');\n                        }\n                    } else Alert.show(res.data.validationStatus, '登录失败, 请稍后再试')\n                } else {\n                    alert('登录失败, 请稍后再试');\n                }\n            })\n    };\n\n    $scope.signup = function () {\n        $scope.css.pending = true;\n        User.signup(\n            $scope.signupData.mobile,\n            $scope.signupData.pwd,\n            $scope.signupData.code,\n            couponcode\n        ).then(function () {\n                // todo: redirect\n                alert('注册成功!');\n                redirect();\n            }).catch(function (res) {\n                resetPending();\n                Alert.show(res.data.validationStatus, '注册失败,请稍后重试');\n            })\n    };\n\n    $scope.resetPwd = function () {\n        $scope.css.pending = true;\n        User.resetPwd(\n            $scope.resetPwdData.mobile,\n            $scope.resetPwdData.pwd,\n            $scope.resetPwdData.code\n        ).then(function (res) {\n                alert('密码重置成功,请重新登录!');\n                location.href = '/mobile/login'\n            }).catch(function (res) {\n                resetPending();\n                Alert.show(res.data.validationStatus, '重置密码失败, 请稍后重置');\n            })\n    };\n\n    $scope.getVoiceSms = function () {\n        if ($scope.css.hasVoiceSent || !$scope.css.triggered) return\n        $scope.css.hasVoiceSent = true\n        User.getSmsCode({\n            mobile: $scope.resetPwdData.mobile,\n            type: 'resetPassword',\n            isVoice: \"true\"\n        }).success(function() {\n            console.log(\"success\")\n        }).catch(function (res) {\n            Alert.show(res.data.validationStatus, '验证码发送失败');\n        });\n    }\n\n    $scope.back = function () {\n        history.back();\n    };\n\n    $scope.$on('$locationChangeStart', function () {\n        $scope.path = $location.path();\n    });\n\n    var couponcode = '';\n    var promotion = '';\n    var searches;\n\n    function init() {\n        var path = $location.path() || '/login';\n        $location.path(path);\n        $scope.path = path;\n\n        searches = location.search.slice(1).split('&');\n        searches = searches.reduce(function (obj, cur) {\n            cur = cur.split('=');\n            obj[cur[0]] = decodeURIComponent(cur[1]);\n            return obj;\n        }, {});\n\n        couponcode = searches.couponcode || '';\n        if (Weixin.isWeixin && couponcode.indexOf('XWNOD') == 0 && couponcode.length == 10) {\n            $localStorage.promotion = promotion = couponcode;\n            couponcode = '';\n        }\n    }\n\n    function redirect() {\n        var redirect = searches['redirect'];\n        if (redirect) {\n            if (!/(\\/\\w*)+/.test(redirect)) {\n                redirect = '/mobile/';\n            }\n        } else redirect = '/mobile/';\n\n        User.getUserInfo().then(function (res) {\n            var user = res.data;\n\n            // 未授权\n            if (Weixin.isWeixin && (!user.weixinId || !user.weixinId.openid)) {\n                redirect = '/api/user/weixin/oauthcode?redirectUrl=' +\n                    encodeURIComponent(redirect.replace('/mobile/', '')) +\n                    '&userId=' + user._id ;\n\n                // 如果是地推活动,则强制跳到首页\n                if (promotion) {\n                    redirect = '/api/user/weixin/oauthcode?redirectUrl=&userId=' + user._id;\n                }\n            }\n\n            setTimeout(function () {\n                location.replace(redirect);\n            }, 100);\n        });\n    }\n\n    function resetPending() {\n        $scope.css.pending = false;\n    }\n\n    init();\n}\n"],"file":"js/controllers/reset-password.d0813f3e.js","sourceRoot":"/source/"}