{"version":3,"names":[],"mappings":"","sources":["order-list2.js"],"sourcesContent":["angular.module('xw.controllers').controller('orderlistCtrl2', orderlistCtrl2);\n\nfunction orderlistCtrl2($scope, Orders, $location) {\n\n    $scope.orders = null\n    $scope.curOrder = null\n    $scope.address = null\n\n    $scope.back = function () {\n        history.back();\n    };\n\n    $scope.cancelOrder = function (id) {\n        Orders.cancel(id).then(function () {\n            $scope.orders.some(function (order) {\n                if (order._id == id) {\n                    order.status = 'canceled'\n                    return true\n                }\n            })\n        })\n    }\n\n    $scope.pay = function () {\n        if ($scope.curOrder.payment == 'weixinpay') {\n            location.href = '/mobile/wxpay/' + $scope.curOrder._id\n        } else if ($scope.curOrder.payment == 'alipay direct') {\n            Orders.payByAlipay($scope.curOrder._id).then(function (res) {\n                location.href = res.data.fullurl\n            })\n        }\n    }\n\n    $scope.$on('$locationChangeSuccess', function () {\n        setCurOrder()\n    })\n\n    function setCurOrder() {\n        var id = $location.path().slice(1);\n        if (!id || !$scope.orders) {\n            $scope.curOrder = null\n            return\n        }\n\n        $scope.orders.some(function (order) {\n            if (order._id == id) {\n                $scope.curOrder = order\n                return true\n            }\n        })\n    }\n\n    function init() {\n        Orders.getList().then(function (res) {\n            // 首先过滤出子订单,以便在之后的遍历中使用\n            var childOrders = res.data.reduce(function (map, order) {\n                if (order.isChildOrder) {\n                    map[order._id] = order\n                }\n                return map\n            }, {})\n\n            $scope.orders = res.data.filter(function (order) {\n                if (order.dishList.some(function (el) {\n                        return !el.dish\n                    })) return false\n\n                order.cookList = []\n                order.eatList = []\n                order.dishList.forEach(function (el) {\n                    if (el.dish.cookingType == 'ready to cook') {\n                        order.cookList.push(el)\n                    }\n                    if (el.dish.cookingType == 'ready to eat') {\n                        order.eatList.push(el)\n                    }\n                })\n\n                if (order.eatList.length && order.cookList.length) {\n                    order.cookingType = '食材包&便当'\n                } else if (order.eatList.length) {\n                    order.cookingType = '便当'\n                } else {\n                    order.cookingType = '食材包'\n                }\n\n                // 未支付的订单, 过滤isChildOrder:true; 已支付的显示子订单, 过滤isSplitOrder:true\n                if (order.status == 'not paid') {\n                    if (!order.isChildOrder) {\n                        order.childOrderList.forEach(function (id) {\n                            var child = childOrders[id]\n                            var type = child.cookingType == 'ready to cook' ? 'cookList' : 'eatList'\n                            order[type].deliveryDateTime = child.deliveryDateTime\n                        })\n                        return true\n                    }\n                } else {\n                    return !order.isSplitOrder\n                }\n            })\n\n            setCurOrder()\n        })\n    }\n\n    init();\n}"],"file":"js/controllers/order-list2.88e9dbed.js","sourceRoot":"/source/"}