{"version":3,"names":[],"mappings":"","sources":["cart.js"],"sourcesContent":["angular.module('xw.controllers').controller('cartCtrl', function ($scope, User, $localStorage, $timeout, $filter, Utils) {\n\n    $scope.increase = function (item) {\n        // 先更新展示数据上的数量\n        item.number++;\n        item.subDish.forEach(function (sDish) {\n            sDish.number = item.number;\n        });\n\n        User.postCart(postCart.map(postDishFilter))\n    };\n\n    $scope.decrease = function (item, idx) {\n        var key = item.dish.cookingType == 'ready to cook' ? 'cookList' : 'eatList';\n        var list = $scope.dishList[key];\n        if (item.number == 1) {\n            $scope.confirm().then(function (confirm) {\n                if (!confirm) return;\n\n                remove();\n            })\n        } else remove();\n\n        function remove() {\n            item.number--;\n            item.subDish.forEach(function (el) {\n                el.number--;\n            });\n\n            if (!item.number) {\n                list.splice(idx, 1);\n                postCart.splice(postCart.indexOf(item), 1);\n            }\n\n            User.postCart(postCart.map(postDishFilter))\n        }\n    };\n\n    var CJDishId = '56988143247c25ce3fa59a01'\n    var QRJDishId = '56a4dc2097fdeb3361dcc7b1'\n    var address = $localStorage.orderAddress\n    $scope.select = function (item) {\n        if (item.outOfStock) return;\n\n        // todo: 情人节特殊处理\n        var cookList = $scope.dishList.cookList\n        var isOtherSelected, isCJSelected, isQRJSelected\n        isOtherSelected = cookList.some(function (el) {\n            return el.selected && el.dish._id != CJDishId && el.dish._id != QRJDishId\n        })\n        cookList.forEach(function (el) {\n            if (el.selected && el.dish._id == CJDishId) {\n                isCJSelected = true\n            }\n            if (el.selected && el.dish._id == QRJDishId) {\n                isQRJSelected = true\n            }\n        })\n        if (isCJSelected) {\n            if (item.dish._id == QRJDishId) {\n                alert('由于配送时间的冲突, 情人节套餐不能和春节套餐同时下单')\n                return\n            }\n        }\n        if (isQRJSelected) {\n            if (item.dish._id == CJDishId) {\n                alert('由于配送时间的冲突, 情人节套餐不能和春节套餐同时下单')\n                return\n            }\n        }\n        var JZHW = ['江苏', '浙江', '上海', '安徽']\n        if (JZHW.indexOf(address.province) == -1 && item.dish._id == QRJDishId) {\n            alert('情人节套餐暂时只限江浙沪皖地区可下单')\n            return\n        }\n\n        item.selected = !item.selected;\n\n        var type = item.dish.cookingType == 'ready to cook'\n            ? 'cookList' : 'eatList';\n\n        var isAllSelected = $scope.dishList[type].every(function (item) {\n            return item.selected\n        });\n\n        if (isAllSelected) {\n            $scope.selectAll(type, isAllSelected);\n        } else if (!isAllSelected) {\n            $scope.dishList[type].selectedAll = false;\n        }\n    };\n\n    $scope.selectAll = function (type, outState) {\n        // todo: 情人节,春节特殊处理\n        var cookList = $scope.dishList.cookList\n        var hasQRJ = cookList.some(function (el) {\n            return (el.dish._id == QRJDishId)\n        })\n        var hasCJ = cookList.some(function (el) {\n            return el.dish._id == CJDishId\n        })\n\n        if (hasQRJ && hasCJ) {\n            alert('由于配送时间的冲突, 情人节套餐不能和春节套餐同时下单')\n            return\n        }\n\n        var JZHW = ['江苏', '浙江', '上海', '安徽']\n        if (JZHW.indexOf(address.province) == -1 && hasQRJ) {\n            alert('情人节套餐暂时只限江浙沪皖地区可下单')\n            return\n        }\n\n        var state = $scope.dishList[type].selectedAll =\n            (outState !== undefined ? outState : !$scope.dishList[type].selectedAll);\n        $scope.dishList[type].forEach(function (item) {\n            item.selected = state && !item.outOfStock;\n        });\n    };\n\n    var dishPrice = $filter('dishPrice');\n    $scope.selectedDishLength = 0;\n    $scope.totalPrice = function (listName) {\n        var price = 0;\n        var keys = listName ? [listName] : ['cookList', 'eatList'];\n        $scope.dishList && keys.forEach(function (key) {\n            var list = $scope.dishList[key];\n            list.selectedLength = 0;\n            list && list.forEach(function (el) {\n                if (!el.selected) return;\n                list.selectedLength++;\n                price += dishPrice(el, true);\n            })\n        });\n        return price;\n    };\n\n    $scope.next = function () {\n        if (!$scope.dishList.cookList.selectedLength\n            && !$scope.dishList.eatList.selectedLength\n        ) {\n            alert('请至少选择一份菜品');\n            return;\n        }\n\n        if (!$scope.dishList.cookList.selectedLength) {\n            if ($scope.dishList.eatList.filter(function (dish) {\n                    return dish.selected;\n                }).every(function (dish) {\n                    return dish.dish.sideDishType == 'drink'\n                })) {\n                alert('然而只点饮料并不能配送, 亲!');\n                return ;\n            }\n        }\n\n        $localStorage.confirmedBag = {\n            cookList: $scope.dishList.cookList.filter(function (d) {return d.selected}),\n            eatList: $scope.dishList.eatList.filter(function (d) {return d.selected})\n        };\n\n        $timeout(function () {\n            location.href = '/mobile/orderpay';\n        }, 150);\n    };\n\n    var adapt = $filter('adapt');\n    $scope.imgAdapt = function (src) {\n        return adapt(src);\n    };\n\n    var postDishFilter = $filter('postDish');\n    var postCart = null;\n\n    function init() {\n        User.getUserInfo().then(function (res) {\n            return res.data.shoppingCart\n        }).catch(function () {\n            return []\n        }).then(function (serverBag) {\n            serverBag = serverBag.filter(function (item) {\n                return !!item.dish\n            });\n            postCart = serverBag;\n            initDishList(postCart);\n        })\n    }\n\n    function initDishList(cart) {\n        $scope.dishList = {\n            cookList: [],\n            eatList: [],\n            noReachList: []\n        };\n\n        var warehouse = $localStorage.warehouse;\n        var isAvailableForEat = $localStorage.orderAddress.isAvailableForEat;\n\n        cart.forEach(function (el) {\n            var dish = el.dish;\n\n            // postCart的dish和list上的引用的是同一个对象\n            if (dish.cookingType == 'ready to cook') {\n                if (dish.stockWarehouse.some(function (item) {\n                        return item.stock > 0;\n                    })) {\n                    el.outOfStock = false;\n                }\n                $scope.dishList.cookList.push(el);\n            } else {\n                el.outOfStock = !isAvailableForEat || !Utils.stockOfItem(el, warehouse);\n                $scope.dishList.eatList.push(el);\n                //if (el.outOfStock) {\n                //    $scope.dishList.noReachList.push(el);\n                //} else {\n                //    $scope.dishList.eatList.push(el);\n                //}\n            }\n        });\n    }\n\n    init();\n});"],"file":"js/controllers/cart.fe6c7bd7.js","sourceRoot":"/source/"}