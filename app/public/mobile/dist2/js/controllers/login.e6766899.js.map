{"version":3,"names":[],"mappings":"","sources":["login.js"],"sourcesContent":["angular.module('xw.controllers').controller('loginCtrl', loginCtrl);\n\nfunction loginCtrl($scope, User, $location, Alert, Weixin, $localStorage) {\n    $scope.loginData = {};\n    $scope.signupData = {};\n    $scope.resetPwdData = {};\n    $scope.path = '';\n\n    $scope.sms = {\n        state: 'init' // 短信按钮的状态\n    };\n\n    $scope.css = {\n        pending: false,\n        triggered: false, // 表示是否已经尝试发送短信码\n        hasVoiceSent: false // 表示是否已经尝试发送语音短信\n    };\n\n    $scope.login = function () {\n        $scope.css.pending = true;\n        User.login($scope.loginData.username, $scope.loginData.password, couponcode)\n        .then(redirect)\n        .catch(function (res) {\n            resetPending();\n            if (res.data) {\n                if (res.data.validationStatus == 1111) {\n                    alert('密码错误, 请重试');\n                } else Alert.show(res.data.validationStatus, '登录失败, 请稍后再试')\n            } else {\n                alert('登录失败, 请稍后再试');\n            }\n        })\n    };\n    \n    $scope.signup = function () {\n        $scope.css.pending = true;\n        User.signup(\n            $scope.signupData.mobile,\n            $scope.signupData.pwd,\n            $scope.signupData.code,\n            couponcode,\n            searches.referrer\n        ).then(function () {\n            // todo: redirect\n            alert('注册成功!');\n            redirect();\n        }).catch(function (res) {\n            resetPending();\n            Alert.show(res.data.validationStatus, '注册失败,请稍后重试');\n        })\n    };\n\n    $scope.resetPwd = function () {\n        $scope.css.pending = true;\n        User.resetPwd(\n            $scope.resetPwdData.mobile,\n            $scope.resetPwdData.pwd,\n            $scope.resetPwdData.code\n        ).then(function (res) {\n            alert('密码重置成功,请重新登录!');\n            location.href = '/mobile/login'\n        }).catch(function (res) {\n            resetPending();\n            Alert.show(res.data.validationStatus, '重置密码失败, 请稍后重置');\n        })\n    };\n\n    $scope.getVoiceSms = function () {\n        if ($scope.css.hasVoiceSent || !$scope.css.triggered) return\n        $scope.css.hasVoiceSent = true\n        User.getSmsCode({\n            mobile: $scope.signupData.mobile,\n            type: 'signUp',\n            isVoice: \"true\"\n        }).success(function() {\n            console.log(\"success\")\n        }).catch(function (res) {\n            Alert.show(res.data.validationStatus, '验证码发送失败');\n        });\n    }\n\n    $scope.back = function () {\n        history.back();\n    };\n\n    $scope.$on('$locationChangeStart', function () {\n        $scope.path = $location.path();\n    });\n\n    var couponcode = '';\n    var promotion = '';\n    var searches;\n\n    function init() {\n        var path = $location.path() || '/login';\n        $location.path(path);\n        $scope.path = path;\n\n        searches = location.search.slice(1).split('&');\n        searches = searches.reduce(function (obj, cur) {\n            cur = cur.split('=');\n            obj[cur[0]] = decodeURIComponent(cur[1]);\n            return obj;\n        }, {});\n\n        couponcode = searches.couponcode || '';\n        if (Weixin.isWeixin && couponcode.indexOf('XWNOD') == 0 && couponcode.length == 10) {\n            $localStorage.promotion = promotion = couponcode;\n            couponcode = '';\n        }\n\n        User.getUserInfo().then(function (res) {\n            // 如果在登录页面获取到用户信息,那么跳转到首页\n\n            // 如果用户已经处于登录状态,并且有couponcode\n            if (couponcode) {\n                $location.path('/login');\n                return;\n            }\n\n            setTimeout(function () {\n                location.href = '/mobile/';\n            }, 120);\n        });\n    }\n\n    function redirect() {\n        var redirect = searches['redirect'];\n        if (redirect) {\n            if (!/(\\/\\w*)+/.test(redirect)) {\n                redirect = '/mobile/';\n            }\n        } else redirect = '/mobile/';\n\n        User.getUserInfo().then(function (res) {\n            var user = res.data;\n\n            // 未授权\n            if (Weixin.isWeixin && (!user.weixinId || !user.weixinId.openid)) {\n                redirect = '/api/user/weixin/oauthcode?redirectUrl=' +\n                    encodeURIComponent(redirect.replace('/mobile/', '')) +\n                    '&userId=' + user._id ;\n\n                // 如果是地推活动,则强制跳到首页\n                if (promotion) {\n                    redirect = '/api/user/weixin/oauthcode?redirectUrl=&userId=' + user._id;\n                }\n            }\n\n            setTimeout(function () {\n                location.replace(redirect);\n            }, 100);\n        });\n    }\n\n    function resetPending() {\n        $scope.css.pending = false;\n    }\n\n    init();\n}\n"],"file":"js/controllers/login.e6766899.js","sourceRoot":"/source/"}