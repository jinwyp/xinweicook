{"version":3,"names":[],"mappings":"","sources":["order-pay.js"],"sourcesContent":["angular.module('xw.controllers').controller('orderPayCtrl', function (Alert, $scope, $localStorage, Orders, User, Balance, Weixin, $filter, Utils) {\n    // 此类变量在被重新赋予新值较为麻烦,需要cart = data.cart = ..\n    var cart, address, time, coupon;\n    var data = $scope.data = {\n        cart: null,\n        address: null,\n        time: {},\n        coupon: {},\n        balance: {},\n        freight: 6,\n        orderPrice: 0,\n        payment: {\n            weixinpay: '微信支付',\n            'alipay direct': '支付宝支付',\n            'account balance': '余额支付'\n        }\n    };\n\n    var model = $scope.model = {\n        time: {},\n        coupon: {},\n        userComment: ''\n    };\n    \n    var isWeixin = $scope.isWeixin = Weixin.isWeixin;\n\n    function init() {\n        var isCityShanghai;\n\n        // 购物车\n        cart = data.cart = $localStorage.confirmedBag;\n\n        if (!cart) {\n            location.href = '/mobile'\n            return\n        }\n\n        // 地址\n        address = data.address = $localStorage.orderAddress;\n        isCityShanghai = address.province.indexOf('上海') != -1;\n\n        // 配送费用\n        Orders.price(orderData('freight')).then(function (res) {\n            data.freight = res.data.freight;\n        });\n\n        // 配送时间\n        time = data.time;\n        cart.eatList && cart.eatList.length && Orders.deliveryEatTime({\n            _id: $localStorage.warehouse\n        }).then(function (res) {\n            time.eat = res.data.timeList;\n        });\n        cart.cookList && cart.cookList.length && Orders.deliveryTime({\n            cookingType: \"ready to cook\",\n            isCityShanghai: isCityShanghai,\n            isInRange4KM: address.warehouse == '56332187594b09af6e6c7dd2'\n                && address.isAvailableForEat\n        }).then(function (res) {\n            time.cook = $filter('cookTimeUnion')(res.data);\n            //model.time.cook = {day: time.cook[0]};\n        });\n\n        // 购物车处理\n        for (var name in cart) {\n            if (!cart[name].length) delete cart[name];\n        }\n\n        // 余额\n        Balance.balance().then(function (res) {\n            data.balance.total = res.data.balance;\n            data.balance.enabled = !!res.data.balance;\n        });\n\n        // 订单金额(不含运费) 应该独立出去\n        var dishPrice = $filter('dishPrice');\n        for (var name in cart) {\n            var list = cart[name];\n            data.orderPrice += list.reduce(function (total, cur) {\n                return total + dishPrice(cur, true)\n            }, 0)\n        }\n\n        // 优惠券\n        coupon = data.coupon;\n        User.getUserInfo().then(function (res) {\n            coupon.cardList = res.data.couponList.filter(function (el) {\n                var startDate = new Date(el.startDate);\n                var endDate = new Date(el.endDate);\n                var now = Date.now();\n\n                return !el.isUsed && (startDate < now && endDate > now) && data.orderPrice >= el.priceLimit;\n            });\n            if (coupon.cardList.length) {\n                model.coupon.card = angular.sort(coupon.cardList, function (a, b) {\n                    return b.price - a.price\n                })[0];\n            }\n        });\n    }\n\n    $scope.totalPrice = function () {\n        return data.orderPrice + data.freight;\n    };\n\n    $scope.couponPrice = function (form) {\n        var cardPrice,\n            codePrice = 0,\n            totalPrice = 0;\n        cardPrice = model.coupon.card ? model.coupon.card.price : 0;\n        if (data.coupon.codeType == 'promocodepercentage') {\n            totalPrice = $scope.totalPrice() - cardPrice\n            codePrice = (100 - data.coupon.codePrice) / 100 * totalPrice\n\n            if (form) {\n                if (form.couponcode.$viewValue.length < 10 && form.couponcode.$viewValue.length !=8 && form.couponcode.$error.pattern\n                    || (form.couponcode.$viewValue.length == 8 && form.couponcode.$error.pattern)\n                    || form.$error.couponCode\n                ) {\n                    codePrice = 0\n                    console.log('wtf')\n                }\n            }\n        } else {\n            codePrice = data.coupon.codePrice || 0\n        }\n        return cardPrice + codePrice; // codePrice由异步校验指令赋值\n    };\n\n    $scope.usedBalance = function () {\n        var balance = data.balance;\n        if (!balance.total || !balance.enabled) return 0;\n\n        var remainPrice = $scope.totalPrice() - $scope.couponPrice();\n        remainPrice = balance.total <= remainPrice ? balance.total : remainPrice;\n        return remainPrice < 0 ? 0 : remainPrice;\n    };\n\n    $scope.payPrice = function () {\n        var usedBalance = $scope.usedBalance();\n        var payPrice = $scope.totalPrice() - $scope.couponPrice() - usedBalance;\n        if (payPrice <= 0) {\n            // 当价格小于等于0时, 如果计算出的使用余额为0(即优惠券已够用无需用余额), 则需要用户支付0.1\n            payPrice = usedBalance ? 0 : 0.1\n        }\n        return payPrice;\n    };\n\n    $scope.payment = function (isHtml) {\n        var payment = $scope.isWeixin ? 'weixinpay' : 'alipay direct';\n        payment = $scope.payPrice() == 0 ? 'account balance' : payment;\n        payment = isHtml ? data.payment[payment] : payment;\n        return payment\n    };\n\n    /**\n     * 获取提交订单或计算运费的对象\n     * @param type 如果type为freight,则为计算运费需要的对象.\n     * @returns {*}\n     */\n    function orderData(type) {\n        if (!orderData._data) {\n            orderData._data = {\n                cookingType:  cart.eatList && cart.eatList.length\n                    ? 'ready to eat' : 'ready to cook',\n                addressId: $localStorage.orderAddress._id\n            };\n            angular.extend(orderData._data, $filter('dishes')(cart, 'order', 'displayCart'))\n        }\n        if (!orderData.dishes) {\n            orderData.dishes = $filter('dishes');\n        }\n        if (!orderData.orderTime) {\n            orderData.orderTime = $filter('orderTime');\n        }\n        if (!orderData.coupon) {\n            orderData.coupon = $filter('coupon')\n        }\n\n        var order = angular.copy(orderData._data);\n        order.clientFrom = isWeixin && $scope.payPrice() > 0 ? 'wechat' : 'mobileweb';\n        order.usedAccountBalance = !!$scope.usedBalance();\n        angular.extend(order, orderData.coupon(model.coupon));\n\n        if (type != 'freight') {\n            angular.extend(order, {\n                freight: data.freight,\n                payment: $scope.payment(),\n                device_info: 'WEB',\n                trade_type: 'JSAPI',\n                credit: 0,\n                spbill_create_ip: '8.8.8.8',\n                paymentUsedCash: false,\n                userComment: model.userComment\n            }, orderData.orderTime(model.time, 'all'))\n        }\n\n        return order;\n    }\n\n    var isSubmitting = false;\n    $scope.order = function (form) {\n        if (!isTimeValid() || form.$invalid) return;\n        if (isSubmitting) return;\n\n        isSubmitting = true;\n        // 设置order对象参数\n        var order = orderData();\n        var payment = $scope.payment();\n\n        Orders.postOrder(order).then(function (res) {\n            // todo: clear some locals to prevent from reordering.\n            clear();\n\n            // use setTimeout for clearing locals\n            setTimeout(function () {\n                if (payment == 'account balance') {\n                    alert('支付成功');\n                    location.replace('/mobile/invite')\n                }\n\n                if (payment == 'weixinpay')\n                    location.href = '/mobile/wxpay/' + res.data._id;\n\n                if (payment == 'alipay direct')\n                    location.href = res.data.aliPaySign.fullurl;\n            }, 150)\n        }).catch(function (res) {\n            isSubmitting = false;\n            var tip = Alert.message(res.data.validationStatus);\n            var message = res.data.message;\n            if (res.data.validationStatus == 4110) {\n                if (/Dish Out Of Stock ! \\w+ ([\\w\\u4E00-\\u9FA5]+)/.\n                        test(message)) {\n                    alert(RegExp.$1 + tip);\n                    return;\n                }\n                alert(tip);\n                return;\n            }\n            alert('生成订单失败,请稍后再试');\n        })\n\n    };\n\n    init();\n\n    function isTimeValid() {\n        var valid = true;\n        if (time.eat && !model.time.eat) {\n            alert('请选择便当配送时间');\n            valid = false;\n        }\n        if (time.cook && !model.time.cook) {\n            alert('请选择食材包配送时间');\n            valid = false;\n        }\n        return valid;\n    }\n\n    function clear() {\n        delete $localStorage.confirmedBag;\n        var localBag = $localStorage.localBag;\n        if (!localBag) return;\n        for (var key in cart) {\n            var list = cart[key];\n            list.forEach(function (item1) {\n                for (var i = 0; i < localBag.length; i++) {\n                    if (Utils.isSameItemInCart(item1, localBag[i])) {\n                        localBag.splice(i--, 1);\n                    }\n                }\n            })\n        }\n    }\n});"],"file":"js/controllers/order-pay.e687efa6.js","sourceRoot":"/source/"}