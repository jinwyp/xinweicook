{"version":3,"sources":["app.min.933f7b64.js"],"names":["angular","module","constant","user","wrongMobile","wrongPassword","alreadyExist","notFound","userReferrerWrong","userIdWrong","userGenderWrong","userOldAddressWrong","invitationSendCodeWrong","addressIdWrong","addressNotFound","addressNotInUser","addressLatitudeWrong","addressLongitudeWrong","addressCoordTypeWrong","addressProvinceWrong","addressCityWrong","addressDistrictWrong","addressStreetWrong","addressStreetNumberWrong","addressAddressWrong","addressContactPersonWrong","addressMobileWrong","addressSortOrderWrong","addressNotDeliver","addressBaiduMapNotFoundError","addressBaiduMapQueryWrong","addressBaiduMapRegionWrong","shoppingCartNotArray","shoppingCartDishIdWrong","shoppingCartDishNumberWrong","shoppingCartSubDishIdWrong","shoppingCartSubDishNumberWrong","order","orderNumberWrong","orderIdWrong","warehouseIdWrong","cookingTypeWrong","clientFromWrong","creditWrong","freightWrong","paymentWrong","paymentUsedCashWrong","deliveryDateCookWrong","deliveryTimeCookWrong","deliveryDateEatWrong","deliveryTimeEatWrong","dishListArrayWrong","dishListDishNumberWrong","dishListDishIdWrong","dishListSubDishArrayWrong","dishListSubDishNumberWrong","dishListSubDishIdWrong","userCommentWrong","dishIdInvalid","notOnlyDrink","notOverTenDrinks","orderStatusWrong","orderPaymentStatusWrong","sms","wrongCode","expired","invalidCode","wrongType","tooManyTries","sendFailed","reachSendLimitation","dish","outOfStock","coupon","notStart","used","outOfCount","exchanged","couponIdWrong","promotionCodeWrong","announcement","announcementIdWrong","factory","$localStorage","$q","noRedirectPath","noRedirectAPI","loginRedirectPath","request","config","access_token","headers","Authorization","responseError","response","redirectPath","status","some","RE","test","location","pathname","indexOf","url","reject","path","setTimeout","replace","$httpProvider","$compileProvider","defaults","common","Accept","navigator","language","interceptors","push","debugInfoEnabled","pick","obj","keys","Array","prototype","slice","call","arguments","reduce","o","k","sort","_array","compare","tmp","array","l","length","i","result","filter","width","Math","floor","document","body","offsetWidth","window","devicePixelRatio","height","prefix","query","src","ratio","i2s","sval","scripts","ret","superscripts","subscripts","str","_","sup","sub","_id","number","subDish","map","el","mobile","m1","m2","m3","item","last","title","cur","zh","time","type","deliveryDateEat","hour","substr","deliveryTimeEat","deliveryDateCook","day","deliveryTimeCook","segment","name","eat","cook","extend","times","hasSegment","list","forEach","dishes","tType","sType","Object","key","sDish","dishList","code","promotionCode","card","unshift","total","price","priceOriginal","len","_status","not paid","paid","confirmed","dish finished","packaged","shipped","finished","canceled","orderId","join","_payment","alipay direct","weixinpay","account balance","payment","$http","getList","cookingType","get","like","id","put","getOne","postOrder","data","post","deliveryTime","deliveryEatTime","getOrder","updateOrder","cancel","isPaymentPaid","getUnifiedOrder","payByAlipay","cartDate","Date","now","timeSpan","timer","login","username","password","couponcode","args","grant_type","then","res","signup","pwd","referrer","opts","getSmsCode","logout","token_type_hint","token","getUserInfo","localStorage","uid","trackJs","configure","userId","updateUser","resetPwd","postCart","cart","clearTimeout","shoppingCart","this","bind","catch","noop","applyInvitationCode","invitedFriends","getWeixinUserInfo","addOne","address","update","delete","range","getCouponInfo","exchangeCouponCode","notify","isCharge","out_trade_no","Debug","balance","chargeByCode","accountChargeCode","chargeOnline","balanceRecords","promiseErrFn","run","$templateCache","wx","appId","jsApiList","longitude","latitude","ak","oauthUrl","isWeixin","userAgent","readyState","ready","cb","setting","that","_setting","copy","timestamp","nonceStr","signature","getLocation","success","fail","shareTimeline","settings","onMenuShareTimeline","shareAppMessage","onMenuShareAppMessage","showOptionMenu","hideOptionMenu","getLocationName","lat","lng","mapUrl","jsonp","params","getJsconfig","href","hash","codeMsg",1110,1111,1112,1113,2110,3110,3111,3112,3113,3114,3115,3116,4110,5110,5111,5112,5113,5121,"show","def","msg","alert","message","provider","debugKey","$get","Utils","isDebug","RegExp","fakeWarehouse","searches","search","sessionStorage","getItem","setItem","fakewarehouse","val","console","log","toString","JSON","stringify","assert","express","topDistance","xinweioffice","caohejing1","bentoNoReach","suggestion","region","gcj02ToBd09","y","x","z","sqrt","sin","PI","theta","atan2","cos","bd09ToGcj02","lineDistance","latA","lngA","latB","lngB","earthR","s","alpha","acos","lineDistance2CHJ","CHJ","warehouseCoords","fixZero","d","lineD","walkingDistance","warehouse","isArray","arg","encodeURIComponent","pair","results","elements","a","b","distance","value","top","isInRange","distances","dests","nearestWarehouse","topDistance2HQ","topDistance2CHJ","warehouses","$location","scope","back","history","nav","$on","utf2b64","btoa","unescape","b642utf","decodeURIComponent","escape","atob","isSameItemInCart","item1","item2","every","mergeCarts","local","server","notInLocal","lDish","getStockId","idStockMap","preferences","p","foodMaterial","f","isPublished","cleanLocalStorage","remain","split","addressEqual","addr1","addr2","regularizeAddress","ref","cities","districts","equal","state","province","city","areas","district","addressOptions","addresses","stockOfDish","stockWarehouse","stock","stockOfItem","directive","User","$filter","localBag","templateUrl","link","$scope","storage","unwatcher","$watch","totalPrice","curSelection","property","stockWarehouseObj","addToCart","entry","selection","newEntry","count","hide","postDishFilter","Alert","restrict","watchAddress","editing","hideOthersWhenEdit","newAddress","handler","save","leave","valid","hideAddress","idx","editIdx","edit","addr","remove","splice","event","target","parent","className","addressNodes","parentElement","children","curIdx","promise","stopPropagation","validationStatus","resolve","animateTrigger","noAddress","dishId","$timeout","Address","Weixin","Map","outAddress","deleteHook","css","showSearchAddress","form","locating","isNewAddress","street","sortOrder","options","choose","trySelectUnique","deleteAddress","streetList","searchAddress","confirmStreet","geoLatitude","geoLongitude","$invalid","isDefault","$submitted","initForm","showFakeInput","locate","addressComponent","focus","template","$parse","$rootScope","compile","$element","attr","fn","captureClick","element","addEventListener","callback","$event","$$phase","$evalAsync","$apply","transclude","deferred","defer","showModal","confirm","close","preClose","Coupon","couponPrice","couponCodeType","require","attrs","ngModel","$asyncValidators","couponCode","mValue","vValue","startDate","endDate","couponType","error","duration","newVal","addClass","removeClass","$interval","$window","triggered","stateMachine","action","isValid","createElement","gt","challenge","fatherDom","getElementById","append","gt_custom_ajax","find","geetest_challenge","geetest_validate","geetest_seccode","remains","GeeTest","refresh","e","showGeetest","$document","getDOMTop","elem","offsetTop","offsetParent","getWindowBottom","documentElement","clientHeight","scrollY","scrollTop","windowBottom","lazyDOMs","ok","on","$eval","dom","imgLazyLoad","_lazyDestroyBinded","isAddressOk","goToCart","toggle","setStatus","undefined","ignorePreClose","watchMobile"],"mappings":"AAAAA,QAAQC,OAAO,MAAO,YAAa,cAAe,iBAAkB,gBAAiB,eAErFD,QAAQC,OAAO,aAAc,cAE7BD,QAAQC,OAAO,aAAc,cAE7BD,QAAQC,OAAO,kBAAmB,YAAa,cAE/CD,QAAQC,OAAO,iBAAkB,cAEjCD,QAAQC,OAAO,iBAEfD,QAAQC,OAAO,gBAEfD,QAAQC,OAAO,kBAEfD,QAAQC,OAAO,aAAaC,SAAS,UAAW,WAChD,OACIC,MAEIC,YAAgB,KAChBC,cAAgB,KAChBC,aAAgB,KAChBC,SAAgB,KAEhBC,kBAAoB,KAEpBC,YAAc,KACdC,gBAAkB,KAClBC,oBAAsB,KAEtBC,wBAA0B,KAE1BC,eAAiB,KACjBC,gBAAkB,KAClBC,iBAAmB,KAEnBC,qBAAwB,KACxBC,sBAAwB,KACxBC,sBAAwB,KAExBC,qBAA2B,KAC3BC,iBAA2B,KAC3BC,qBAA2B,KAC3BC,mBAA2B,KAC3BC,yBAA2B,KAC3BC,oBAA2B,KAE3BC,0BAA4B,KAC5BC,mBAA4B,KAC5BC,sBAA4B,KAE5BC,kBAAwB,KAExBC,6BAAmC,KACnCC,0BAAgC,KAChCC,2BAAiC,KAGjCC,qBAA2B,KAC3BC,wBAA8B,KAC9BC,4BAAkC,KAClCC,2BAAiC,KACjCC,+BAAqC,MAOzCC,OACI9B,SAAU,KAEV+B,iBAAkB,KAClBC,aAAc,KACdC,iBAAkB,KAElBC,iBAAkB,KAClBC,gBAAiB,KAEjBC,YAAa,KACbC,aAAc,KACdC,aAAc,KACdC,qBAAsB,KAEtBC,sBAAuB,KACvBC,sBAAuB,KACvBC,qBAAsB,KACtBC,qBAAsB,KAEtBC,mBAAoB,KACpBC,wBAAyB,KACzBC,oBAAqB,KACrBC,0BAA2B,KAC3BC,2BAA4B,KAC5BC,uBAAwB,KAGxBxC,qBAAwB,KACxBC,sBAAwB,KAExBE,qBAA2B,KAC3BC,iBAA2B,KAC3BC,qBAA2B,KAC3BC,mBAA2B,KAC3BC,yBAA2B,KAC3BC,oBAA2B,KAE3BC,0BAA4B,KAC5BC,mBAA4B,KAE5Bb,eAAiB,KAEjB4C,iBAAkB,KAElBC,cAAe,KACfC,aAAc,KACdC,iBAAkB,KAGlBC,iBAAkB,KAClBC,wBAAyB,MAM7BC,KACIC,UAAW,KACXC,QAAS,KACTC,YAAa,KACbC,UAAW,KACXC,aAAc,KACdC,WAAY,KACZC,oBAAqB,MAEzBC,MACIC,WAAY,MAEhBC,QAEIC,SAAU,KACVT,QAAS,KACTU,KAAM,KACNC,WAAY,KACZrE,SAAgB,KAChBsE,UAAW,KAEXC,cAAgB,KAChBC,mBAAqB,MAGzBC,cACIC,oBAAsB,KACtB1E,SAAU,SAIlBP,QAAQC,OAAO,aAAaiF,QAAQ,qBAAsB,gBAAiB,KAAM,SAASC,EAAeC,GACrG,GAAIC,IAAkB,eAAgB,mBAAoB,kBAAmB,wBACzEC,GAAiB,YAAa,kBAAmB,yBAA0B,qBAC3EC,GAAqB,aAAc,sBAAuB,uBAAwB,oBAClF,iBAAkB,kBAAmB,eAAgB,kBAAmB,8BACxE,sBAEJ,QACIC,QAAW,SAASC,GAKhB,MAJIN,GAAcO,eACdD,EAAOE,QAAQC,cAAgB,UAAYT,EAAcO,cAGtDD,GAGXI,cAAiB,SAASC,GAEtB,GAAIC,GAAe,EACnB,IAAuB,KAAnBD,EAASE,OAAe,CAExB,GAAIX,EAAeY,KAAK,SAAUC,GAAK,MAAOA,GAAGC,KAAKC,SAASC,aACT,IAA9Cf,EAAcgB,QAAQR,EAASL,OAAOc,KACtC,MAAOnB,GAAGoB,OAAOV,EAGrBP,GAAkBU,KAAK,SAASQ,GAC5B,MAA0C,IAAnCL,SAASC,SAASC,QAAQG,OAErCV,EAAe,aAAeK,SAASC,UAE3CK,WAAW,WAEPN,SAASO,QAAQ,gBAAkBZ,IACpC,KAEP,MAAOX,GAAGoB,OAAOV,QAM7B9F,QAAQC,OAAO,aAAawF,QAAQ,gBAAiB,mBACjD,SAASmB,EAAeC,GAEpBD,EAAcE,SAASnB,QAAQoB,OAAOC,OAAS,+BAC/CJ,EAAcE,SAASnB,QAAQoB,OAAO,+BAAiC,0BACvEH,EAAcE,SAASnB,QAAQoB,OAAO,mBAA2C,SAAtBE,UAAUC,SAAsB,QAAU,QACrGN,EAAcE,SAASnB,QAAQoB,OAAO,gBAAkB,mBAExDH,EAAcO,aAAaC,KAAK,qBAGhCP,EAAiBQ,kBAAiB,MAK1CrH,QAAQsH,KAAO,SAAUC,GACrB,GAAIC,GAAOC,MAAMC,UAAUC,MAAMC,KAAKC,UAAW,EACjD,OAAOL,GAAKM,OAAO,SAAUC,EAAGC,GAE5B,MADAD,GAAEC,GAAKT,EAAIS,GACJD,QAIf/H,QAAQiI,KAAO,SAAeC,EAAQC,GAGlC,IAAK,GADDC,GADAC,EAAQH,EAAOP,MAAM,GAEhBW,EAAID,EAAME,OAAS,EAAGD,GAAK,EAAGA,IACnC,IAAK,GAAIE,GAAI,EAAOF,EAAJE,EAAOA,IAAK,CACxB,GAAIC,GAASN,EAAQE,EAAMG,GAAIH,EAAMG,EAAI,GACrCC,GAAS,IACTL,EAAMC,EAAMG,GACZH,EAAMG,GAAKH,EAAMG,EAAI,GACrBH,EAAMG,EAAI,GAAKJ,GAI3B,MAAOC,IAMXrI,QAAQC,OAAO,cAAcyI,OAAO,QAAS,WACzC,GAAIC,GAAQC,KAAKC,MAAMC,SAASC,KAAKC,YAAcC,OAAOC,kBACtDC,EAASP,KAAKC,MAAc,EAARF,EAAY,GAChCS,EAAS,mBACTC,EAAQD,EAAST,EAAQ,MAAQQ,CACrC,OAAO,UAAUG,EAAKC,GAClB,MAAOD,IAAOC,EACNH,EAAST,EAAQ,MAAQC,KAAKC,MAAMF,EAAQY,GAC5CF,MAOhBrJ,QAAQC,OAAO,cAAcyI,OAAO,WAAY,WAK5C,QAASc,GAAIC,EAAMC,GAEf,IAAK,GADDC,GAAM,GACDnB,EAAI,EAAGA,EAAIiB,EAAKlB,OAAQC,IAC7BmB,GAAOD,EAAQD,EAAKjB,GAExB,OAAOmB,GATX,GAAIC,IAAgB,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAC7DC,GAAc,IAAU,IAAU,IAAU,IAAU,IACtD,IAAU,IAAU,IAAU,IAAU,IAU5C,OAAO,UAAUC,GACb,MAAOA,GAAInD,QAAQ,gBAAiB,SAAUoD,EAAGC,EAAKC,GAClD,MAAOT,GAAIQ,EAAKJ,GAAgB,IAAMJ,EAAIS,EAAKJ,GAAc,SAQzE7J,QAAQC,OAAO,cAAcyI,OAAO,WAAY,WAC5C,MAAO,UAAUnE,GACb,OACIA,KAAMA,EAAKA,KAAK2F,IAChBC,OAAQ5F,EAAK4F,OACbC,QAAU7F,EAAK6F,QAAe7F,EAAK6F,QAAQC,IAAI,SAAUC,GACrD,OACI/F,KAAM+F,EAAG/F,KAAK2F,IACdC,OAAQG,EAAGH,iBAU/BnK,QAAQC,OAAO,cAAcyI,OAAO,iBAAkB,WAClD,MAAO,UAAU6B,GACb,MAAK,WAAWpE,KAAKoE,GACdA,EAAO5D,QAAQ,0BAClB,SAAUoD,EAAGS,EAAIC,EAAIC,GACjB,MAAOF,GAAK,IAAMC,EAAK,IAAMC,IAHAH,KAW7CvK,QAAQC,OAAO,cAAcyI,OAAO,eAAgB,WAChD,MAAO,UAAUiC,GACb,GAAIC,GAAOD,EAAKP,QAAQ7B,MACxB,OAAKqC,GACE,IAAMD,EAAKP,QAAQtC,OAAO,SAAU+C,EAAOC,EAAKtC,GACnD,MAAOqC,GAAQC,EAAIvG,KAAKsG,MAAME,IAAMvC,GAAKoC,EAAO,EAAI,GAAK,MAC1D,IAAM,IAHS,MAa1B5K,QAAQC,OAAO,cAAcyI,OAAO,YAAa,WAC7C,MAAO,SAASA,GAAOsC,EAAMC,GACzB,GAAItB,EACJ,OAAY,OAARsB,GAEIC,gBAAiBF,EAAKG,KAAKC,OAAO,EAAG,IACrCC,gBAAiBL,EAAKG,KAAKC,OAAO,GAAI,IAE3B,QAARH,GACPtB,GAAO2B,iBAAkBN,EAAKO,KAC9B5B,EAAI6B,iBAAmBR,EAAKS,QAAUT,EAAKS,QAAQC,KAAK,MAAQ,QACzD/B,GACQ,OAARsB,GACPtB,KACIqB,EAAKW,MAAKhC,EAAMjB,EAAOsC,EAAKW,IAAK,QACjCX,EAAKY,MAAM5L,QAAQ6L,OAAOlC,EAAKjB,EAAOsC,EAAKY,KAAM,SAC9CjC,GAJJ,UASf3J,QAAQC,OAAO,cAAcyI,OAAO,gBAAiB,WACjD,MAAO,UAAUoD,GACb,IAAKA,EACD,MAAOA,EAGX,IAAIC,KAAeD,EAAM,GAAGL,OAE5B,OAAOK,GAAMhE,OAAO,SAAUkE,EAAMlB,GAWhC,MAVIiB,GACAjB,EAAIW,QAAQQ,QAAQ,SAAUtB,GAC1BqB,EAAK5E,MACDmE,IAAKT,EAAIS,IACTE,QAASd,MAIjBqB,EAAK5E,MAAMmE,IAAKT,EAAIS,MAEjBS,UA2BnBhM,QAAQC,OAAO,cAAcyI,OAAO,SAAU,WAC1C,MAAO,UAAUwD,EAAQC,EAAOC,GAC5B,GAAIzC,EAEJ,OAAa,SAATwC,GAA6B,eAATC,GACpBzC,KACA0C,OAAO7E,KAAK0E,GAAQD,QAAQ,SAAUK,GAClCJ,EAAOI,GAAKL,QAAQ,SAAU3B,GAC1BX,EAAIvC,MACA7C,KAAM+F,EAAG/F,KAAK2F,IACdC,OAAQG,EAAGH,OACXC,QAASE,EAAGF,QAAQC,IAAI,SAAUkC,GAC9B,OACIhI,KAAMgI,EAAMhI,KAAK2F,IACjBC,OAAQoC,EAAMpC,iBAO1BqC,SAAU7C,IACRuC,KAOtBlM,QAAQC,OAAO,cAAcyI,OAAO,SAAU,WAC1C,MAAO,UAAUjE,GACb,GAAIkF,KAWJ,OAVIlF,GAAOgI,OACP9C,EAAI+C,cAAgBjI,EAAOgI,KACD,GAAtBhI,EAAOgI,KAAKlE,SAEZoB,EAAI+C,cAAgB,KAAO/C,EAAI+C,gBAGnCjI,EAAOkI,OACPhD,EAAIlF,OAASA,EAAOkI,KAAKzC,KAEtBP,KAOf3J,QAAQC,OAAO,cAAcyI,OAAO,iBAAkB,WAClD,MAAO,UAAUoD,GACb,MAAKA,IAAUA,EAAMvD,QACrBuD,EAAMc,SAASzB,KAAM,YACdW,GAF6BA,KAM5C9L,QAAQC,OAAO,cAAcyI,OAAO,iBAAkB,WAClD,MAAO,UAAUsC,GACb,MAAOA,GAAKG,QAIpBnL,QAAQC,OAAO,cAAcyI,OAAO,kBAAmB,WACnD,MAAO,UAAUoD,GACb,MAAKA,IAAUA,EAAMvD,QACrBuD,EAAMc,SAASrB,IAAK,YACbO,GAF6BA,KAM5C9L,QAAQC,OAAO,cAAcyI,OAAO,kBAAmB,WACnD,MAAO,UAAUsC,GACb,MAAmB,WAAZA,EAAKO,KAAoBP,EAAKS,QACjCT,EAAKO,IAAMP,EAAKO,IAAM,SAKlCvL,QAAQC,OAAO,cAAcyI,OAAO,YAAa,WAC7C,MAAO,UAAUiC,EAAMkC,GACnB,GAAIC,GAAQnC,EAAKpG,KAAKwI,aACtB,IAAIpC,EAAKP,QACL,IAAK,GAAI5B,GAAI,EAAGwE,EAAMrC,EAAKP,QAAQ7B,OAAYyE,EAAJxE,EAASA,IAChDsE,GAASnC,EAAKP,QAAQ5B,GAAGjE,KAAKwI,aAGtC,OAAOD,IAASD,EAAQlC,EAAKR,OAAS,MAM9CnK,QAAQC,OAAO,cAAcyI,OAAO,cAAe,WAC/C,GAAIuE,IACAC,WAAY,MACZC,KAAQ,MACRC,UAAa,MACbC,gBAAiB,MACjBC,SAAY,MACZC,QAAS,MACTC,SAAU,MACVC,SAAU,MAGd,OAAO,UAASzH,GACZ,MAAOiH,GAAQjH,IAAW,MAKlChG,QAAQC,OAAO,cAAcyI,OAAO,UAAW,WAC3C,MAAO,UAASgF,GACZ,IAAKA,EAAS,MAAOA,EAErB,KAAK,GADD/D,MACKnB,EAAI,EAAGA,EAAIkF,EAAQnF,OAAQC,GAAG,EACnCmB,EAAIvC,KAAKsG,EAAQtC,OAAO5C,EAAG,GAE/B,OAAOmB,GAAIgE,KAAK,QAKxB3N,QAAQC,OAAO,cAAcyI,OAAO,UAAW,WAC3C,GAAIkF,IACAC,gBAAiB,MACjBC,UAAY,OACZC,kBAAmB,MAEvB,OAAO,UAASC,GACZ,MAAOJ,GAASI,IAAYA,KAKpChO,QAAQC,OAAO,aAAaiF,QAAQ,UAAW,QAAS,SAAU+I,GAE9D,OACIC,QAAS,SAAUC,GAEf,MADAA,GAAcA,GAAe,GACtBF,EAAMG,IACT,2BACiBD,IAGzBE,KAAM,SAAUC,GACZ,MAAOL,GAAMM,IAAI,eAAiBD,EAAK,UAE3CE,OAAQ,SAAUF,GACd,MAAOL,GAAMG,IAAI,eAAiBE,QAK9CtO,QAAQC,OAAO,aAAaiF,QAAQ,UAAW,QAAS,SAAU+I,GAC9D,OACIQ,UAAW,SAAUC,GACjB,MAAOT,GAAMU,KAAK,cAAeD,IAErCE,aAAc,SAAUF,GACpB,MAAOT,GAAMU,KAAK,4BAA6BD,IAEnDG,gBAAiB,SAAUH,GACvB,MAAOT,GAAMU,KAAK,0CAA2CD,IAEjEI,SAAU,SAAUpB,GAChB,MAAOO,GAAMG,IAAI,eAAiBV,IAEtCqB,YAAa,SAAUT,EAAII,GACvB,MAAOT,GAAMM,IAAI,eAAiBD,EAAII,IAE1CM,OAAQ,SAAUV,GACd,MAAOL,GAAMM,IAAI,eAAiBD,GAC9BW,cAAe,QACfjJ,OAAQ,cAGhBkI,QAAS,WACL,MAAOD,GAAMG,IAAI,gBAErBc,gBAAiB,SAAUR,GACvB,MAAOT,GAAMU,KAAK,6CAA8CD,IAEpE5B,MAAO,SAAU4B,GACb,MAAOT,GAAMU,KAAK,kBAAmBD,IAEzCS,YAAa,SAAUb,GACnB,MAAOL,GAAMU,KAAK,mCAAoCzE,IAAKoE,SAKvEtO,QAAQC,OAAO,aAAaiF,QAAQ,QAAS,QAAS,gBAAiB,SAAU+I,EAAO9I,GAGpF,GAAIiK,GAAWC,KAAKC,MAChBC,EAAW,IACXC,EAAQ,IAEZ,QACIC,MAAO,SAAUC,EAAUC,EAAUC,GACjC,GAAIC,IACAH,SAAUA,EACVC,SAAUA,EACVG,WAAY,WAGhB,OADIF,KAAYC,EAAKD,WAAaA,GAC3B3B,EAAMU,KAAK,kBAAmBkB,GAAME,KAAK,SAAUC,GAKtD,MAJIA,GAAItB,MAAQsB,EAAItB,KAAKhJ,eACrBP,EAAcO,aAAesK,EAAItB,KAAKhJ,cAGnCsK,KAGfC,OAAQ,SAAU1F,EAAQ2F,EAAKzD,EAAMmD,EAAYO,GAC7C,GAAIC,IACA7F,OAAQA,EACR2F,IAAKA,EACLzD,KAAMA,EACN0D,SAAUA,GAAY,GAK1B,OAHIP,KACAQ,EAAKR,WAAaA,GAEf3B,EAAMU,KAAK,mBAAoByB,GAAML,KAAK,SAAUC,GAKvD,MAJIA,GAAItB,MAAQsB,EAAItB,KAAKhJ,eACrBP,EAAcO,aAAesK,EAAItB,KAAKhJ,cAGnCsK,KAGfK,WAAY,SAAU3B,GAClB,MAAOT,GAAMU,KAAK,gBAAiBD,IAEvC4B,OAAQ,WACJ,MAAOrC,GAAMU,KAAK,oBACd4B,gBAAiB,eACjBC,MAAOrL,EAAcO,gBAG7B+K,YAAa,WACT,MAAOxC,GAAMG,IAAI,aAAa2B,KAAK,SAAUC,GAGzC,MAFAU,cAAaC,IAAMX,EAAItB,KAAKxE,IAC5BjB,OAAO2H,QAAQC,WAAYC,OAAQd,EAAItB,KAAKxE,MACrC8F,KAGfe,WAAY,SAAUrC,GAClB,MAAOT,GAAMM,IAAI,YAAaG,IAElCsC,SAAU,SAAUzG,EAAQ2F,EAAKzD,GAC7B,MAAOwB,GAAMU,KAAK,2BACdpE,OAAQA,EACR2F,IAAKA,EACLzD,KAAMA,KAGdwE,SAAU,SAAUC,GAChB,GAAI5B,GAAMD,KAAKC,KACf,OAAIA,GAAMF,EAAWG,GACjB4B,aAAa3B,GACNvB,EAAMU,KAAK,0BAA2ByC,aAAcF,MAE3DC,aAAa3B,GACbA,EAAQ9I,WAAW2K,KAAKJ,SAASK,KAAKD,KAAMH,GAAO3B,EAAW,KAElEH,EAAWE,GACHiC,QAASvR,QAAQwR,QAE7BC,oBAAqB,SAAUhF,GAC3B,MAAOwB,GAAMG,IAAI,+BAAiC3B,IAEtDiF,eAAgB,WACZ,MAAOzD,GAAMG,IAAI,6BAGrBuD,kBAAmB,SAAUrD,GACzB,MAAOL,GAAMG,IAAI,oCAAsCE,QAMnEtO,QAAQC,OAAO,aAAaiF,QAAQ,WAAY,QAAS,SAAU+I,GAC/D,OACIC,QAAS,WACL,MAAOD,GAAMG,IAAI,sBAErBwD,OAAQ,SAAUC,GACd,MAAO5D,GAAMU,KAAK,oBAAoBkD,IAE1CC,OAAQ,SAAUD,GACd,MAAO5D,GAAMM,IAAI,qBAA4BsD,EAAQ3H,IAAK2H,IAE9DE,SAAU,SAAUzD,GAChB,MAAOL,GAAAA,UAAa,qBAAuBK,IAE/C0D,MAAO,WACH,MAAO/D,GAAMG,IAAI,mCAK7BpO,QAAQC,OAAO,aAAaiF,QAAQ,UAAW,QAAS,SAAU+I,GAC9D,OACIgE,cAAe,SAAUxF,GACrB,MAAOwB,GAAMG,IAAI,qBAAuB3B,IAE5CyF,mBAAoB,SAAUzF,GAC1B,MAAOwB,GAAMG,IAAI,yBAA2B3B,QAKxDzM,QAAQC,OAAO,aAAaiF,QAAQ,UAAW,QAAS,SAAU+I,GAC9D,OACIkE,OAAQ,SAAU7D,EAAI8D,GAClB,GAAI7L,GAAM6L,EAAW,4CACf,mCACN,OAAOnE,GAAMU,KAAKpI,GAAM8L,aAAc/D,SAKlDtO,QAAQC,OAAO,aAAaiF,QAAQ,WAAY,QAAS,QAAS,SAAU+I,EAAOqE,GAC/E,OACIC,QAAS,WACL,MAAOtE,GAAMG,IAAI,sBAErBoE,aAAc,SAAU/F,GACpB,MAAOwB,GAAMU,KAAK,gCAAiC8D,kBAAmBhG,KAE1EiG,aAAc,SAAUhE,GACpB,MAAOT,GAAMU,KAAK,4BAA6BD,IAEnDiE,eAAgB,WACZ,MAAO1E,GAAMG,IAAI,8CAAVH,SACIqE,EAAMM,aAAa,kBAK1C5S,QAAQC,OAAO,iBAAiB4S,KAAK,iBAAkB,SAASC,GAAiBA,EAAevE,IAAI,oBAAoB,wtCACxHuE,EAAevE,IAAI,oBAAoB,wmBACvCuE,EAAevE,IAAI,yBAAyB,ynBAC5CuE,EAAevE,IAAI,eAAe,mkHAClCuE,EAAevE,IAAI,eAAe,2PAClCuE,EAAevE,IAAI,eAAe,wHAClCuE,EAAevE,IAAI,0BAA0B,wcAC7CuE,EAAevE,IAAI,gBAAgB,usBACnCuE,EAAevE,IAAI,aAAa,uKAChCuE,EAAevE,IAAI,6BAA6B,iXAChDuE,EAAevE,IAAI,kBAAkB,mXACrCuE,EAAevE,IAAI,oBAAoB,uJACvCvO,QAAQC,OAAO,aAAaiF,QAAQ,UAAU,QAAS,QAAS,SAAU+I,EAAOqE,GAE7E,GAAIxL,IAEAiM,IACIC,MAAO,qBACPC,WAAY,cAAe,sBAAuB,0BAItD7M,UACI8M,UAAW,WACXC,SAAU,WAGdC,GAAI,2BAEJC,SAAU,mDAGd,QACIC,SAAU,kBAAkBnN,KAAKc,UAAUsM,WAE3CF,SAAUvM,EAASuM,SAEnBG,YAAY,EAGZC,MAAO,SAAUC,GACTrC,KAAKmC,WACLE,IACGrC,KAAKoC,MAAMC,GAAKA,GAM3BjO,OAAQ,SAAUkO,GACd,GAAIC,GAAOvC,KACPwC,EAAW7T,QAAQ8T,KAAKhN,EAASiM,GACrCc,GAASE,UAAYJ,EAAQI,UAC7BF,EAASG,SAAWL,EAAQK,SAC5BH,EAASI,UAAYN,EAAQM,UAE7BlB,GAAGtN,OAAOoO,GAEVd,GAAGU,MAAM,WACLG,EAAKH,MAAMC,IAAME,EAAKH,MAAMC,KAC5BE,EAAKJ,YAAa,KAO1BU,YAAa,SAASC,EAASC,GAC3B,GAAIT,IAAW1I,KAAM,QACrBkJ,KAAYR,EAAQQ,QAAUA,GAC9BC,IAAST,EAAQS,KAAOA,GACxBrB,GAAGmB,YAAYP,IAOnBU,cAAe,SAAUC,GACrBvB,GAAGwB,oBAAoBD,IAG3BE,gBAAiB,SAAUF,GACvBvB,GAAG0B,sBAAsBH,IAG7BI,eAAgB,WACZ3B,GAAG2B,kBAGPC,eAAgB,WACZ5B,GAAG4B,kBASPC,gBAAiB,SAAUC,EAAKC,GAC5B,GAAIC,GAAS,mGACb,OAAO9G,GAAM+G,MAAMD,GACfE,QACI7B,GAAItM,EAASsM,GACbhN,SAAUyO,EAAM,IAAMC,MASlCI,YAAa,WACT,MAAOjH,GAAMU,KAAK,wCACdpI,IAAKH,SAAS+O,KAAK/J,OAAO,EAAGhF,SAAS+O,KAAK5M,OAASnC,SAASgP,KAAK7M,eAKlFvI,QAAQC,OAAO,eAAeiF,QAAQ,QAAS,WAC3C,GAAImQ,IACAC,KAAM,YACNC,KAAM,YACNC,KAAM,SACNC,KAAM,YAENC,KAAM,SAENC,KAAM,QACNC,KAAM,SACNC,KAAM,SACNC,KAAM,WACNC,KAAM,sBACNC,KAAM,cACNC,KAAM,kBAENC,KAAM,OAENC,KAAM,aACNC,KAAM,aACNC,KAAM,cACNC,KAAM,kBACNC,KAAM,sCAGV,QACIC,KAAM,SAAU/J,EAAMgK,GAClB,GAAIC,GAAMrB,EAAQ5I,EACdiK,GAAKC,MAAMD,GACND,GAAKE,MAAMF,IAExBG,QAAS,SAAUnK,GACf,MAAO4I,GAAQ5I,IAAS,OAKpCzM,QAAQC,OAAO,eAAe4W,SAAS,QAAS,WAC5C,GAAIjD,GAAOvC,IACXuC,GAAKkD,SAAW,QAEhBzF,KAAK0F,MAAQ,QAAS,SAAUC,GAC5B,GAAIC,GAAU,GAAIC,QAAO,MAAQtD,EAAKkD,SAAW,OAC7CK,EAAgB,GAChBC,EAAWJ,EAAMI,SAAShR,SAASiR,OACvCJ,GAAUA,EAAQ9Q,KAAKC,SAASiR,WAAaC,eAAeC,QAAQ,SAEhEN,IAAYK,eAAeC,QAAQ,UACnCD,eAAeE,QAAQ,QAAS,QAEhCP,GACI,iBAAmBG,KACnBD,EAAgBC,EAASK,cAIjC,IAAI9N,IAEAsN,QAASA,EACTN,MAAO,SAAUe,GACTrG,KAAK4F,UACLU,QAAQC,IAAIF,GACZA,EAA6C,mBAAvCrL,OAAO3E,UAAUmQ,SAASjQ,KAAK8P,GAC/BI,KAAKC,UAAUL,GAAOA,EAC5Bf,MAAMe,KAGdM,OAAQ,SAAUC,EAASxO,GACnB4H,KAAK4F,UACJgB,GAAWtB,MAAMlN,IAG1BmJ,aAAc,SAAU8D,GACpB,MAAO,UAAS1G,GACZrG,EAAIgN,MAAMD,GACV/M,EAAIgN,MAAM3G,KAGlBmH,cAAeA,EAGnB,OAAOxN,OAGf3J,QAAQC,OAAO,eAAeiF,QAAQ,OAAQ,QAAS,QAAS,SAAU+I,EAAOqE,GAE7E,GAAI4F,IACAC,aAAc,IACdC,WAAY,MAGZ/N,GACAgO,aAAc,OAEdH,aACIC,aAAc,IACdC,WAAY,MAGhBE,WAAY,SAAUjP,EAAOkP,GACzB,MAAOtK,GAAMG,IAAI,iCAAmC/E,EAAQ,WAAakP,IAG7ElB,OAAQ,SAAUhO,EAAOkP,GACrB,MAAOtK,GAAMU,KAAK,gCAAiCtF,MAAMA,EAAOkP,OAAOA,KAK3EC,YAAa,SAAUpS,GACnB,GAAIqS,GAAIrS,EAASyO,IACb6D,EAAItS,EAAS0O,IACb6D,EAAI/P,KAAKgQ,KAAKF,EAAIA,EAAID,EAAIA,GAAK,KAAU7P,KAAKiQ,IAAIJ,EAAI7P,KAAKkQ,IAC3DC,EAAQnQ,KAAKoQ,MAAMP,EAAGC,GAAK,KAAW9P,KAAKqQ,IAAIP,EAAI9P,KAAKkQ,GAE5D,QACIhE,IAAK6D,EAAI/P,KAAKqQ,IAAIF,GAAS,MAC3BlE,IAAK8D,EAAI/P,KAAKiQ,IAAIE,GAAS,OAKnCG,YAAa,SAAU9S,GACnB,GAAIqS,GAAIrS,EAASyO,IAAM,KACnB6D,EAAItS,EAAS0O,IAAM,MACnB6D,EAAI/P,KAAKgQ,KAAKF,EAAIA,EAAID,EAAIA,GAAK,KAAU7P,KAAKiQ,IAAIJ,EAAI7P,KAAKkQ,IAC3DC,EAAQnQ,KAAKoQ,MAAMP,EAAGC,GAAK,KAAW9P,KAAKqQ,IAAIP,EAAI9P,KAAKkQ,GAE5D,QACIhE,IAAK6D,EAAI/P,KAAKqQ,IAAIF,GAClBlE,IAAK8D,EAAI/P,KAAKiQ,IAAIE,KAM1BI,aAAc,SAAUC,EAAMC,EAAMC,EAAMC,GACtC,GAAIC,GAAS,OACTd,EAAI9P,KAAKqQ,IAAIG,EAAOxQ,KAAKkQ,GAAK,KAAOlQ,KAAKqQ,IAAIK,EAAO1Q,KAAKkQ,GAAK,KAAOlQ,KAAKqQ,KAAKI,EAAOE,GAAQ3Q,KAAKkQ,GAAK,KACzGL,EAAI7P,KAAKiQ,IAAIO,EAAOxQ,KAAKkQ,GAAK,KAAOlQ,KAAKiQ,IAAIS,EAAO1Q,KAAKkQ,GAAK,KAC/DW,EAAIf,EAAID,CACRgB,GAAI,IACJA,EAAI,GAEA,GAAJA,IACAA,EAAI,GAER,IAAIC,GAAQ9Q,KAAK+Q,KAAKF,EACtB,OAAOC,GAAQF,GAGnBI,iBAAkB,SAAU/E,EAAKC,GAC7B,GAAI+E,GAAMxI,KAAKyI,gBAAgB1B,UAC/B,OAAO/G,MAAK8H,aAAatE,EAAKC,EAAK+E,EAAIhF,IAAKgF,EAAI/E,MAGpDiF,QAAS,SAAUC,EAAGnF,EAAKC,GACvB,GAAU,IAANkF,EAAS,MAAOA,EACpB,IAAIC,GAAQ5I,KAAK8H,aAAatE,EAAKC,EAAK,UAAW,WACnD,OAAOmF,GAAQ,KAAO,OAASD,GAUnCE,gBAAiB,SAAUrF,EAAKC,EAAKqF,GACjC,GAAItK,EACJsK,GAAYA,GAAa,GACrB1S,MAAM2S,QAAQvS,UAAU,KACxBgI,EAAOhI,UAAU,GACjBsS,EAAYrF,GAEZjF,IAASgF,IAAKA,EAAKC,IAAKA,GAG5B,IAAIrL,GAAO,EAWX,OAVAoG,GAAK5D,QAAQ,SAAUoO,EAAK7R,GACxB,KAAIA,GAAK,GAAT,CACA,GAAIY,GAAc,GAALZ,EAAS,GAAK,GAEvBiB,IADc,gBAAP4Q,GACCjR,EAASiR,EAETjR,EAASiR,EAAIxF,IAAM,IAAMwF,EAAIvF,OAItC7G,EAAMG,IAAI,iCACbkM,mBAAmB7Q,GAAQ,cAAgB0Q,GAC9CpK,KAAK,SAAUC,GAKR,IAAK,GADDuK,GAHAC,EAAUxK,EAAItB,KAAKjG,OAAOgS,SAC1B9Q,KACAqD,EAAMwN,EAAQjS,OAAS,EAElBC,EAAI,EAAOwE,EAAJxE,EAASA,IACrBgS,EAAQhS,GAAG2R,UAAY,eACvBK,EAAQxN,EAAMxE,GAAG2R,UAAY,aAC7BI,GAAQC,EAAQhS,GAAIgS,EAAQxN,EAAMxE,IAClC+R,EAAOva,QAAQiI,KAAKsS,EAAM,SAAUG,EAAGC,GACnC,MAAQD,GAAEE,SAASC,MAAQ3C,EAAYC,cAClCwC,EAAEC,SAASC,MAAQ3C,EAAYE,cAExCzO,EAAIvC,KAAKmT,EAEb,OAAO5Q,KAjBRsE,SAmBA,WAEC,MADA0J,SAAQC,IAAI,4BAYxBgD,SAAU,SAAU/F,EAAKC,EAAKqF,GAC1B,MAAO9I,MAAK6I,gBAAgBrF,EAAKC,EAAKqF,GAAWpK,KAAK,SAAUC,GAC5D,GAAIgK,GAAIhK,EAAI,GAAG,GAAG4K,SAASC,KAC3Bb,GAAI3P,EAAI0P,QAAQC,EAAGnF,EAAKC,EACxB,IAAIgG,GAAM5C,EAAYlI,EAAI,GAAG,GAAGmK,UAChC,QACIS,SAAUZ,EAEVe,UAAwCD,IAAtB,OAANd,EAAa,OAASA,GAClCG,UAAWnK,EAAI,GAAG,GAAGmK,aARtB9I,SAUE,SAAUrB,GACfsC,EAAMqE,MAAM,YACZrE,EAAMqE,MAAM3G,MAIpBgL,UAAW,SAAUC,EAAOd,GAExB,MADAc,GAAQxT,MAAM2S,QAAQa,GAASA,GAASA,GACjC5J,KAAK6I,gBAAgBe,EAAOd,GAAWpK,KAAK,SAAUC,GACzD,MAAOA,GAAI3F,IAAI,SAAUC,EAAI9B,GACzB,GAAIwR,GAAI3P,EAAI0P,QAAQzP,EAAG,GAAGsQ,SAASC,MAAOI,EAAMzS,GAAGqM,IAAKoG,EAAMzS,GAAGsM,KAC7DgG,EAAM5C,EAAY5N,EAAG,GAAG6P,UAC5B,QACIS,SAAUZ,EACVe,UAAwCD,IAAtB,OAANd,EAAa,OAASA,GAClCG,UAAW7P,EAAG,GAAG6P,gBAMjCe,iBAAkB,SAAUrG,EAAKC,GAC7B,GAAIlB,GAAOvC,KACP8J,EAAiBjD,EAA0B,aAC3CkD,EAAkBlD,EAAwB,WAC1CmD,EAAarb,QAAQiI,MAAM,eAAgB,cAAcoC,IAAI,SAAUqB,GACvE,GAAIyO,GAAYvG,EAAKkG,gBAAgBpO,EACrC,QACIA,KAAMA,EACNkP,SAAUhH,EAAKuF,aAAatE,EAAKC,EAAKqF,EAAUtF,IAAKsF,EAAUrF,QAEnE,SAAU4F,EAAGC,GACb,MAAQD,GAAEE,SAAWO,EAAiB,MAASR,EAAEC,SAAWQ,IAGhE,OAAI9I,GAAM6E,cAAuB7E,EAAM6E,cAChCkE,EAAW,GAAG3P,MAIzBoO,iBACI3B,cACItD,IAAK,UACLC,IAAK,YAETsD,YACIvD,IAAK,SACLC,IAAK,aAKjB,OAAOzK,MAGXrK,QAAQC,OAAO,eAAeiF,QAAQ,kBAAmB,YAAa,SAAUoW,GAC5E,OACIvU,OAAQ,SAAUwU,GACTA,IACLA,EAAMC,KAAO,WACLC,QAAQlT,OAAS,EAAGkT,QAAQD,OAC3BpV,SAAS+O,KAAO,cAG7BuG,IAAK,SAAUH,GACNA,GACLA,EAAMI,IAAI,uBAAwB,WAC9BJ,EAAM9U,KAAO6U,EAAU7U,cAKvCzG,QAAQC,OAAO,eAAeiF,QAAQ,SAAU,gBAAiB,SAAUC,GACvE,OAGIyW,QAAS,SAAU9R,GACf,MAAO+R,MAAKC,SAASxB,mBAAmBxQ,KAAOnD,QAAQ,MAAO,KAAKA,QAAQ,MAAO,MAEtFoV,QAAS,SAAUjS,GACf,MAAOkS,oBAAmBC,OAAOhT,OAAOiT,KAAKpS,EAAInD,QAAQ,KAAM,KAAKA,QAAQ,KAAM,SAItFwV,iBAAkB,SAAUC,EAAOC,GAC/B,MAAOD,GAAM7X,KAAK2F,KAAOmS,EAAM9X,KAAK2F,KAChCkS,EAAMhS,QAAQkS,MAAM,SAAU5B,GAC1B,MAAO2B,GAAMjS,QAAQnE,KAAK,SAAU0U,GAChC,MAAOD,GAAEnW,KAAK2F,KAAOyQ,EAAEpW,KAAK2F,SAE9BkS,EAAMhS,QAAQ7B,QAAU8T,EAAMjS,QAAQ7B,QAKpDgU,WAAY,SAAUC,EAAOC,GACzB,IAAKD,IAAUA,EAAMjU,OAAQ,MAAOkU,EAEpC,KAAK,GADD7I,GAAOvC,KACF7I,EAAI,EAAGA,EAAIiU,EAAOlU,OAAQC,IAAK,CACpC,GAAIkU,GAAaF,EAAMF,MAAM,SAAUK,GACnC,OAAQ/I,EAAKuI,iBAAiBQ,EAAOF,EAAOjU,KAE5CkU,IACDF,EAAMpV,KAAKqV,EAAOjU,IAEzB,MAAOgU,IASXI,WAAY,SAAUpQ,EAAUvB,GAC5B,GAAI4R,KAmBJ,OAlBY,cAAR5R,EACAuB,EAASP,QAAQ,SAAU1H,GACvBA,EAAKuY,YAAY7Q,QAAQ,SAAU8Q,GAC/BA,EAAEC,aAAa/Q,QAAQ,SAAUgR,IACxBJ,EAAWI,EAAE1Y,KAAK2F,MAAQ+S,EAAE1Y,KAAK2Y,cAClCL,EAAWI,EAAE1Y,KAAK2F,MAAO,SAMzCsC,EAASP,QAAQ,SAAU1H,GAClBsY,EAAWtY,EAAK2F,MAAS3F,EAAKC,aAC/BqY,EAAWtY,EAAK2F,MAAO,KAK5BmC,OAAO7E,KAAKqV,IAMvBM,kBAAmB,WACf,GAAIC,IAAW,YAAa,eAAgB,kBAC5C/Q,QAAO7E,KAAKrC,GAAe8G,QAAQ,SAAUK,GACd,IAAvB8Q,EAAO9W,QAAQgG,IAAwB,KAAVA,EAAI,UAC1BnH,GAAcmH,MAUjC8K,SAAU,SAAUC,GAEhB,MADAA,GAASA,GAAUjR,SAASiR,OACrBA,EAAO1P,MAAM,GAAG0V,MAAM,KAAKvV,OAAO,SAAUP,EAAKuD,GAKpD,MAJIA,KACAA,EAAMA,EAAIuS,MAAM,KAChB9V,EAAIuD,EAAI,IAAMkR,mBAAmBlR,EAAI,IAAM,KAExCvD,QAUf+V,aAAc,SAAUC,EAAOC,GAG3B,MAFAD,GAAQA,GAAS,GACjBC,EAAQA,GAAS,GACZD,GAAUC,GACPD,EAAMjX,QAAQkX,KAAWA,EAAMlX,QAAQiX,IADlB,GASjCE,kBAAmB,SAAU5L,EAAS6L,GAClC,GAAIC,GAAQC,EACRC,EAAQxM,KAAKiM,YAwBjB,OAvBAI,GAAIzX,KAAK,SAAU6X,GACf,MAAID,GAAMhM,EAAQkM,SAAUD,EAAMA,QAC9BjM,EAAQkM,SAAWD,EAAMA,MACzBH,EAASG,EAAMH,QACR,GAHX,SAOJA,GAAUA,EAAO1X,KAAK,SAAU+X,GAC5B,MAAIH,GAAMhM,EAAQmM,KAAMA,EAAKA,OACzBnM,EAAQmM,KAAOA,EAAKA,KACpBJ,EAAYI,EAAKC,OACV,GAHX,SAOJL,GAAaA,EAAU3X,KAAK,SAAUiY,GAClC,MAAIL,GAAMhM,EAAQqM,SAAUA,IACxBrM,EAAQqM,SAAWA,GACZ,GAFX,SAMGrM,GAWXsM,eAAgB,SAAUC,EAAWL,EAAUC,GAC3C,GAAIhR,GAAMnF,UAAUU,MAEpB,IAAW,GAAPyE,EACA,MAAOoR,GAAU/T,IAAI,SAAUC,GAAK,MAAOA,GAAGwT,OAE3C,IAAW,GAAP9Q,EAAU,CACjB,IAAK+Q,EAAU,MAEf,OAAOK,GAAU1V,OAAO,SAAU4B,GAC9B,MAAOA,GAAGwT,OAASC,IACpB,GAAGJ,OAAOtT,IAAI,SAAUC,GACnB,MAAOA,GAAG0T,OAGf,GAAW,GAAPhR,EAAU,CACjB,IAAKgR,EAAM,MACX,IAAIL,GAASS,EAAU1V,OAAO,SAAS4B,GACnC,MAAOA,GAAGwT,OAASC,IACpB,GAAGJ,OAAOjV,OAAO,SAAU4B,GACtB,MAAOA,GAAG0T,MAAQA,GAE1B,IAAIL,GAAUA,EAAOpV,OACjB,MAAOoV,GAAO,GAAGM,QAK7BI,YAAa,SAAU9Z,EAAM4V,GACzB,MAAO5V,GAAK+Z,eAAerY,KAAK,SAAU0E,GACtC,MAAOA,GAAKwP,WAAaA,GAAaxP,EAAK4T,MAAQ,KAS3DC,YAAa,SAAU7T,EAAMwP,GACzB,GAAIkE,GAAchN,KAAKgN,WACvB,OAAOA,GAAY1T,EAAKpG,KAAM4V,MAAgBxP,EAAKP,SAAWO,EAAKP,QAAQkS,MAAM,SAAUhS,GACnF,MAAO+T,GAAY/T,EAAG/F,KAAM4V,UAKhDna,QAAQC,OAAO,iBAAiBwe,UAAU,cAAe,QAAS,OAAQ,gBAAiB,UAAW,QAAS,SAAUnM,EAAOoM,EAAMvZ,EAAewZ,EAAS3H,GAC1J,OACIuE,OACIhX,KAAM,IACNpE,KAAM,IACNye,SAAU,KAEdC,YAAa,oBACbC,KAAO,SAAUC,GACb,GAAIC,GAAUD,EAAOC,QAAU7Z,EAC3ByZ,EAAWG,EAAOH,YAElBK,EAAYF,EAAOG,OAAO,OAAQ,SAAU/e,GACxCA,IACA8e,IAEAF,EAAOH,SAAWA,EAAW5H,EAAMuF,WAAWqC,EACxCze,EAAKiR,aAAa1I,OAAO,SAAUiC,GACjC,QAASA,EAAKpG,QAEtBwa,EAAOI,eAIfJ,GAAOG,OAAO,OAAQ,SAAU3a,GAC5B,GAAIA,EAAM,CACN,GAAI6a,KACJL,GAAOxa,KAAKuY,YAAY7Q,QAAQ,SAAUoT,GACtCA,EAASrC,aAAa/Q,QAAQ,SAAU3B,GACpCA,EAAG9F,aAAe8F,EAAG/F,KAAK+a,kBAAkBN,EAAQ7E,WAAa,GAA4B,iBAAvB7P,EAAG/F,KAAK4J,eAElFkR,EAASrC,aAAa/W,KAAK,SAAUqE,GACjC,MAAKA,GAAG9F,YAGM,GAFV4a,EAAaC,EAAS3T,KAAKX,IAAMT,EAAG/F,MAC7B,OAOnBwa,EAAOxa,KAAK6a,aAAeA,KAOnCL,EAAOQ,UAAY,SAAUhb,GACzB,GAcIib,GAdAC,EAAYlb,EAAK6a,aACjBM,GACAnb,KAAMA,EACN4F,OAAQ5F,EAAKob,MACbvV,QAASiC,OAAO7E,KAAKiY,GAAWpV,IAAI,SAAUiC,GAC1C,OACI/H,KAAMkb,EAAUnT,GAChBnC,OAAQ5F,EAAKob,SASzBf,GAAS3Y,KAAK,SAAU0E,GACpB,MAAIqM,GAAMmF,iBAAiBxR,EAAM+U,IAC7BF,EAAQ7U,EACR6U,EAAMrV,QAAUuV,EAASvV,OACzBqV,EAAMpV,QAAQ6B,QAAQ,SAAUM,GAC5BA,EAAMpC,OAASqV,EAAMrV,UAElB,GANX,SAUCqV,GACDZ,EAASxX,KAAKsY,GAGlBnb,EAAKob,MAAQ,EAEbZ,EAAOa,OAEPlB,EAAKzN,SAAS2N,EAASlW,OAAO,SAASiC,GAAM,QAASA,EAAKpG,OAAO8F,IAAIwV,IAEtEd,EAAOI,aAGX,IAAIU,GAAiBlB,EAAQ,WAE7BI,GAAOI,WAAa,WAChB,GAAIpC,GAAI6B,EAASlW,OAAO,SAASiC,GAAM,QAASA,EAAKpG,OAAOuD,OAAO,QAASgF,GAAMD,EAAO/B,GAKrF,MAJA+B,IAAS/B,EAAIvG,KAAKwI,cAAgBjC,EAAIX,OAClCW,EAAIV,UACJyC,GAAS/B,EAAIV,QAAQtC,OAAOgF,EAAO,IAEhCD,GACR,EACH,OAAO+R,GAAS9R,MAAQiQ,GAG5BgC,EAAOI,aAEPJ,EAAOa,KAAO,WACVb,EAAOxa,KAAO,WAM9BvE,QAAQC,OAAO,iBAAiBwe,UAAU,eAAgB,KAAM,QAAS,SAAUrZ,EAAI0a,GACnF,OACIC,SAAU,IACVxE,OAEI6C,UAAW,IACXpM,MAAO,IACPgO,aAAc,QACdC,QAAS,IACTC,mBAAoB,KAExBrB,YAAa,oBACbC,KAAM,SAAUC,GACZ,GAAIrQ,GAAOqQ,EAAOrQ,MACdyR,eAIAC,EAAUrB,EAAOqB,SACjBC,QACAC,SACAC,SAGJxB,GAAOyB,YAAc,SAAUC,GAC3B,GAAiC,QAA7B1B,EAAOmB,oBAAgCnB,EAAOX,UAAW,CACzD,GAAIsC,GAAU,EAWd,OATI3B,GAAOrQ,KAAKyR,WAAWQ,OACvBD,EAAU,IAEH,IAAXA,GAAiB3B,EAAOX,UAAUnY,KAAK,SAAU2a,EAAMpY,GACnD,MAAIoY,GAAKD,MACLD,EAAUlY,GACH,GAFX,SAKc,IAAXkY,GAAiBD,GAAOC,IAIvC3B,EAAOkB,QAAU,WACb,MAAKlB,GAAOX,YACH1P,EAAKyR,WAAWQ,MAClB5B,EAAOX,UAAUnY,KAAK,SAAU2a,GAC/B,MAAOA,GAAKD,QAHU,GAOlC5B,EAAO8B,OAAS,SAAUJ,GACtB1B,EAAOX,UAAU0C,OAAOL,EAAK,GAC7BL,EAAQC,KAAKS,OAAOL,EAAK,GACzBL,EAAQE,MAAMQ,OAAOL,EAAK,GAC1BL,EAAQG,MAAMO,OAAOL,EAAK,IAO9B1B,EAAOiB,aAAe,SAAUe,GAC5B,GACqBjW,GADjBkW,EAASD,EAAMC,OACfC,EAASD,CAEb,GACI,IAAgD,IAA5CC,EAAOC,UAAU5a,QAAQ,gBAEzB,IAAK,GADD6a,GAAeF,EAAOG,cAAcC,SAC/B7Y,EAAI,EAAGwE,EAAMmU,EAAa5Y,OAAYyE,EAAJxE,EAASA,IAChD,GAAI2Y,EAAa3Y,IAAMyY,EAAQ,CAC3BnW,EAAMtC,CACN,aAIPyY,EAASA,EAAOG,cAGzB,IAAIV,GAAU,GACVY,EAAS,EAWb,IAVAvC,EAAOX,UAAUnS,QAAQ,SAAU4F,EAASrJ,GACpCqJ,EAAQ8O,OACRD,EAAUlY,GAEVqJ,EAAQ/G,MACRwW,EAAS9Y,OAKbsC,GAAOwW,GACNxW,GAAOiU,EAAOX,UAAU7V,QAAUmG,EAAKyR,WAAWrV,KADvD,CAKA,GAAIyW,EACJ,IAAe,IAAXb,EAAe,CACf,IAAIN,EAAQG,MAAMG,KAId,MAAOK,GAAMS,iBAHbD,GAAUnB,EAAQC,KAAKK,SAKxB,IAAIhS,EAAKyR,WAAWQ,KAAM,CAC7B,IAAIP,EAAQG,MAAMJ,aASd,MAAOY,GAAMS,iBARbD,GAAUnB,EAAQC,KAAKF,aAAapQ,KAAK,SAAU8B,GAG/C,MAFAkN,GAAOX,UAAUhX,KAAKyK,GACtBnD,EAAKyR,cACEtO,IAHDuO,SAID,SAAUpQ,GACf8P,EAAMtJ,KAAKxG,EAAItB,KAAK+S,iBAAkB,UAiBlD,MATc,IAAVH,GACAlB,EAAQE,MAAMgB,KACC,IAAXZ,IACAa,EAAUnc,EAAGsc,QAAQ3C,EAAOX,UAAUkD,MACnC5S,EAAKyR,WAAWrV,KACvBsV,EAAQE,MAAMH,aAIXoB,SAMvBvhB,QAAQC,OAAO,iBAAiBwe,UAAU,mBAAoB,WAC1D,OACIsB,SAAU,IACVxE,OACIoG,eAAgB,IAChBnL,KAAM,IACN3E,QAAS,IACT+P,UAAW,IACXC,OAAQ,IACRpb,KAAM,KAEVoY,YAAa,4BAGrB7e,QAAQC,OAAO,iBAAiBwe,UAAU,WAAY,WAAY,YAAa,UAAW,QAAS,KAAM,SAAU,MAAO,QAAS,SAAUqD,EAAUxG,EAAWyG,EAAS/K,EAAO5R,EAAI4c,EAAQC,EAAKnC,GAC/L,OACIC,SAAU,IACVxE,OAEI2G,WAAY,IACZlQ,MAAO,IAGPqO,KAAM,IACNC,MAAO,IACPC,MAAO,IAGP4B,WAAY,IACZvC,KAAM,IAGN9U,IAAK,KAET+T,YAAa,eACbC,KAAM,SAAUC,GACZ,GAAI6B,GAEAwB,EAAMrD,EAAOqD,KACbzB,MAAM,EACN7V,IAAmB,QAAdiU,EAAOjU,IACZuX,mBAAmB,EACnBC,KAAM,KACNC,UAAU;AACVjP,SAAU0O,EAAO1O,SACjBkP,aAAcnW,OAAO7E,KAAKuX,EAAOmD,YAAY3Z,OAAS,GAGtDmG,EAAOqQ,EAAOrQ,MACd+T,OAAQ,GAKRL,GAAII,cACJ5B,EAAO7B,EAAO6B,MAAQ8B,UAAW,GAC7BN,EAAItX,MACJsX,EAAIzB,MAAO,IAGfC,EAAO7B,EAAO6B,KAAO5J,EAAMyG,kBACvBzd,QAAQ8T,KAAKiL,EAAOmD,YAAanD,EAAO/M,OAGhD+M,EAAOmD,WAAWpX,IAAMsX,EAAItX,IAC5BiU,EAAOmD,WAAWvB,OAASyB,EAAIzB,KAE/B5B,EAAO4D,QAAU3L,EAAMmH,eAAe7M,KAAK,KAAMyN,EAAO/M,OAExD+M,EAAOpD,IAAI,uBAAwB,WAC/B,GAAKyG,EAAIzB,KAAT,CACA,GAAIla,GAAO6U,EAAU7U,MACrB2b,GAAIC,kBAA4B,mBAAR5b,KAG5BsY,EAAO6D,OAAS,WACRR,EAAItX,KACJsX,EAAIzB,MAAO,EACX5B,EAAOmD,WAAWvB,MAAO,IAEzByB,EAAItX,KAAM,EAENsX,EAAII,eACJJ,EAAIzB,MAAO,EACX5B,EAAOmD,WAAWvB,MAAO,IAGjC5B,EAAOmD,WAAWpX,KAAM,GAG5BiU,EAAO8D,gBAAkB,WACrB,GAAIlF,GAASoB,EAAO4D,QAAQ/B,EAAK7C,SACZ,IAAjBJ,EAAOpV,SACPqY,EAAK5C,KAAOL,EAAO,KAI3BoB,EAAO+D,cAAgB,SAAU/B,GAC7BA,EAAMS,kBAENO,EAAAA,UAAenB,EAAK1W,KAChB6U,EAAOoD,YACPpD,EAAOoD,cAIfpD,EAAOsD,kBAAoB,WACvB3T,EAAK+T,OAAS7B,EAAK6B,OACnBnH,EAAU7U,KAAK,kBACfsY,EAAOrQ,KAAKqU,aAAehE,EAAOrQ,KAAKqU,WAAWxa,OAAS,GAC3DwW,EAAOiE,iBAGXjE,EAAOiE,cAAgB,WACftU,EAAK+T,QACLR,EAAI5K,OAAO3I,EAAK+T,OAAQ7B,EAAK5C,MAAQ,MAChCjO,KAAK,SAAUC,GACZ+O,EAAOrQ,KAAKqU,WAAa/S,EAAItB,QAK7CqQ,EAAOkE,cAAgB,SAAUlC,EAAO0B,GACpC1B,EAAMS,kBAENlG,EAAU7U,KAAK,IACVgc,IAEL7B,EAAK6B,OAASA,EAAO5Q,QACrB+O,EAAKsC,YAAcT,EAAO5N,IAC1B+L,EAAKuC,aAAeV,EAAO3N,MAG/BiK,EAAOsB,KAAO,WACV,MAAI+B,GAAIE,KAAKc,SAAiBhe,EAAGsc,SAAQ,IAEzCU,EAAIzB,KAAOyB,EAAItX,KAAM,EACrBiU,EAAOmD,WAAWvB,KAAO5B,EAAOmD,WAAWpX,KAAM,EAEjD8V,EAAKyC,WAAY,EACVtB,EAASK,EAAII,aAA0B,SAAX,UAAqB5B,GACvD7Q,KAAK,SAAUC,GAIR,MAHA4Q,GAAO7B,EAAO6B,KAAO5Q,EAAItB,KACzBqQ,EAAOmD,WAAWpX,IAAMsX,EAAItX,KAAM,EAClC9K,QAAQ6L,OAAOkT,EAAOmD,WAAYlS,EAAItB,MAC/BsB,EAAItB,SAIvBqQ,EAAOuB,MAAQ,WACXvB,EAAOmD,WAAWpX,IAAMsX,EAAItX,KAAM,GAItCiU,EAAOwB,MAAQ,WAEX,MADA6B,GAAIE,KAAKgB,YAAa,GACdlB,EAAIE,KAAKc,UAGrBrE,EAAOwE,SAAW,SAAUjB,GACxBF,EAAIE,KAAOA,EACXF,EAAIoB,eAAiB5C,EAAK7C,UAI9BgB,EAAO0E,OAAS,SAAU1C,GACtBA,EAAMS,kBAENY,EAAIG,UAAW,EAEfP,EAAO9N,YAAY,SAAUlE,GAIzBgS,EAAOpN,gBAAgB5E,EAAImD,SAAUnD,EAAIkD,WAAWnD,KAAK,SAAUrB,GAI/D,GAAIjG,GAASiG,EAAKA,KAAKjG,MACvBA,GAASzI,QAAQsH,KAAKmB,EAAOib,iBAAkB,WAAY,OAAQ,WAAY,SAAU,gBACzF,IAAItd,GAAW6b,EAAIzJ,aACf3D,IAAK7E,EAAImD,SACT2B,IAAK9E,EAAIkD,WAEbzK,GAAOya,YAAc9c,EAASyO,IAC9BpM,EAAO0a,aAAe/c,EAAS0O,IAE/BkC,EAAMyG,kBAAkBhV,EAAQsW,EAAO/M,OAEvChS,QAAQ6L,OAAO+U,EAAMnY,KAfzBuZ,SAiBShiB,QAAQwR,MAAMzB,KAAK,WACxBqS,EAAIG,UAAW,KAEpB,WACCH,EAAIG,UAAW,UAQnCviB,QAAQC,OAAO,iBAAiBwe,UAAU,YAAa,WACnD,OACIsB,SAAU,IACVjB,KAAM,SAAUvD,EAAOjR,GACnB5D,WAAW,WACP4D,EAAG,GAAGqZ,SACP,SAIf3jB,QAAQC,OAAO,iBAAiBwe,UAAU,aAAc,WACpD,OACImF,SAAU,kDACV9E,KAAM,SAAUC,GAEZA,EAAOvD,KAAO,WACNC,QAAQlT,QAAU,IAAGnC,SAAS+O,KAAO,YACzCsG,QAAQD,YAKxBxb,QAAQC,OAAO,iBAAiBwe,UAAU,gBAAgB,SAAU,aAAc,SAASoF,EAAQC,GAM/F,OACI/D,SAAU,IACVgE,QAAS,SAASC,EAAUC,GACxB,GAAIC,GAAKL,EAAOI,EAAKE,aAAkC,MAA4B,EACnF,OAAO,UAAwB5I,EAAO6I,GAClCA,EAAQ,GAAGC,iBAAiB,QAAS,SAAUtD,GAC3C,GAAIuD,GAAW,WACXJ,EAAG3I,GAAQgJ,OAAOxD,IAElB+C,GAAWU,QACXjJ,EAAMkJ,WAAWH,GAEjB/I,EAAMmJ,OAAOJ,KAElB,SAKnBtkB,QAAQC,OAAO,iBAAiBwe,UAAU,WAAY,KAAM,SAAUrZ,GAClE,OACI2a,SAAU,IACV4E,YAAY,EACZpJ,OACI/E,KAAM,KAEVqI,YAAa,eACbC,KAAM,SAAUvD,GACZ,GAAIqJ,EACJrJ,GAAM/E,KAAO,WAGT,MAFAoO,GAAWxf,EAAGyf,QACdtJ,EAAMuJ,YACCF,EAASrD,SAGpBhG,EAAMwJ,QAAU,WACZxJ,EAAMyJ,OAAM,GACZJ,EAASlD,SAAQ,IAGrBnG,EAAMvM,OAAS,WACXuM,EAAMyJ,SAGVzJ,EAAM0J,SAAW,WACbL,EAASlD,SAAQ,SAKjC1hB,QAAQC,OAAO,iBAAiBwe,UAAU,cAAe,SAAU,KAAM,SAAUyG,EAAQ9f,GACvF,OACI2a,SAAU,IACVxE,OACI4J,YAAa,cACbC,eAAgB,KAEpBC,QAAS,WACTvG,KAAM,SAAUvD,EAAOjR,EAAIgb,EAAOC,GACzBA,IAELA,EAAQC,iBAAiBC,WAAa,SAAUC,EAAQC,GACpD,GAAI9K,GAAQ6K,GAAUC,CAEtB,OAAK9K,IAELA,EAAwB,GAAhBA,EAAMtS,OAAc,KAAOsS,EAAQA,EAEpCqK,EAAOjT,cAAc4I,GAAO9K,KAAK,SAAUC,GAC9C,GAAIvL,GAASuL,EAAItB,KACbY,EAAM,GAAID,MAAKW,EAAIrK,QAAQ,SAC3BigB,EAAY,GAAIvW,MAAK5K,EAAOmhB,WAC5BC,EAAU,GAAIxW,MAAK5K,EAAOohB,QAE9B,OAAiBvW,IAAbsW,GAA2BC,GAAPvW,GACK,uBAArB7K,EAAOqhB,aACPvK,EAAM6J,eAAiB,4BAE3B7J,EAAM4J,YAAc1gB,EAAOqI,QAGpB1H,EAAGoB,OAAO,eAjBNpB,EAAGsc,QAAQ,UAwB9C1hB,QAAQC,OAAO,iBAAiBwe,UAAU,SAAU,WAChD,OACIlD,OACI+G,KAAM,IACNyD,MAAO,IACPra,KAAM,KAEViZ,YAAY,EACZ9F,YAAa,kBAGrB7e,QAAQC,OAAO,iBAAiBwe,UAAU,aAAc,WACpD,OACIsB,SAAU,IACVxE,OAAQoH,QAAS,eACjB7D,KAAM,SAAUvD,EAAOjR,GACnB,GAAIU,GAAOuQ,EAAMoH,QAAQqD,UAAY,IACjC9E,EAAY3F,EAAMoH,QAAQzB,WAAa,OAC3C3F,GAAM2D,OAAO,cAAe,SAAU+G,GAC9BA,GACAvf,WAAW,WACP4D,EAAG4b,SAAShF,GACZxa,WAAW,WACP4D,EAAG6b,YAAYjF,IAChBlW,IACJ,WAMvBhL,QAAQC,OAAO,iBAAiBwe,UAAU,oBAAqB,QAAS,OAAQ,YAAa,UAAW,QAAS,QAAS,SAAUnM,EAAOoM,EAAM0H,EAAWC,EAASvG,EAAO7R,GACxK,OACIsN,OACIgF,MAAO,IACPhW,OAAQ,IACRU,KAAM,IACNqb,UAAW,KAEfzH,YAAa,0BACbC,KAAO,SAAUvD,GAqEb,QAASgL,GAAaC,EAAQ9X,GAC1B,GAAIoP,GAAQvC,EAAMuC,MAAO2I,IAAY/X,CACvB,WAAV8X,EACc,IAAV1I,GAAe2I,EACflL,EAAMuC,MAAQ,EACE,GAATA,GAAe2I,EAEN,GAAT3I,GAAe2I,EAGR,GAAT3I,GAAc2I,EACnBlL,EAAMuC,MAAQ,EACE,GAATA,GAAe2I,IACtBlL,EAAMuC,MAAQ,GALdvC,EAAMuC,MAAQ,EAFdvC,EAAMuC,MAAQ,EASD,gBAAV0I,EACM,GAAT1I,GAAuB,GAATA,IACdvC,EAAMuC,MAAQ,GAED,gBAAV0I,EACM,GAAT1I,IACAvC,EAAMuC,MAAQ,GAED,gBAAV0I,GACM,GAAT1I,IACAvC,EAAMuC,MAAQ2I,EAAU,EAAI,GA7FxCxY,EAAMG,IAAI,qCAAqC+F,QAAQ,SAAS1L,GAC5D,GAAIgR,GAAI3Q,SAAS4d,cAAc,UAC3BzR,GAEA0R,GAAI,mCACJhe,MAAOG,SAASC,KAAKC,YACrB4d,UAAWne,EAAOme,UAGtBnN,GAAEnQ,IAAM,kCAAoC+C,OAAO7E,KAAKyN,GAC/C5K,IAAI,SAAUiC,GAAM,MAAOA,GAAM,IAAM2I,EAAO3I,KAC9CqB,KAAK,IAGd,IAAIkZ,GAAY7mB,QAAQokB,QAAQtb,SAASge,eAAe,oBAExDD,GAAUE,OAAOtN,GAEjB4M,EAAQW,eAAiB,SAASve,EAAQ6F,EAAIsI,GAC1C,GAAGnO,EAAQ,CACP,GAAIoS,GAAQ7a,QAAQokB,QAAQtb,SAASge,eAAe,qBAAqBG,KAAK,SAE1EvY,GACAwY,kBAAoBrM,EAAM,GAAGA,MAC7BsM,iBAAmBtM,EAAM,GAAGA,MAC5BuM,gBAAkBvM,EAAM,GAAGA,MAC3B5P,KAASsQ,EAAMtQ,KACfV,OAAWgR,EAAMhR,QAGjBiF,EAAQ4W,EAAU,WAClB,MAAO7K,EAAM8L,QAAS,CAClBjB,EAAUpX,OAAOQ,GACjB+L,EAAM8L,QAAUA,EAChB9L,EAAM+K,WAAY,EAElBC,EAAa,eAA+B,QAAfhL,EAAMgF,MACnC,KACI+G,QAAQ,GAAGC,UACb,MAAOC,OAEd,IAEH9I,GAAKrO,WAAW3B,GAAMyF,QAAQ,WAC1BwD,QAAQC,IAAI,aADhB8G,SAES,SAAU1O,GACf8P,EAAMtJ,KAAKxG,EAAItB,KAAK+S,iBAAkB,aAG1C8E,EAAa,mBAKzB,IAAIc,GAAU,EACd9L,GAAM8L,QAAU,GAEhB9L,EAAM2D,OAAO,SAAU,SAAU3U,GAC7Bgc,EAAa,SAAyB,QAAfhL,EAAMgF,SAGjChF,EAAMkM,YAAc,WAChBlB,EAAa,iBAKjBhL,EAAMuC,MAAQ,OAiC1B9d,QAAQC,OAAO,iBAAiBwe,UAAU,eAAgB,UAAW,YAAa,WAAY,SAAU4H,EAASqB,EAAW5F,GASxH,QAAS6F,GAAUC,GAEf,IADA,GAAI9M,GAAM8M,EAAKC,UACRD,EAAOA,EAAKE,cACfhN,GAAO8M,EAAKC,SAEhB,OAAO/M,GAGX,QAASiN,KACL,MAAOjf,GAASkf,gBAAgBC,cAAgB5B,EAAQ6B,SACpDpf,EAASkf,gBAAgBG,WAAarf,EAASC,KAAKof,WAjB5D,GAEIC,GAFAC,KACAvf,EAAW4e,EAAU,EAkCzB,OAfAK,GAAgBO,IAAK,EAErBtoB,QAAQokB,QAAQiC,GAASkC,GAAG,SAAU,WAClCH,EAAeL,GACf,KAAK,GAAWzd,GAAP9B,EAAI,EAAOA,EAAI6f,EAAS9f,QACzBof,EAAUU,EAAS7f,GAAG,IAAM4f,GAC5B9d,EAAKtK,QAAQokB,QAAQiE,EAAS7f,GAAG,IACjC8B,EAAG,GAAGhB,IAAM+e,EAAS7f,GAAG,GAAGggB,MAAMle,EAAG2Z,KAAK,kBACzCoE,EAASvH,OAAOtY,EAAG,IAEnBA,OAMRuX,SAAU,IACVjB,KAAM,SAAUvD,EAAOjR,EAAI2Z,GACvB,GAAIwE,GAAMne,EAAG,EACb+d,GAASjhB,MAAMqhB,EAAKlN,GACpB,IAAI0D,GAAY1D,EAAM2D,OAAO+E,EAAKyE,YAAa,SAAUpf,GACjDA,IACA2V,IACI8I,EAAgBO,KAChBF,EAAeL,IACfA,EAAgBO,IAAK,EACrB5hB,WAAW,WACPqhB,EAAgBO,IAAK,GACtB,MAKHX,EAAUc,GAAOL,GACjBC,EAASpiB,KAAK,SAAUsU,EAAM/R,GAC1B,MAAI+R,GAAK,IAAMkO,GACXA,EAAInf,IAAMA,EACV+e,EAASvH,OAAOtY,EAAG,IACZ,GAHX,WAUX+S,GAAMoN,qBACPpN,EAAMoN,oBAAqB,EAC3BpN,EAAMI,IAAI,WAAY,WAClB,IAAK,GAAInT,GAAI,EAAGA,EAAI6f,EAAS9f,QACrB8f,EAAS7f,GAAG,IAAM+S,EAClB8M,EAASvH,OAAOtY,EAAG,GAEnBA,YAQ5BxI,QAAQC,OAAO,iBAAiBwe,UAAU,UAAW,WACjD,OACIsB,SAAU,IACVxE,OACI9U,KAAM,IACNmY,SAAU,IACVgK,YAAa,KAEjB/J,YAAa,gBACbC,KAAM,SAAUC,GACZA,EAAO8J,SAAW,WACdziB,SAAS+O,KAAM,gBAGM,cAArB/O,SAASC,WACT0Y,EAAOtY,KAAO,kBAK9BzG,QAAQC,OAAO,iBAAiBwe,UAAU,QAAS,WAC/C,OACIsB,SAAU,IACV4E,YAAY,EACZpJ,OACI/E,KAAM,IACNwO,MAAO,IACP8D,OAAQ,IACR7D,SAAU,MAEdpG,YAAa,aACbC,KAAM,SAAUvD,EAAOjR,EAAIgb,GAsBvB,QAASyD,GAAUhI,EAAO/a,GACtB+a,GAASA,EAAMS,kBACAwH,SAAXhjB,EACAuV,EAAM6G,IAAI5L,MAAQ+E,EAAM6G,IAAI5L,KAE5B+E,EAAM6G,IAAI5L,KAAOxQ,EA1BzBuV,EAAM6G,KAAO5L,MAAM,GAEE,QAAjB8O,EAAAA,aACA/J,EAAM6G,IAAI5L,MAAO,GAGrB+E,EAAM/E,KAAO,WACTuS,EAAUhI,OAAO,IAGrBxF,EAAMyJ,MAAQ,SAAUiE,IACfA,GAAkB1N,EAAM0J,UACzB1J,EAAM0J,WAEV8D,EAAUhI,OAAO,IAGrBxF,EAAMuN,OAAS,WACXC,EAAUhI,YAc1B/gB,QAAQC,OAAO,iBAAiBwe,UAAU,sBAAuB,WAC7D,OACII,YAAa,6BACbtD,OAAO,EACPuD,KAAM,SAAUvD,GACZ,GAAI9U,GAAOL,SAASC,QACR,iBAARI,EACA8U,EAAMuC,MAAQ,SACC,wBAARrX,EACP8U,EAAMuC,MAAQ,SACC,oBAARrX,IACP8U,EAAMuC,MAAQ,cAK9B9d,QAAQC,OAAO,iBAAiBwe,UAAU,aAAc,QAAS,OAAQ,YAAa,SAAUnM,EAAOoM,EAAM0H,GACzG,OACI7K,OACIgF,MAAO,IACPhW,OAAQ,IACRU,KAAM,KAEV4T,YAAa,kBACbC,KAAO,SAAUvD,GA6Cb,QAAS2N,KACL,MAAO3N,GAAM2D,OAAO,SAAU,SAAU3U,GAChB,IAAhBgR,EAAMuC,OAAevT,GAA2B,IAAjBA,EAAOhC,OACtCgT,EAAMuC,MAAQ,EACS,IAAhBvC,EAAMuC,OAAiBvT,GAA2B,IAAjBA,EAAOhC,OAExB,IAAhBgT,EAAMuC,OAAevT,GAA0B,IAAhBA,EAAOhC,OAC7CgT,EAAMuC,MAAQ,EACS,IAAhBvC,EAAMuC,OAAiBvT,GAA2B,IAAjBA,EAAOhC,SAC/CgT,EAAMuC,MAAQ,GAJdvC,EAAMuC,MAAQ,IAjD1BvC,EAAMuC,MAAQ,EACdvC,EAAM8L,QAAU,EAEhB,IAAIrY,GAASka,GAEb3N,GAAMlL,WAAa,WACfkL,EAAMuC,MAAQ,EACV9O,IACAA,IACAA,EAAS,KAGb,IAAIQ,GAAQ4W,EAAU,aACX7K,EAAM8L,UACTjB,EAAUpX,OAAOQ,GACjB+L,EAAM8L,QAAU,GAEhB/U,EAAM0F,OAA6B,gBAAfuD,GAAMgF,MAAmB,uBACzB,SAAhBhF,EAAMgF,MACNhF,EAAMuC,MAAQ,EAEdvC,EAAMuC,MAAQ,EAIlB9O,EAASka,MAEd,IAEHxK,GAAKrO,YACD9F,OAAQgR,EAAMhR,OACdU,KAAMsQ,EAAMtQ,OACb8E,KAAK,SAAUC,GAEVA,EAAItB,KAAKjC,OALjBiS,SAQS,SAAU1O,GAEf2G,MAAM,iBACNrE,EAAMqE,MAAM3G,WAoBhChQ,QAAQC,OAAO,iBAAiBwe,UAAU,gBAAiB,WAAY,SAAUqD,GAC7E,OACI/B,SAAU,IACVlB,YAAa,oBACbC,KAAM,SAAUvD,GACZuG,EAAS,WACLvG,EAAMyJ,SACP","file":"app.min.933f7b64.js","sourcesContent":["angular.module('xw', ['xw.config', 'xw.services', 'xw.controllers', 'xw.directives', 'xw.filters']);\n\nangular.module('xw.config', ['ngStorage']);\n\nangular.module('xw.models', ['ngStorage']);\n\nangular.module('xw.controllers', ['xw.models', 'xw.weixin']);\n\nangular.module('xw.directives', ['xw.models']);\n\nangular.module('xw.filters', []);\n\nangular.module('xw.weixin', []); // tmp\n\nangular.module('xw.services', []);\n//generated by gulp errcode\nangular.module(\"xw.config\").constant(\"errCode\", function(){\nreturn {\n    user: {\n        // 第一位是大项分类,第二位是子分类 第三位开始一次排序 间隔建议为2或5 方便以后插入\n        wrongMobile   : 1110,\n        wrongPassword : 1111,\n        alreadyExist  : 1112,\n        notFound      : 1113,\n\n        userReferrerWrong : 1140,\n\n        userIdWrong : 1150,\n        userGenderWrong : 1152,\n        userOldAddressWrong : 1155,\n\n        invitationSendCodeWrong : 1190,\n\n        addressIdWrong : 1210,\n        addressNotFound : 1212,\n        addressNotInUser : 1214,\n\n        addressLatitudeWrong  : 1220,\n        addressLongitudeWrong : 1221,\n        addressCoordTypeWrong : 1222,\n\n        addressProvinceWrong     : 1225,\n        addressCityWrong         : 1226,\n        addressDistrictWrong     : 1227,\n        addressStreetWrong       : 1228,\n        addressStreetNumberWrong : 1229,\n        addressAddressWrong      : 1230,\n\n        addressContactPersonWrong : 1235,\n        addressMobileWrong        : 1236,\n        addressSortOrderWrong     : 1237,\n\n        addressNotDeliver     : 1270,\n\n        addressBaiduMapNotFoundError     : 1280,\n        addressBaiduMapQueryWrong     : 1290,\n        addressBaiduMapRegionWrong     : 1291,\n\n\n        shoppingCartNotArray     : 1500,\n        shoppingCartDishIdWrong     : 1502,\n        shoppingCartDishNumberWrong     : 1504,\n        shoppingCartSubDishIdWrong     : 1506,\n        shoppingCartSubDishNumberWrong     : 1508\n\n\n\n\n\n    },\n    order: {\n        notFound: 2010,\n\n        orderNumberWrong: 2010,\n        orderIdWrong: 2011,\n        warehouseIdWrong: 2012,\n\n        cookingTypeWrong: 2110,\n        clientFromWrong: 2112,\n\n        creditWrong: 2115,\n        freightWrong: 2117,\n        paymentWrong: 2119,\n        paymentUsedCashWrong: 2120,\n\n        deliveryDateCookWrong: 2122,\n        deliveryTimeCookWrong: 2124,\n        deliveryDateEatWrong: 2126,\n        deliveryTimeEatWrong: 2128,\n\n        dishListArrayWrong: 2130,\n        dishListDishNumberWrong: 2132,\n        dishListDishIdWrong: 2134,\n        dishListSubDishArrayWrong: 2136,\n        dishListSubDishNumberWrong: 2138,\n        dishListSubDishIdWrong: 2139,\n\n\n        addressLatitudeWrong  : 2140,\n        addressLongitudeWrong : 2142,\n\n        addressProvinceWrong     : 2144,\n        addressCityWrong         : 2145,\n        addressDistrictWrong     : 2146,\n        addressStreetWrong       : 2147,\n        addressStreetNumberWrong : 2148,\n        addressAddressWrong      : 2149,\n\n        addressContactPersonWrong : 2152,\n        addressMobileWrong        : 2154,\n\n        addressIdWrong : 2160,\n\n        userCommentWrong: 2180,\n\n        dishIdInvalid: 2190,\n        notOnlyDrink: 2192,\n        notOverTenDrinks: 2194,\n\n\n        orderStatusWrong: 2300,\n        orderPaymentStatusWrong: 2310\n\n\n\n\n    },\n    sms: {\n        wrongCode: 3110,\n        expired: 3111,\n        invalidCode: 3112,\n        wrongType: 3113,\n        tooManyTries: 3114,\n        sendFailed: 3115,\n        reachSendLimitation: 3116\n    },\n    dish: {\n        outOfStock: 4110\n    },\n    coupon: {\n\n        notStart: 5110,\n        expired: 5111,\n        used: 5112,\n        outOfCount: 5113,\n        notFound      : 5120,\n        exchanged: 5121,\n\n        couponIdWrong : 5210,\n        promotionCodeWrong : 5212\n    },\n\n    announcement: {\n        announcementIdWrong : 8110,\n        notFound: 8112\n    }\n};\n});\nangular.module('xw.config').factory('commonInterceptor', ['$localStorage', '$q', function($localStorage, $q) {\n    var noRedirectPath = [/^\\/mobile\\/$/, /^\\/mobile\\/login/, /^\\/mobile\\/cook/, /^\\/mobile\\/resetpwd$/];\n    var noRedirectAPI = ['/api/user', '/api/user/token', '/api/user/shoppingcart', '/api/user/address'];\n    var loginRedirectPath = ['/mobile/me', '/mobile/addresslist', '/mobile/orderaddress', '/mobile/orderlist',\n        '/mobile/invite', '/mobile/coupons', '/mobile/cook', '/mobile/balance', '/mobile/chargebalanceonline',\n        '/mobile/promotion01'];\n\n    return {\n        'request': function(config) {\n            if ($localStorage.access_token) {\n                config.headers.Authorization = 'Bearer ' + $localStorage.access_token;\n            }\n\n            return config;\n        },\n\n        'responseError': function(response) {\n            // do something on error\n            var redirectPath = '';\n            if (response.status == 401) {\n                // todo: redirect\n                if (noRedirectPath.some(function (RE) {return RE.test(location.pathname)})) {\n                    if (noRedirectAPI.indexOf(response.config.url) != -1) {\n                        return $q.reject(response);\n                    }\n                }\n                if (loginRedirectPath.some(function(path){\n                        return location.pathname.indexOf(path) != -1\n                    })) {\n                    redirectPath = '?redirect=' + location.pathname\n                }\n                setTimeout(function () {\n                    // todo:\n                    location.replace('/mobile/login' + redirectPath);\n                }, 120);\n            }\n            return $q.reject(response);\n        }\n    };\n}]);\n\n\nangular.module('xw.config').config(['$httpProvider', '$compileProvider',\n    function($httpProvider, $compileProvider) {\n        // http interceptor\n        $httpProvider.defaults.headers.common.Accept = 'application/vnd.cook.v1+json';\n        $httpProvider.defaults.headers.common['Access-Control-Allow-Origin'] = 'http://m.xinweicook.com';\n        $httpProvider.defaults.headers.common['Accept-Language'] = navigator.language == 'zh-CN' ? 'zh-CN' : 'en-US';\n        $httpProvider.defaults.headers.common['Content-Type'] = 'application/json';\n\n        $httpProvider.interceptors.push('commonInterceptor');\n\n        // disable debug data for performance.\n        $compileProvider.debugInfoEnabled(false);\n    }\n]);\n\n\nangular.pick = function (obj) {\n    var keys = Array.prototype.slice.call(arguments, 1);\n    return keys.reduce(function (o, k) {\n        o[k] = obj[k];\n        return o;\n    }, {});\n};\n\nangular.sort = function sort (_array, compare) {\n    var array = _array.slice(0);\n    var tmp;\n    for (var l = array.length - 1; l >= 1; l--) {\n        for (var i = 0; i < l; i++) {\n            var result = compare(array[i], array[i + 1]);\n            if (result > 0) {\n                tmp = array[i];\n                array[i] = array[i + 1];\n                array[i + 1] = tmp;\n            }\n        }\n    }\n    return array;\n};\n\n/**\n * 图片自适应为屏幕宽度\n */\nangular.module('xw.filters').filter('adapt', function () {\n    var width = Math.floor(document.body.offsetWidth * window.devicePixelRatio);\n    var height = Math.floor(width * 2 / 3);\n    var prefix = '?imageView2/1/w/';\n    var query = prefix + width + '/h/' + height;\n    return function (src, ratio) {\n        return src + (ratio ?\n                prefix + width + '/h/' + Math.floor(width * ratio) :\n                query)\n    }\n});\n\n/**\n *  将类似于1/2的文本显示为¹⁄₂\n */\nangular.module('xw.filters').filter('fraction', function () {\n    var superscripts = ['⁰', '¹', '²', '³', '⁴', '⁵', '⁶', '⁷', '⁸', '⁹'];\n    var subscripts = ['\\u2080', '\\u2081', '\\u2082', '\\u2083', '\\u2084',\n        '\\u2085', '\\u2086', '\\u2087', '\\u2088', '\\u2089'];\n\n    function i2s(sval, scripts) {\n        var ret = '';\n        for (var i = 0; i < sval.length; i++) {\n            ret += scripts[sval[i]]\n        }\n        return ret;\n    }\n\n    return function (str) {\n        return str.replace(/(\\d+)\\/(\\d+)/g, function (_, sup, sub) {\n            return i2s(sup, superscripts) + '⁄' + i2s(sub, subscripts) + ' ';\n        })\n    }\n});\n\n/**\n * 将服务器传回来的dish结构的数据转换为post dish更新购物车时需要的格式(不在模板中使用)\n */\nangular.module('xw.filters').filter('postDish', function () {\n    return function (dish) {\n        return {\n            dish: dish.dish._id,\n            number: dish.number,\n            subDish: !dish.subDish ? [] : dish.subDish.map(function (el) {\n                return {\n                    dish: el.dish._id,\n                    number: el.number\n                }\n            })\n        }\n    }\n});\n\n/**\n * 使mobile变成 133 3333 3333这种形式, 有更好的可读性\n */\nangular.module('xw.filters').filter('beautifyMobile', function () {\n    return function (mobile) {\n        if (!/^\\d{11}$/.test(mobile)) return mobile;\n        return mobile.replace(/^(\\d{3})(\\d{4})(\\d{4})$/,\n            function (_, m1, m2, m3) {\n                return m1 + ' ' + m2 + ' ' + m3;\n            })\n    }\n});\n\n/**\n * 使title变成 '/土豆泥' 这样的形式\n */\nangular.module('xw.filters').filter('subDishTitle', function () {\n    return function (item) {\n        var last = item.subDish.length;\n        if (!last) return '';\n        return '(' + item.subDish.reduce(function (title, cur, i) {\n            return title + cur.dish.title.zh + (i == last - 1 ? '' : '/')\n        }, '') + ')';\n    }\n});\n\n/**\n * 将查询返回的派送时间转换成下单所需要的形式[NOT FOR HTML]\n * time为{hour: ''}, 当type为eat时,\n * time为{day:{day:''}, time: {name: ''}}, 当type为cook时,\n * time为{eat: {hour}, cook:{day,time}}, 当type为all时.\n */\nangular.module('xw.filters').filter('orderTime', function () {\n    return function filter(time, type) {\n        var ret;\n        if (type == 'eat') {\n            return {\n                deliveryDateEat: time.hour.substr(0, 10),\n                deliveryTimeEat: time.hour.substr(11, 5)\n            }\n        } else if (type == 'cook') {\n            ret = {deliveryDateCook: time.day};\n            ret.deliveryTimeCook = time.segment ? time.segment.name+':00' : '12:00';\n            return ret;\n        } else if (type == 'all') {\n            ret = {};\n            if (time.eat) ret = filter(time.eat, 'eat');\n            if (time.cook) angular.extend(ret, filter(time.cook, 'cook'));\n            return ret;\n        }\n    }\n});\n\nangular.module('xw.filters').filter('cookTimeUnion', function () {\n    return function (times) {\n        if (!times) {\n            return times\n        }\n\n        var hasSegment = !!times[0].segment;\n\n        return times.reduce(function (list, cur) {\n            if (hasSegment) {\n                cur.segment.forEach(function (item) {\n                    list.push({\n                        day: cur.day,\n                        segment: item\n                    })\n                })\n            } else {\n                list.push({day: cur.day})\n            }\n            return list;\n        }, [])\n    }\n})\n\n/**\n * 有多种不同的dishList类型, 有些是从后端获得的, 有些是作为更新购物车post回去的,\n * 有些是前端为了展示方便而构造的, 此处对其做统一转换, 免去放在controller中的苦恼.\n * dishes: 待转换待原始数据. tType:target type. sType: source type\n * type: 'displayCart',用来展示待购物车的dish list\n *       'order', 用来下单的list\n *\n * examples:\n * displayCart, 为 {cookList: [], eatList: []}, 其中[]为如下形式\n * [{\n *   dish: Dish, // {_id: '', title: {zh:'', en: ''}, ...}\n *   subDish: [{dish},.]\n *   number\n * }, ..]\n *\n * order, 为 {dishList: []}, 其中[]为如下形式\n * [{\n *   dish: _id,\n *   number: number,\n *   subDish: [..]\n * }, ..]\n */\nangular.module('xw.filters').filter('dishes', function () {\n    return function (dishes, tType, sType) {\n        var ret;\n        // 将displayCart 转换为 order 类型的dishList\n        if (tType == 'order' && sType == 'displayCart') {\n            ret = [];\n            Object.keys(dishes).forEach(function (key) {\n                dishes[key].forEach(function (el) {\n                    ret.push({\n                        dish: el.dish._id,\n                        number: el.number,\n                        subDish: el.subDish.map(function (sDish) {\n                            return {\n                                dish: sDish.dish._id,\n                                number: sDish.number\n                            }\n                        })\n                    });\n                });\n            });\n\n            return {dishList: ret}\n        } else return dishes\n    }\n});\n\n/**\n * 优惠券下单数据转换.要求传入当数据格式为: {code: '优惠码字符串', card: {优惠券对象}}\n */\nangular.module('xw.filters').filter('coupon', function () {\n    return function (coupon) {\n        var ret = {};\n        if (coupon.code) {\n            ret.promotionCode = coupon.code;\n            if (coupon.code.length == 8) {\n                // tcl 优惠券特殊处理. 我们的优惠券要求必须是10位\n                ret.promotionCode = 'zz' + ret.promotionCode;\n            }\n        }\n        if (coupon.card) {\n            ret.coupon = coupon.card._id;\n        }\n        return ret;\n    }\n});\n\n/**\n * 便当配送时间选项补充上请选择时间\n */\nangular.module('xw.filters').filter('eatTimeOptions', function () {\n    return function (times) {\n        if (!times || !times.length) return times;\n        times.unshift({hour: '请选择配送时间'});\n        return times;\n    }\n});\n\nangular.module('xw.filters').filter('eatTimeDisplay', function () {\n    return function (time) {\n        return time.hour\n    }\n});\n\nangular.module('xw.filters').filter('cookTimeOptions', function () {\n    return function (times) {\n        if (!times || !times.length) return times;\n        times.unshift({day: '请选择配送时间'});\n        return times\n    }\n});\n\nangular.module('xw.filters').filter('cookTimeDisplay', function () {\n    return function (time) {\n        return time.day == '请选择配送时间' || time.segment ?\n            time.day : time.day + ' 送达'\n    }\n});\n\n// 返回购物车item的价格\nangular.module('xw.filters').filter('dishPrice', function () {\n    return function (item, total) {\n        var price = item.dish.priceOriginal;\n        if (item.subDish) {\n            for (var i = 0, len = item.subDish.length; i < len; i++) {\n                price += item.subDish[i].dish.priceOriginal;\n            }\n        }\n        return price * (total ? item.number : 1);\n    }\n})\n\n\n// 订单状态\nangular.module('xw.filters').filter('orderStatus', function () {\n    var _status = {\n        'not paid': '未支付',\n        'paid': '已支付',\n        'confirmed': '已确认',\n        'dish finished': '已完成',\n        'packaged': '已打包',\n        shipped: '配送中',\n        finished: '已完成',\n        canceled: '已取消'\n    }\n    \n    return function(status) {\n        return _status[status] || ''\n    }\n})\n\n// 订单状态\nangular.module('xw.filters').filter('orderId', function () {\n    return function(orderId) {\n        if (!orderId) return orderId\n        var ret = []\n        for (var i = 0; i < orderId.length; i+=4) {\n            ret.push(orderId.substr(i, 4))\n        }\n        return ret.join(' ')\n    }\n})\n\n// 支付方式\nangular.module('xw.filters').filter('payment', function () {\n    var _payment = {\n        'alipay direct': '支付宝',\n        'weixinpay':'微信钱包',\n        'account balance': '新味币'\n    }\n    return function(payment) {\n        return _payment[payment] || payment\n    }\n})\n\n\nangular.module('xw.models').factory('Dishes', [\"$http\", function ($http) {\n\n    return {\n        getList: function (cookingType) {\n            cookingType = cookingType || '';\n            return $http.get(\n                '/api/dishes?' +\n                'cookingType=' + cookingType\n            );\n        },\n        like: function (id) {\n            return $http.put('/api/dishes/' + id + '/like');\n        },\n        getOne: function (id) {\n            return $http.get('/api/dishes/' + id);\n        }\n    }\n}]);\n\nangular.module('xw.models').factory('Orders', [\"$http\", function ($http) {\n    return {\n        postOrder: function (data) {\n            return $http.post('/api/orders', data);\n        },\n        deliveryTime: function (data) {\n            return $http.post('/api/orders/delivery/time', data)\n        },\n        deliveryEatTime: function (data) {\n            return $http.post('/api/orders/delivery/time/eat/warehouse', data)\n        },\n        getOrder: function (orderId) {\n            return $http.get('/api/orders/' + orderId);\n        },\n        updateOrder: function (id, data) {\n            return $http.put('/api/orders/' + id, data)\n        },\n        cancel: function (id) {\n            return $http.put('/api/orders/' + id, {\n                isPaymentPaid: \"false\",\n                status: \"canceled\"\n            })\n        },\n        getList: function () {\n            return $http.get('/api/orders');\n        },\n        getUnifiedOrder: function (data) {\n            return $http.post('/api/orders/payment/weixinpay/unifiedorder', data);\n        },\n        price: function (data) {\n            return $http.post('/api/orderprice', data);\n        },\n        payByAlipay: function (id) {\n            return $http.post('/api/orders/payment/alipay/sign', {_id: id})\n        }\n    }\n}]);\n\nangular.module('xw.models').factory('User', [\"$http\", \"$localStorage\", function ($http, $localStorage) {\n    // 这些变量作为更新购物车用\n    // 最近一次添加至cart的时间\n    var cartDate = Date.now();\n    var timeSpan = 500;\n    var timer = null;\n\n    return {\n        login: function (username, password, couponcode) {\n            var args = {\n                username: username,\n                password: password,\n                grant_type: 'password'\n            };\n            if (couponcode) args.couponcode = couponcode;\n            return $http.post('/api/user/token', args).then(function (res) {\n                if (res.data && res.data.access_token) {\n                    $localStorage.access_token = res.data.access_token;\n                }\n\n                return res;\n            })\n        },\n        signup: function (mobile, pwd, code, couponcode, referrer) {\n            var opts = {\n                mobile: mobile,\n                pwd: pwd,\n                code: code,\n                referrer: referrer || ''\n            };\n            if (couponcode) {\n                opts.couponcode = couponcode;\n            }\n            return $http.post('/api/user/signup', opts).then(function (res) {\n                if (res.data && res.data.access_token) {\n                    $localStorage.access_token = res.data.access_token;\n                }\n\n                return res;\n            })\n        },\n        getSmsCode: function (data) {\n            return $http.post('/api/user/sms', data)\n        },\n        logout: function () {\n            return $http.post('/api/user/logout', {\n                token_type_hint: \"access_token\",\n                token: $localStorage.access_token\n            })\n        },\n        getUserInfo: function () {\n            return $http.get('/api/user').then(function (res) {\n                localStorage.uid = res.data._id\n                window.trackJs.configure({ userId: res.data._id})\n                return res;\n            })\n        },\n        updateUser: function (data) {\n            return $http.put('/api/user', data)\n        },\n        resetPwd: function (mobile, pwd, code) {\n            return $http.post('/api/user/resetpassword', {\n                mobile: mobile,\n                pwd: pwd,\n                code: code\n            });\n        },\n        postCart: function (cart) {\n            var now = Date.now();\n            if (now - cartDate > timeSpan) {\n                clearTimeout(timer);\n                return $http.post('/api/user/shoppingcart', {shoppingCart: cart});\n            } else {\n                clearTimeout(timer);\n                timer = setTimeout(this.postCart.bind(this, cart), timeSpan + 100)\n            }\n            cartDate = now;\n            return {'catch': angular.noop}\n        },\n        applyInvitationCode: function (code) {\n            return $http.get('/api/user/coupon/invitation/' + code)\n        },\n        invitedFriends: function () {\n            return $http.get('/api/user/coupon/friends');\n        },\n\n        getWeixinUserInfo: function (id) {\n            return $http.get('/api/user/weixin/userinfo?userId=' + id);\n        }\n\n    }\n}]);\n\nangular.module('xw.models').factory('Address', [\"$http\", function ($http) {\n    return {\n        getList: function () {\n            return $http.get('/api/user/address')\n        },\n        addOne: function (address) {\n            return $http.post('/api/user/address',address)\n        },\n        update: function (address) {\n            return $http.put('/api/user/address' + '/' + address._id, address)\n        },\n        'delete': function (id) {\n            return $http.delete('/api/user/address/' + id)\n        },\n        range: function () {\n            return $http.get('/api/orders/delivery/range')\n        }\n    }\n}]);\n\nangular.module('xw.models').factory('Coupon', [\"$http\", function ($http) {\n    return {\n        getCouponInfo: function (code) {\n            return $http.get('/api/coupons/code/' + code);\n        },\n        exchangeCouponCode: function (code) {\n            return $http.get('/api/user/coupon/code/' + code);\n        }\n    }\n}]);\n\nangular.module('xw.models').factory('Alipay', [\"$http\", function ($http) {\n    return {\n        notify: function (id, isCharge) {\n            var url = isCharge ? '/api/orders/payment/alipay/notify/account'\n                : '/api/orders/payment/alipay/mobile';\n            return $http.post(url, {out_trade_no: id})\n        }\n    }\n}]);\n\nangular.module('xw.models').factory('Balance', [\"$http\", \"Debug\", function ($http, Debug) {\n    return {\n        balance: function () {\n            return $http.get('/api/user/account')\n        },\n        chargeByCode: function (code) {\n            return $http.post('/api/user/account/chargecode', {accountChargeCode: code});\n        },\n        chargeOnline: function (data) {\n            return $http.post('/api/user/account/details', data);\n        },\n        balanceRecords: function () {\n            return $http.get('/api/user/account/details?skip=0&limit=200')\n                .catch(Debug.promiseErrFn('获取余额记录失败'))\n        }\n    }\n}])\n\nangular.module(\"xw.directives\").run([\"$templateCache\", function($templateCache) {$templateCache.put(\"add-dish-bar.html\",\"<div class=\\\"selection-cover\\\" ng-cloak ng-if=\\\"dish\\\" ng-click=\\\"hide()\\\"></div><div class=\\\"selections-container\\\" ng-if=\\\"dish\\\" ng-cloak><div class=\\\"block\\\"><h4 class=\\\"text-center\\\">{{dish.title.zh}}<span ng-click=\\\"hide()\\\" class=\\\"button close-button\\\"></span></h4><ul class=\\\"properties\\\" ng-if=\\\"dish.preferences.length\\\"><li ng-repeat=\\\"property in dish.preferences track by property._id\\\"><h5>{{property.name.zh}}</h5><ul class=\\\"selections\\\"><li ng-repeat=\\\"selection in property.foodMaterial track by selection._id\\\" ng-click=\\\"(!selection.outOfStock && selection.dish.isPublished) && (dish.curSelection[property.name.zh] = selection.dish)\\\" ng-class=\\\"{\\'no-stock\\': (selection.outOfStock || !selection.dish.isPublished), selected: dish.curSelection[property.name.zh] == selection.dish}\\\">{{selection.dish.title.zh}}</li></ul></li></ul><div class=\\\"counter-wrapper\\\"><i>份数</i><div class=\\\"counter text-center\\\"><span ng-click=\\\"dish.count>0 && (dish.count=dish.count-1)\\\" class=\\\"minus\\\">-</span> <span class=\\\"number\\\">{{dish.count}}</span> <span ng-click=\\\"dish.count=dish.count+1\\\" class=\\\"add\\\">+</span></div></div><div class=\\\"add-to-cart-button text-center\\\" ng-class=\\\"{invalid: dish.count == 0}\\\" ng-click=\\\"dish.count>0 && addToCart(dish)\\\">加入购物袋</div></div></div>\");\n$templateCache.put(\"address-list.html\",\"<ul class=\\\"address-list\\\" capture-click=\\\"watchAddress($event)\\\"><li class=\\\"address-item\\\" ng-repeat=\\\"address in addresses\\\"><address cur=\\\"{{address.isDefault}}\\\" range=\\\"range\\\" out-address=\\\"address\\\" hide=\\\"hideAddress($index)\\\" leave=\\\"handler.leave[$index]\\\" save=\\\"handler.save[$index]\\\" valid=\\\"handler.valid[$index]\\\" delete-hook=\\\"remove($index)\\\"></address></li><li ng-if=\\\"range\\\" class=\\\"address-item\\\"><address range=\\\"range\\\" out-address=\\\"data.newAddress\\\" cur=\\\"{{!addresses.length}}\\\" hide=\\\"hideAddress(-2)\\\" leave=\\\"handler.leave.newAddress\\\" save=\\\"handler.save.newAddress\\\" valid=\\\"handler.valid.newAddress\\\"></address></li></ul>\");\n$templateCache.put(\"address-selection.html\",\"<div class=\\\"address-selection\\\" flash-class=\\\"{exp: animateTrigger, duration: 400}\\\" ng-if=\\\"show\\\" ng-cloak><a href=\\\"/mobile/orderaddress?path={{path}}&dishId={{dishId}}\\\"><div ng-show=\\\"path != \\'/eat\\' && address\\\" class=\\\"address-tip\\\">配送至:{{address.street + address.address | limitTo: 18}}</div><div ng-show=\\\"noAddress\\\" class=\\\"no-address-tip\\\">您没有可以配送的地址,请先新建地址</div><div ng-show=\\\"path == \\'/eat\\' && (address && !address.isAvailableForEat)\\\" class=\\\"no-address-tip\\\">当前地址不在便当配送范围内</div><div ng-show=\\\"path == \\'/eat\\' && address.isAvailableForEat\\\" class=\\\"address-tip\\\">配送至:{{address.street + address.address | limitTo: 18}}</div></a></div>\");\n$templateCache.put(\"address.html\",\"<div ng-if=\\\"css.isNewAddress && css.edit\\\" class=\\\"new-address-tip\\\">请填写有效的地址以便按时送达</div><div ng-hide=\\\"hide()\\\" class=\\\"address-component\\\" ng-class=\\\"{cur: css.cur || css.isNewAddress, edit: css.edit}\\\" ng-click=\\\"choose($event)\\\"><div class=\\\"address-block\\\" ng-if=\\\"!css.isNewAddress\\\"><span class=\\\"deliverable-tag\\\" ng-if=\\\"addr.isAvailableForEat\\\">便当可送达</span><div>{{addr.contactPerson}}</div><div class=\\\"cur-show\\\">{{addr.mobile | beautifyMobile}}</div><div class=\\\"cur-show\\\">{{addr.province + \\' \\' + addr.city + \\' \\' + addr.district}}</div><div>{{addr.street}}</div><div class=\\\"cur-show\\\">{{addr.address}}</div><div class=\\\"user-actions\\\"><span class=\\\"glyphicon glyphicon-pencil\\\"></span> <span ng-click=\\\"deleteAddress($event)\\\" class=\\\"glyphicon glyphicon-trash\\\"></span></div></div><div class=\\\"new-address-block\\\" ng-if=\\\"css.isNewAddress && !css.edit\\\">+ 新建收货地址</div><form ng-model-options=\\\"{ updateOn: \\'default blur\\', debounce: { \\'default\\': 500, \\'blur\\': 0 } }\\\" ng-class=\\\"{\\'new-address\\': css.isNewAddress}\\\" ng-if=\\\"css.edit\\\" name=\\\"form\\\"><div ng-init=\\\"initForm(form, addr)\\\" ng-class=\\\"{\\'with-tag\\': addr.isAvailableForEat}\\\"><input name=\\\"contactPerson\\\" type=\\\"text\\\" placeholder=\\\"收货人\\\" ng-model=\\\"addr.contactPerson\\\" auto-focus minlength=\\\"2\\\" required><err-tip form=\\\"form\\\" name=\\\"contactPerson\\\" error=\\\"required\\\">必填</err-tip><err-tip form=\\\"form\\\" name=\\\"contactPerson\\\" error=\\\"minlength\\\">联系人姓名至少2个字</err-tip></div><div><input name=\\\"mobile\\\" type=\\\"tel\\\" placeholder=\\\"手机号\\\" ng-model=\\\"addr.mobile\\\" pattern=\\\"^1\\\\d{10}$\\\" required><err-tip form=\\\"form\\\" name=\\\"mobile\\\" error=\\\"required\\\">必填</err-tip><err-tip form=\\\"form\\\" name=\\\"mobile\\\" error=\\\"pattern\\\">请填写11位手机号</err-tip></div><div ng-show=\\\"!css.showFakeInput\\\" class=\\\"selects\\\"><div class=\\\"select\\\"><select required name=\\\"province\\\" id=\\\"province\\\" ng-options=\\\"province for province in options()\\\" ng-change=\\\"trySelectUnique()\\\" ng-model=\\\"addr.province\\\"></select></div><div class=\\\"select\\\"><select required name=\\\"city\\\" id=\\\"city\\\" ng-options=\\\"city for city in options(addr.province)\\\" ng-model=\\\"addr.city\\\"></select></div><div class=\\\"select\\\"><select required name=\\\"district\\\" id=\\\"district\\\" ng-options=\\\"district for district in options(addr.province, addr.city)\\\" ng-model=\\\"addr.district\\\"></select></div></div><div ng-if=\\\"css.showFakeInput\\\"><input type=\\\"text\\\" placeholder=\\\"省、市、区\\\" ng-click=\\\"css.showFakeInput = false\\\"> <span class=\\\"err-tip\\\" ng-if=\\\"(form.province.$error.required||form.city.$error.required||form.district.$error.required) &&form.$submitted\\\">必填</span></div><div ng-click=\\\"showSearchAddress()\\\">{{addr.street}} <input type=\\\"hidden\\\" name=\\\"street\\\" placeholder=\\\"街道\\\" ng-model=\\\"addr.street\\\" required> <span ng-if=\\\"!addr.street\\\" class=\\\"placeholder\\\">街道</span><err-tip form=\\\"form\\\" name=\\\"street\\\" error=\\\"required\\\">必填</err-tip></div><div><input name=\\\"address\\\" type=\\\"text\\\" minlength=\\\"2\\\" placeholder=\\\"详细地址, 楼层、门牌号\\\" required ng-model=\\\"addr.address\\\"><err-tip form=\\\"form\\\" name=\\\"address\\\" error=\\\"required\\\">必填</err-tip><err-tip form=\\\"form\\\" name=\\\"address\\\" error=\\\"minlength\\\">至少2个字符</err-tip></div></form><div class=\\\"search-address\\\" ng-if=\\\"css.edit && css.showSearchAddress\\\"><form id=\\\"address-form\\\"><div><input type=\\\"text\\\" placeholder=\\\"街道、小区、写字楼、地标名称\\\" id=\\\"address\\\" ng-model=\\\"data.street\\\" ng-model-options=\\\"{debounce: 400}\\\" auto-focus ng-change=\\\"searchAddress()\\\"></div></form><div class=\\\"find-address-tip\\\" ng-if=\\\"data.streetList.length\\\">您要找的是不是?</div><div class=\\\"no-address-tip\\\" ng-if=\\\"data.street && !data.streetList.length\\\"><h4>未能找到此地址</h4><p>建议输入街道、小区、写字楼、地标名称等</p></div><ul class=\\\"results\\\"><li ng-click=\\\"confirmStreet($event, street)\\\" ng-repeat=\\\"street in data.streetList\\\"><h4>{{street.address}}</h4><p>{{street.addressInfoBaidu}}</p></li></ul></div></div>\");\n$templateCache.put(\"confirm.html\",\"<div class=\\\"xw-confirm\\\" ng-click><modal close=\\\"close\\\" show=\\\"showModal\\\" pre-close=\\\"preClose\\\"><div class=\\\"text\\\" ng-transclude></div><div class=\\\"button-group\\\"><span ng-click=\\\"cancel()\\\">取消</span><span ng-click=\\\"confirm()\\\">确定</span></div></modal></div>\");\n$templateCache.put(\"err-tip.html\",\"<span class=\\\"err-tip\\\" ng-if=\\\"(form[name].$dirty||form.$submitted) && form[name].$error[error]\\\" ng-transclude></span>\");\n$templateCache.put(\"geetest-sms-button.html\",\"<div class=\\\"geetest-sms-button-group\\\"><div id=\\\"geetestContainer\\\" ng-show=\\\"state==2\\\"></div><span class=\\\"geetest-sms-button\\\" ng-if=\\\"state <= 1\\\" ng-class=\\\"{invalid: state === 0}\\\" ng-click=\\\"state == 1 && showGeetest()\\\">获取验证码</span> <span class=\\\"geetest-sms-button invalid\\\" ng-if=\\\"state == 3\\\">发送成功 {{remains}}</span> <span ng-click=\\\"state == 5 && showGeetest()\\\" class=\\\"geetest-sms-button\\\" ng-class=\\\"{invalid: state == 4}\\\" ng-if=\\\"state > 3\\\">重新获取</span></div>\");\n$templateCache.put(\"menu-nav.html\",\"<nav class=\\\"menu-nav\\\" ng-class=\\\"{\\'empty\\': !localBag.length}\\\"><div ng-class=\\\"{active: path == \\'/mobile/me\\'}\\\"><a href=\\\"/mobile/me\\\"><span>帐号</span></a></div><div ng-class=\\\"{active: path == \\'/eat\\'}\\\"><a href=\\\"/mobile/#/eat\\\"><span>便当</span></a></div><div ng-class=\\\"{active: path == \\'/cook\\' || !path}\\\"><a href=\\\"/mobile/#/cook\\\"><span>食材包</span></a></div><div class=\\\"go-to-cart\\\" ng-class=\\\"{invalid: !isAddressOk()}\\\" ng-if=\\\"localBag.length\\\" flash-class=\\\"{exp: localBag.length, duration: 400}\\\" ng-click=\\\"isAddressOk({isClick: true}) && goToCart()\\\"><div class=\\\"icon bag-icon\\\"><i class=\\\"number\\\" ng-bind=\\\"localBag.length\\\"></i></div><span class=\\\"price\\\" ng-bind=\\\"localBag.price || 0 | number: 1\\\"></span></div></nav>\");\n$templateCache.put(\"modal.html\",\"<div class=\\\"xw-modal-container\\\" ng-show=\\\"css.show\\\"><div class=\\\"xw-modal-backdrop\\\" ng-click=\\\"close()\\\"></div><div class=\\\"xw-modal-content\\\" ng-transclude></div></div>\");\n$templateCache.put(\"shopping-progress-bar.html\",\"<div class=\\\"shopping-progress-bar\\\"><div class=\\\"states\\\"><span ng-class=\\\"{cur: state == \\'state1\\'}\\\" class=\\\"state1\\\">筛选购物袋</span> <span ng-class=\\\"{cur: state == \\'state2\\'}\\\" class=\\\"state2\\\">确认送货地址</span> <span ng-class=\\\"{cur: state == \\'state3\\'}\\\" class=\\\"state3\\\">支付</span></div><div class=\\\"state-bar-container\\\"><div class=\\\"indicator\\\" ng-class=\\\"state\\\"></div></div></div>\");\n$templateCache.put(\"sms-button.html\",\"<div class=\\\"sms-button-group\\\"><span class=\\\"sms-button\\\" ng-if=\\\"state <= 1\\\" ng-class=\\\"{invalid: state === 0}\\\" ng-click=\\\"state == 1 && getSmsCode()\\\">获取验证码</span> <span class=\\\"sms-button invalid\\\" ng-if=\\\"state == 2\\\">{{remains}}秒后重新获取</span> <span ng-click=\\\"state == 4 && getSmsCode()\\\" class=\\\"sms-button\\\" ng-class=\\\"{invalid: state == 3}\\\" ng-if=\\\"state > 2\\\">重新获取</span></div>\");\n$templateCache.put(\"thanksgiving.html\",\"<div class=\\\"thanksgiving\\\"><modal default=\\\"show\\\" ng-click=\\\"close()\\\" close=\\\"close\\\"><div class=\\\"thanksgiving-main\\\">全周好品味，新味感谢您!</div></modal></div>\");}]);\nangular.module('xw.weixin').factory('Weixin',[\"$http\", \"Debug\", function ($http, Debug) {\n\n    var defaults = {\n        //weixin js config\n        wx: {\n            appId: 'wx37a1323e488cef84',\n            jsApiList: ['getLocation', 'onMenuShareTimeline', 'onMenuShareAppMessage']\n        },\n\n        // xinwei location, gcj02\n        location: {\n            longitude: 121.460625,\n            latitude: 31.189426\n        },\n\n        ak: 'xnKgWtGYXf4gkLgreox7xpjI',\n\n        oauthUrl: '/api/orders/payment/weixinpay/oauthcode?orderid='\n    };\n\n    return {\n        isWeixin: /MicroMessenger/i.test(navigator.userAgent),\n\n        oauthUrl: defaults.oauthUrl,\n\n        readyState: false,\n\n        // 微信的事后ready似乎不好用，连个详细的文档都没有，还是自己实现靠谱。\n        ready: function (cb) {\n            if (this.readyState) {\n                cb();\n            } else this.ready.cb = cb;\n        },\n        /**\n         * set jsapi config\n         * @param setting\n         */\n        config: function (setting) {\n            var that = this;\n            var _setting = angular.copy(defaults.wx);\n            _setting.timestamp = setting.timestamp;\n            _setting.nonceStr = setting.nonceStr; // todo: be careful to different backend returned data.\n            _setting.signature = setting.signature;\n\n            wx.config(_setting);\n\n            wx.ready(function() {\n                that.ready.cb && that.ready.cb();\n                that.readyState = true;\n            });\n        },\n        /**\n         * @param success - success callback with {lat: . lng: .} arguemnt\n         * @param fail - fail callback with unknown arguemnt\n         */\n        getLocation: function(success, fail) {\n            var setting = {type: 'gcj02'};\n            success && (setting.success = success);\n            fail && (setting.fail = fail);\n            wx.getLocation(setting);\n        },\n\n        /**\n         * 同微信分享朋友圈接口http://mp.weixin.qq.com/wiki/7/aaa137b55fb2e0456bf8dd9148dd613f.html#.E8.8E.B7.E5.8F.96.E2.80.9C.E5.88.86.E4.BA.AB.E5.88.B0.E6.9C.8B.E5.8F.8B.E5.9C.88.E2.80.9D.E6.8C.89.E9.92.AE.E7.82.B9.E5.87.BB.E7.8A.B6.E6.80.81.E5.8F.8A.E8.87.AA.E5.AE.9A.E4.B9.89.E5.88.86.E4.BA.AB.E5.86.85.E5.AE.B9.E6.8E.A5.E5.8F.A3\n         * @param settings\n         */\n        shareTimeline: function (settings) {\n            wx.onMenuShareTimeline(settings);\n        },\n\n        shareAppMessage: function (settings) {\n            wx.onMenuShareAppMessage(settings);\n        },\n\n        showOptionMenu: function () {\n            wx.showOptionMenu();\n        },\n\n        hideOptionMenu: function () {\n            wx.hideOptionMenu();\n        },\n\n        /**\n         * get location with baidu api\n         * @param lat - gcj02\n         * @param lng\n         * @return promise will resolved with $http res.\n         */\n        getLocationName: function (lat, lng) {\n            var mapUrl = 'http://api.map.baidu.com/geocoder/v2/?output=json&pois=1&coordtype=gcj02ll&callback=JSON_CALLBACK'\n            return $http.jsonp(mapUrl, {\n                params: {\n                    ak: defaults.ak,\n                    location: lat + ',' + lng\n                }\n            })\n        },\n        /**\n         * 获取jsconfig 参数\n         * @param url\n         * @returns {HttpPromise}\n         */\n        getJsconfig: function () {\n            return $http.post('/api/orders/payment/weixinpay/config', {\n                url: location.href.substr(0, location.href.length - location.hash.length)\n            });\n        }\n    }\n}]);\nangular.module('xw.services').factory('Alert', function () {\n    var codeMsg = {\n        1110: '手机号码或密码错误',\n        1111: '手机号码或密码错误',\n        1112: '该用户已存在',\n        1113: '手机号码或密码错误',\n\n        2110: '手机号码错误',\n\n        3110: '短信码错误',\n        3111: '短信码已过期',\n        3112: '无效的短信码',\n        3113: '错误的短信码类型',\n        3114: '短信码验证次数过多, 请重新接收短信码',\n        3115: '发送失败, 请稍后重试',\n        3116: '短信码发送次数达到当日最大次数',\n\n        4110: '库存不足',\n\n        5110: '尚未到充值码使用时间',\n        5111: '优惠码/优惠券已过期',\n        5112: '优惠码/优惠券已被使用',\n        5113: '超出优惠码/优惠券最大使用次数',\n        5121: '只能兑换一次朋友的邀请码(无论是否是同一个朋友), 您已经兑换过一次了'\n    };\n\n    return {\n        show: function (code, def) {\n            var msg = codeMsg[code];\n            if (msg) alert(msg);\n            else if (def) alert(def);\n        },\n        message: function (code) {\n            return codeMsg[code] || '';\n        }\n    }\n})\n\nangular.module('xw.services').provider('Debug', function () {\n    var that = this;\n    that.debugKey = 'debug';\n\n    this.$get = [\"Utils\", function (Utils) {\n        var isDebug = new RegExp('\\\\b' + that.debugKey + '\\\\b');\n        var fakeWarehouse = '';\n        var searches = Utils.searches(location.search);\n        isDebug = isDebug.test(location.search) || !!sessionStorage.getItem('debug');\n\n        if (isDebug && !sessionStorage.getItem('debug')) {\n            sessionStorage.setItem('debug', 'true');\n        }\n        if (isDebug) {\n            if ('fakewarehouse' in searches) {\n                fakeWarehouse = searches.fakewarehouse;\n            }\n        }\n\n        var ret = {\n            //默认根据查询参数中到是否出现debug参数来判断\n            isDebug: isDebug,\n            alert: function (val) {\n                if (this.isDebug) {\n                    console.log(val); // todo:怎么判断log是否有效?如果有效,似乎就没有多大必要调用alert了.\n                    val = Object.prototype.toString.call(val) == \"[object Object]\"\n                        ? JSON.stringify(val) : val;\n                    alert(val);\n                }\n            },\n            assert: function (express, sval) {\n                if (this.isDebug) {\n                    !express && alert(sval);\n                }\n            },\n            promiseErrFn: function (msg) {\n                return function(res) {\n                    ret.alert(msg);\n                    ret.alert(res);\n                }\n            },\n            fakeWarehouse: fakeWarehouse\n        };\n        \n        return ret\n    }]\n});\nangular.module('xw.services').factory('Map', [\"$http\", \"Debug\", function ($http, Debug) {\n    // 如果有必要修改则需要改成provider\n    var topDistance = {\n        xinweioffice: 6000,\n        caohejing1: 1560\n    };\n\n    var map = {\n        bentoNoReach: 999999,\n\n        topDistance: {\n            xinweioffice: 6000,\n            caohejing1: 1560\n        },\n\n        suggestion: function (query, region) {\n            return $http.get('/mobile/placesuggestion?query=' + query + '&region=' + region)\n        },\n\n        search: function (query, region) {\n            return $http.post('/api/user/address/suggestion', {query:query, region:region})\n        },\n\n        // 坐标转化\n        // https://github.com/JackZhouCn/JZLocationConverter/\n        gcj02ToBd09: function (location) {\n            var y = location.lat;\n            var x = location.lng;\n            var z = Math.sqrt(x * x + y * y) + 0.00002 * Math.sin(y * Math.PI);\n            var theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * Math.PI);\n\n            return {\n                lng: z * Math.cos(theta) + 0.0065,\n                lat: z * Math.sin(theta) + 0.006\n            }\n        },\n\n        // 在调用百度suggestion api后会用到\n        bd09ToGcj02: function (location) {\n            var y = location.lat - 0.006;\n            var x = location.lng - 0.0065;\n            var z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * Math.PI);\n            var theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * Math.PI);\n\n            return {\n                lng: z * Math.cos(theta),\n                lat: z * Math.sin(theta)\n            }\n        },\n\n        //根据坐标计算直线距离\n        //https://github.com/googollee/eviltransform\n        lineDistance: function (latA, lngA, latB, lngB) {\n            var earthR = 6371000;\n            var x = Math.cos(latA * Math.PI / 180) * Math.cos(latB * Math.PI / 180) * Math.cos((lngA - lngB) * Math.PI / 180);\n            var y = Math.sin(latA * Math.PI / 180) * Math.sin(latB * Math.PI / 180);\n            var s = x + y;\n            if (s > 1) {\n                s = 1;\n            }\n            if (s < -1) {\n                s = -1;\n            }\n            var alpha = Math.acos(s);\n            return alpha * earthR;\n        },\n\n        lineDistance2CHJ: function (lat, lng) {\n            var CHJ = this.warehouseCoords.caohejing1;\n            return this.lineDistance(lat, lng, CHJ.lat, CHJ.lng)\n        },\n\n        fixZero: function (d, lat, lng) {\n            if (d !== 0) return d;\n            var lineD = this.lineDistance(lat, lng, 31.189426, 121.460625);\n            return lineD > 1500 ? 999999 : d;\n        },\n\n        /**\n         * 对百度地图routematrix api的后端包装,此处原样返回百度的数据\n         * @param lat gcj02坐标 | [sval, obj, ..]\n         * @param lng\n         * @param warehouse\n         * @returns {HttpPromise}\n         */\n        walkingDistance: function (lat, lng, warehouse) {\n            var args;\n            warehouse = warehouse || '';\n            if (Array.isArray(arguments[0])) {\n                args = arguments[0];\n                warehouse = lng;\n            } else {\n                args = [{lat: lat, lng: lng}];\n            }\n\n            var sval = '';\n            args.forEach(function (arg, i) {\n                if (i >= 5) return; //百度限制\n                var prefix = i == 0 ? '' : '|';\n                if (typeof arg == 'string') {\n                    sval += prefix + arg;\n                } else {\n                    sval += prefix + arg.lat + ',' + arg.lng;\n                }\n            });\n\n            return $http.get('/mobile/distance?destinations=' +\n                encodeURIComponent(sval) + '&warehouse=' + warehouse)\n            .then(function (res) {\n                    var results = res.data.result.elements;\n                    var ret = [];\n                    var len = results.length / 2;\n                    var pair;\n                    for (var i = 0; i < len; i++) {\n                        results[i].warehouse = 'xinweioffice';\n                        results[len + i].warehouse = 'caohejing1';\n                        pair = [results[i], results[len + i]];\n                        pair = angular.sort(pair, function (a, b) {\n                            return (a.distance.value - topDistance.xinweioffice) -\n                                (b.distance.value - topDistance.caohejing1)\n                        });\n                        ret.push(pair);\n                    }\n                    return ret;\n                })\n            .catch(function () {\n                    console.log('get distance error');\n                    return []\n                })\n        },\n\n        /**\n         * 计算距离仓库的距离\n         * @param lat gcj02\n         * @param lng gcj02\n         * @param warehouse - 'CHJ'\n         * @returns {*|Promise.<T>}\n         */\n        distance: function (lat, lng, warehouse) {\n            return this.walkingDistance(lat, lng, warehouse).then(function (res) {\n                var d = res[0][0].distance.value;\n                d = map.fixZero(d, lat, lng);\n                var top = topDistance[res[0][0].warehouse];\n                return {\n                    distance: d,\n                    // 百度有时候返回的是null, 此时就当作1000公里\n                    isInRange: (d === null ? 999999 : d) <= top,\n                    warehouse: res[0][0].warehouse\n                }\n            }).catch(function (res) {\n                Debug.alert('获取步行距离失败');\n                Debug.alert(res);\n            })\n        },\n\n        distances: function (dests, warehouse) {\n            dests = Array.isArray(dests) ? dests : [dests];\n            return this.walkingDistance(dests, warehouse).then(function (res) {\n                return res.map(function (el, i) {\n                    var d = map.fixZero(el[0].distance.value, dests[i].lat, dests[i].lng);\n                    var top = topDistance[el[0].warehouse];\n                    return {\n                        distance: d,\n                        isInRange: (d === null ? 999999 : d) <= top,\n                        warehouse: el[0].warehouse\n                    }\n                })\n            })\n        },\n\n        nearestWarehouse: function (lat, lng) {\n            var that = this;\n            var topDistance2HQ = topDistance['xinweioffice'];\n            var topDistance2CHJ = topDistance['caohejing1'];\n            var warehouses = angular.sort(['xinweioffice', 'caohejing1'].map(function (name) {\n                var warehouse = that.warehouseCoords[name];\n                return {\n                    name: name,\n                    distance: that.lineDistance(lat, lng, warehouse.lat, warehouse.lng)\n                }\n            }), function (a, b) {\n                return (a.distance - topDistance2HQ + 1100) - (b.distance - topDistance2CHJ)\n            });\n\n            if (Debug.fakeWarehouse) {return Debug.fakeWarehouse}\n            return warehouses[0].name;\n\n        },\n\n        warehouseCoords: {\n            xinweioffice: {\n                lat: 31.189426,\n                lng: 121.460625\n            },\n            caohejing1: {\n                lat: 31.169250,\n                lng: 121.398949\n            }\n        }\n    };\n\n    return map;\n}]);\n\nangular.module('xw.services').factory('ScopeDecorator', [\"$location\", function ($location) {\n    return {\n        common: function (scope) {\n            if (!scope) return;\n            scope.back = function () {\n                if (history.length > 1) history.back();\n                else location.href = '/mobile/'\n            }\n        },\n        nav: function (scope) {\n            if (!scope) return;\n            scope.$on('$locationChangeStart', function () {\n                scope.path = $location.path();\n            });\n        }\n    }\n}]);\nangular.module('xw.services').factory('Utils', [\"$localStorage\", function ($localStorage) {\n    return {\n        // todo: base64编码后的字符包括大小写字母各26各,以及数字,以及 + / = 这3个字符\n        // 而 +(这个...) 和 / 在url中会被转义,因此需要再做替换,这里替换 + 为 - , / 替换为 _\n        utf2b64: function (str) {\n            return btoa(unescape(encodeURIComponent(str))).replace(/\\+/g, '-').replace(/\\//g, '_');\n        },\n        b642utf: function (str) {\n            return decodeURIComponent(escape(window.atob(str.replace(/-/g, '+').replace(/_/g, '/'))));\n        },\n\n        // 两个购物车item是否是同一个,购物车item结构为:{dish:dish, number:, subDish:[]}\n        isSameItemInCart: function (item1, item2) {\n            return item1.dish._id == item2.dish._id && //主dish是否相同\n                item1.subDish.every(function (a) { //子dish是否全部相同\n                    return item2.subDish.some(function (b) {\n                        return a.dish._id == b.dish._id\n                    })\n                }) && item1.subDish.length == item2.subDish.length;\n        },\n\n        // 合并本地购物车和线上购物车, 将数据全部合并到本地购物车.\n        // local dish的数量(非dish.number)只会增加不会减少\n        mergeCarts: function (local, server) {\n            if (!local || !local.length) return server;\n            var that = this;\n            for (var i = 0; i < server.length; i++) {\n                var notInLocal = local.every(function (lDish) {\n                    return !that.isSameItemInCart(lDish, server[i])\n                });\n                if (notInLocal)\n                   local.push(server[i]);\n            }\n            return local;\n        },\n\n        /**\n         * 从/api/dishes获取到dish列表中抽取上线且有货的子属性菜品\n         * @param dishList [{_id:., outOfStock: ., ..}]\n         * @param type - 'main', or 'preference'\n         * @returns [24位id, ..] 最小化localStorage的存储成本.(也许取末几位就可以)\n         */\n        getStockId: function (dishList, type) {\n            var idStockMap = {};\n            if (type == 'preference') {\n                dishList.forEach(function (dish) {\n                    dish.preferences.forEach(function (p) {\n                        p.foodMaterial.forEach(function (f) {\n                            if (!idStockMap[f.dish._id] && f.dish.isPublished) {\n                                idStockMap[f.dish._id] = true;\n                            }\n                        })\n                    })\n                });\n            } else {\n                dishList.forEach(function (dish) {\n                    if (!idStockMap[dish._id] && !dish.outOfStock) {\n                        idStockMap[dish._id] = true;\n                    }\n                })\n            }\n\n            return Object.keys(idStockMap);\n        },\n\n        /**\n         * localStorage实在是太大了,去掉多余的信息,只保留必要的信息.这些必要掉信息需要手动清除\n         */\n        cleanLocalStorage: function () {\n            var remain = [ 'promotion', 'access_token', 'selectedAddress'];\n            Object.keys($localStorage).forEach(function (key) {\n                if (remain.indexOf(key) == -1 && key[0] != '$') {\n                    delete $localStorage[key];\n                }\n            })\n        },\n\n        /**\n         * 接收'?a=1&b=&c'这样的查询字符串,输出:{a:1, b:'', c: ''}\n         * @param search - 如果没有则使用location.search\n         * @returns {*}\n         */\n        searches: function (search) {\n            search = search || location.search;\n            return search.slice(1).split('&').reduce(function (obj, cur) {\n                if (cur) {\n                    cur = cur.split('=');\n                    obj[cur[0]] = decodeURIComponent(cur[1] || '');\n                }\n                return obj;\n            }, {});\n        },\n\n        /**\n         * 确认两个地址是否相同,比如上海和上海市应该是相同的\n         * @param addr1\n         * @param addr2\n         * @returns {boolean}\n         */\n        addressEqual: function (addr1, addr2) {\n            addr1 = addr1 || '';\n            addr2 = addr2 || '';\n            if (!addr1 || !addr2) return false;\n            return !addr1.indexOf(addr2) || !addr2.indexOf(addr1)\n        },\n\n        /**\n         * 将老地址中的`徐汇`之类的转换成新地址的`徐汇区`\n         * @param address - {province:.., city: .., district: ..}\n         * @param ref - [从服务端拉取的地址数组, /api/../range]\n         */\n        regularizeAddress: function (address, ref) {\n            var cities, districts;\n            var equal = this.addressEqual;\n            ref.some(function (state) {\n                if (equal(address.province, state.state)) {\n                    address.province = state.state;\n                    cities = state.cities;\n                    return true;\n                }\n            });\n\n            cities && cities.some(function (city) {\n                if (equal(address.city, city.city)) {\n                    address.city = city.city;\n                    districts = city.areas;\n                    return true;\n                }\n            });\n\n            districts && districts.some(function (district) {\n                if (equal(address.district, district)) {\n                    address.district = district;\n                    return true;\n                }\n            });\n\n            return address\n        },\n\n        /**\n         * 基于服务端传回的配送范围数据,以空,或省,或市为参数来查询相应的子地区列表\n         * @example call('浙江') - return ['杭州市', '宁波市', ..]; call(), - ret[全国省]\n         * @param addresses - 服务端范围数据 /api/../range\n         * @param province\n         * @param city\n         * @returns []\n         */\n        addressOptions: function (addresses, province, city) {\n            var len = arguments.length;\n\n            if (len == 1) {\n                return addresses.map(function (el) {return el.state})\n\n            } else if (len == 2) {\n                if (!province) return;\n                //这里可以将结果缓存起来, 以节省len == 2时(以及以后可能相同)的多余计算\n                return addresses.filter(function (el) {\n                    return el.state == province\n                })[0].cities.map(function (el) {\n                        return el.city;\n                    })\n\n            } else if (len == 3) {\n                if (!city) return;\n                var cities = addresses.filter(function(el) {\n                    return el.state == province\n                })[0].cities.filter(function (el) {\n                        return el.city == city\n                    })\n                if (cities && cities.length) {\n                    return cities[0].areas\n                }\n            }\n        },\n\n        stockOfDish: function (dish, warehouse) {\n            return dish.stockWarehouse.some(function (item) {\n                return item.warehouse == warehouse && item.stock > 0;\n            })\n        },\n\n        /**\n         * 例如购物中的item {dish: {}, subDish: [..]}\n         * @param item\n         * @param warehouse\n         */\n        stockOfItem: function (item, warehouse) {\n            var stockOfDish = this.stockOfDish;\n            return stockOfDish(item.dish, warehouse) && !!item.subDish && item.subDish.every(function (el) {\n                    return stockOfDish(el.dish, warehouse)\n                })\n        }\n    }\n}]);\nangular.module('xw.directives').directive('addDishBar', [\"Debug\", \"User\", \"$localStorage\", \"$filter\", \"Utils\", function (Debug, User, $localStorage, $filter, Utils) {\n    return {\n        scope: {\n            dish: '=',\n            user: '=',\n            localBag: '='\n        },\n        templateUrl: 'add-dish-bar.html',\n        link : function ($scope) {\n            var storage = $scope.storage = $localStorage;\n            var localBag = $scope.localBag = [];\n\n            var unwatcher = $scope.$watch('user', function (user) {\n                if (user) {\n                    unwatcher();\n\n                    $scope.localBag = localBag = Utils.mergeCarts(localBag\n                        , user.shoppingCart.filter(function (item) {\n                            return !!item.dish\n                        }));\n                    $scope.totalPrice();\n                }\n            });\n\n            $scope.$watch('dish', function (dish) {\n                if (dish) {\n                    var curSelection = {};\n                    $scope.dish.preferences.forEach(function (property) {\n                        property.foodMaterial.forEach(function (el) {\n                            el.outOfStock = !(el.dish.stockWarehouseObj[storage.warehouse] > 0 || el.dish.cookingType == 'ready to cook')\n                        })\n                        property.foodMaterial.some(function (el) {\n                            if (!el.outOfStock) {\n                                curSelection[property.name.zh] = el.dish;\n                                return true;\n                            } else return false;\n                        })\n                    });\n                    // dish.curSelection存储多属性下的各选中dish,\n                    // 是一个以各属性名为key, 属性下的某个有货dish为value对象\n                    // (尽管一个属性下有可能多个有货dish,但当前选中但只有一个dish)\n                    $scope.dish.curSelection = curSelection;\n                }\n            });\n\n            /**\n             * @param dish 此dish同$scope.dish\n             */\n            $scope.addToCart = function (dish) {\n                var selection = dish.curSelection;\n                var newEntry = {\n                    dish: dish,\n                    number: dish.count,\n                    subDish: Object.keys(selection).map(function (key) {\n                        return {\n                            dish: selection[key],\n                            number: dish.count\n                        };\n                    })\n                };\n\n                // 存在与cart中的与dish的id相同的dish wrapper\n                // - {dish: dish, number:number, subDish: []}\n                var entry;\n\n                localBag.some(function (item) {\n                    if (Utils.isSameItemInCart(item, newEntry)) {\n                        entry = item;\n                        entry.number += newEntry.number;\n                        entry.subDish.forEach(function (sDish) {\n                            sDish.number = entry.number;\n                        });\n                        return true;\n                    }\n                });\n\n                if (!entry) {\n                    localBag.push(newEntry);\n                }\n\n                dish.count = 0;\n\n                $scope.hide();\n\n                User.postCart(localBag.filter(function(item){return !!item.dish}).map(postDishFilter));\n\n                $scope.totalPrice();\n            };\n\n            var postDishFilter = $filter('postDish');\n\n            $scope.totalPrice = function () {\n                var p = localBag.filter(function(item){return !!item.dish}).reduce(function price(total, cur) {\n                    total += cur.dish.priceOriginal * cur.number;\n                    if (cur.subDish) {\n                        total += cur.subDish.reduce(price, 0)\n                    }\n                    return total;\n                }, 0);\n                return localBag.price = p;\n            };\n\n            $scope.totalPrice();\n\n            $scope.hide = function () {\n                $scope.dish = null;\n            };\n\n        }\n    }\n}])\nangular.module('xw.directives').directive('addressList', [\"$q\", \"Alert\", function ($q, Alert) {\n    return {\n        restrict: 'E',\n        scope: {\n            // 外部传入的数据\n            addresses: '=', // 待编辑的地址, 如果为空, 则表示是新地址\n            range: '=', // 省市区数据\n            watchAddress: '=save',\n            editing: '=',\n            hideOthersWhenEdit: '@'\n        },\n        templateUrl: 'address-list.html',\n        link: function ($scope) {\n            var data = $scope.data = {\n                newAddress: {}\n            };\n\n            // 引用地址指令的内部函数\n            var handler = $scope.handler = {\n                save: [],\n                leave: [],\n                valid: []\n            };\n\n            $scope.hideAddress = function (idx) {\n                if ($scope.hideOthersWhenEdit == 'true' && $scope.addresses) {\n                    var editIdx = -1;\n\n                    if ($scope.data.newAddress.edit) {\n                        editIdx = -2;\n                    }\n                    editIdx == -1 && $scope.addresses.some(function (addr, i) {\n                        if (addr.edit) {\n                            editIdx = i;\n                            return true;\n                        }\n                    });\n                    return editIdx != -1 && idx != editIdx;\n                }\n            };\n\n            $scope.editing = function () {\n                if (!$scope.addresses) return false;\n                return !!data.newAddress.edit\n                    || $scope.addresses.some(function (addr) {\n                        return addr.edit;\n                    })\n            };\n\n            $scope.remove = function (idx) {\n                $scope.addresses.splice(idx, 1);\n                handler.save.splice(idx, 1);\n                handler.leave.splice(idx, 1);\n                handler.valid.splice(idx, 1);\n            };\n\n            // 此处监听发生在cur地址指令之外的click.\n            // (如果是在cur指令上发生的click,则交给cur指令自己处理,此处忽略即可)\n            // 这些click表明可能需要保存cur地址指令的数据(如果cur地址指令正处在edit阶段)\n            // 并且需要切换地址指令们的cur状态\n            $scope.watchAddress = function (event) {\n                var target = event.target;\n                var parent = target, cur;\n                // 是否是从address指令上产生的click事件,如果是则定位其序号.\n                do {\n                    if (parent.className.indexOf('address-item') != -1) {\n                        var addressNodes = parent.parentElement.children;\n                        for (var i = 0, len = addressNodes.length; i < len; i++) {\n                            if (addressNodes[i] == parent) {\n                                cur = i;\n                                break;\n                            }\n                        }\n                    }\n                } while (parent = parent.parentElement);\n\n                // 从addresses数据中找出正在处在编辑状态的地址序号\n                var editIdx = -1;\n                var curIdx = -1;\n                $scope.addresses.forEach(function (address, i) {\n                    if (address.edit) {\n                        editIdx = i;\n                    }\n                    if (address.cur) {\n                        curIdx = i;\n                    }\n                });\n\n                // 忽略从cur指令上产生的click事件.\n                if (cur == curIdx ||\n                    (cur == $scope.addresses.length && data.newAddress.cur))\n                    return;\n\n                // 保存\n                var promise;\n                if (editIdx != -1) {\n                    if (handler.valid[editIdx]()) {\n                        promise = handler.save[editIdx]()\n                    } else {\n                        // 阻止离开当前地址指令,并阻止其他地址指令响应click事件.\n                        return event.stopPropagation();\n                    }\n                } else if (data.newAddress.edit) {\n                    if (handler.valid.newAddress()) {\n                        promise = handler.save.newAddress().then(function (address) {\n                            $scope.addresses.push(address);\n                            data.newAddress = {};\n                            return address;\n                        }).catch(function (res) {\n                            Alert.show(res.data.validationStatus, '保存失败');\n                        });\n                    } else {\n                        return event.stopPropagation();\n                    }\n                }\n\n                // 离开\n                if (curIdx != -1) {\n                    handler.leave[curIdx]();\n                    if (editIdx == -1)\n                        promise = $q.resolve($scope.addresses[curIdx]);\n                } else if (data.newAddress.cur) {\n                    handler.leave.newAddress();\n                }\n\n                // 如果是保存那这就是promise,否则不是.\n                return promise;\n            };\n        }\n    }\n}]);\n\nangular.module('xw.directives').directive('addressSelection', function () {\n    return {\n        restrict: 'E',\n        scope: {\n            animateTrigger: '=',\n            show: '=',\n            address: '=',\n            noAddress: '=',\n            dishId: '@',\n            path: '@'\n        },\n        templateUrl: 'address-selection.html'\n    }\n});\nangular.module('xw.directives').directive('address', [\"$timeout\", \"$location\", \"Address\", \"Utils\", \"$q\", \"Weixin\", \"Map\", \"Alert\", function ($timeout, $location, Address, Utils, $q, Weixin, Map, Alert) {\n    return {\n        restrict: 'E',\n        scope: {\n            // 外部传入的数据\n            outAddress: '=', // 待编辑的地址, 如果为空, 则表示是新地址\n            range: '=', // 省市区数据\n\n            // 供外部调用的方法\n            save: '=',\n            leave: '=',\n            valid: '=',\n\n            // 需要调用的外部方法\n            deleteHook: '&', // 当删掉当前地址后给予外部的回调接口\n            hide: '&', // 接收隐藏条件\n\n            // 是否为当前状态地址的默认参数.\n            cur: '@'\n        },\n        templateUrl: 'address.html',\n        link: function ($scope) {\n            var addr;\n\n            var css = $scope.css = {\n                edit: false,\n                cur: $scope.cur == \"true\",\n                showSearchAddress: false,\n                form: null,\n                locating: false,\n                isWeixin: Weixin.isWeixin,\n                isNewAddress: Object.keys($scope.outAddress).length < 2\n            };\n\n            var data = $scope.data = {\n                street: ''\n            };\n\n            // 如果没有一个外部传入的地址,那么这是一个新地址\n            // <2 for angular\n            if (css.isNewAddress) {\n                addr = $scope.addr = {sortOrder: 0};\n                if (css.cur) {\n                    css.edit = true;\n                }\n            } else {\n                addr = $scope.addr = Utils.regularizeAddress(\n                    angular.copy($scope.outAddress), $scope.range);\n            }\n\n            $scope.outAddress.cur = css.cur;\n            $scope.outAddress.edit = !!css.edit;\n\n            $scope.options = Utils.addressOptions.bind(null, $scope.range);\n\n            $scope.$on('$locationChangeStart', function () {\n                if (!css.edit) return;\n                var path = $location.path();\n                css.showSearchAddress = path == '/search-address'\n            });\n\n            $scope.choose = function () {\n                if (css.cur) {\n                    css.edit = true;\n                    $scope.outAddress.edit = true;\n                } else {\n                    css.cur = true;\n                    // 如果这是一个新地址\n                    if (css.isNewAddress) {\n                        css.edit = true;\n                        $scope.outAddress.edit = true;\n                    }\n                }\n                $scope.outAddress.cur = true;\n            };\n\n            $scope.trySelectUnique = function () {\n                var cities = $scope.options(addr.province);\n                if (cities.length == 1) {\n                    addr.city = cities[0];\n                }\n            };\n\n            $scope.deleteAddress = function (event) {\n                event.stopPropagation();\n\n                Address.delete(addr._id);\n                if ($scope.deleteHook) {\n                    $scope.deleteHook();\n                }\n            };\n\n            $scope.showSearchAddress = function () {\n                data.street = addr.street;\n                $location.path('search-address');\n                $scope.data.streetList && ($scope.data.streetList.length = 0);\n                $scope.searchAddress();\n            };\n\n            $scope.searchAddress = function () {\n                if (data.street) {\n                    Map.search(data.street, addr.city || '全国')\n                        .then(function (res) {\n                            $scope.data.streetList = res.data;\n                        });\n                }\n            };\n\n            $scope.confirmStreet = function (event, street) {\n                event.stopPropagation();\n\n                $location.path('');\n                if (!street) return;\n\n                addr.street = street.address;\n                addr.geoLatitude = street.lat;\n                addr.geoLongitude = street.lng;\n            };\n\n            $scope.save = function () {\n                if (css.form.$invalid) return $q.resolve(false);\n\n                css.edit = css.cur = false;\n                $scope.outAddress.edit = $scope.outAddress.cur = false;\n\n                addr.isDefault = true;\n                return Address[!css.isNewAddress ? 'update' : 'addOne'](addr)\n                .then(function (res) {\n                        addr = $scope.addr = res.data;\n                        $scope.outAddress.cur = css.cur = true;\n                        angular.extend($scope.outAddress, res.data);\n                        return res.data;\n                    });\n            };\n\n            $scope.leave = function () {\n                $scope.outAddress.cur = css.cur = false;\n            };\n\n            // 会设置form$submitted为true\n            $scope.valid = function () {\n                css.form.$submitted = true;\n                return !css.form.$invalid;\n            };\n\n            $scope.initForm = function (form) {\n                css.form = form;\n                css.showFakeInput = !addr.province;\n            };\n\n            // todo:必须要先在外部调用Weixin.config,或许内部也用一个后备?\n            $scope.locate = function (event) {\n                event.stopPropagation();\n\n                css.locating = true;\n\n                Weixin.getLocation(function (res) {\n\n                    //console.log(\"weixinGeo:\", res);\n\n                    Weixin.getLocationName(res.latitude, res.longitude).then(function (data) {\n\n                        //console.log(\"baiduGeo:\", data.data);\n\n                        var result = data.data.result;\n                        result = angular.pick(result.addressComponent, 'province', 'city', 'district', 'street', 'street_number');\n                        var location = Map.gcj02ToBd09({\n                            lat: res.latitude,\n                            lng: res.longitude\n                        });\n                        result.geoLatitude = location.lat;\n                        result.geoLongitude = location.lng;\n\n                        Utils.regularizeAddress(result, $scope.range);\n\n                        angular.extend(addr, result);\n\n                    }).catch(angular.noop).then(function () {\n                        css.locating = false; // like finally\n                    });\n                }, function () {\n                    css.locating = false;\n                });\n            };\n\n        }\n    };\n}]);\n\nangular.module('xw.directives').directive('autoFocus', function () {\n    return {\n        restrict: 'A',\n        link: function (scope, el) {\n            setTimeout(function () {\n                el[0].focus();\n            }, 100);\n        }\n    }\n});\nangular.module('xw.directives').directive('backButton', function () {\n    return {\n        template: '<div class=\"back-icon\" ng-click=\"back()\"></div>',\n        link: function ($scope) {\n            // 有些路径需要直接调用 navigator.back(), 有些路径\n            $scope.back = function () {\n                if (history.length <= 1) location.href = '/mobile/';\n                history.back();\n            }\n        }\n    }\n})\nangular.module('xw.directives').directive('captureClick',[\"$parse\", \"$rootScope\", function($parse, $rootScope) {\n    /**\n     * 监听capture阶段的事件\n     * ng-click不支持capture阶段的事件监听,因为和jquery兼容的jqlite不支持.(jquery不支持是因为ie9以下只有冒泡)\n     * 基于以下修改:https://github.com/angular/angular.js/blob/master/src/ng/directive/ngEventDirs.js\n     */\n    return {\n        restrict: 'A',\n        compile: function($element, attr) {\n            var fn = $parse(attr.captureClick, /* interceptorFn */ null, /* expensiveChecks */ true);\n            return function ngEventHandler(scope, element) {\n                element[0].addEventListener('click', function (event) {\n                    var callback = function() {\n                        fn(scope, {$event:event});\n                    };\n                    if ($rootScope.$$phase) {\n                        scope.$evalAsync(callback);\n                    } else {\n                        scope.$apply(callback);\n                    }\n                }, true);\n            };\n        }\n    };\n}])\nangular.module('xw.directives').directive('confirm', [\"$q\", function ($q) {\n    return {\n        restrict: 'E',\n        transclude: true,\n        scope: {\n            show: \"=\"\n        },\n        templateUrl: 'confirm.html',\n        link: function (scope) {\n            var deferred;\n            scope.show = function () {\n                deferred = $q.defer();\n                scope.showModal();\n                return deferred.promise;\n            };\n\n            scope.confirm = function () {\n                scope.close(true);\n                deferred.resolve(true);\n            };\n\n            scope.cancel = function () {\n                scope.close();\n            };\n\n            scope.preClose = function () {\n                deferred.resolve(false);\n            }\n        }\n    }\n}]);\nangular.module('xw.directives').directive('couponCode', [\"Coupon\", \"$q\", function (Coupon, $q) {\n    return {\n        restrict: 'A',\n        scope: {\n            couponPrice: '=couponCode',\n            couponCodeType: '='\n        },\n        require: '?ngModel',\n        link: function (scope, el, attrs, ngModel) {\n            if (!ngModel) return;\n\n            ngModel.$asyncValidators.couponCode = function (mValue, vValue) {\n                var value = mValue || vValue;\n\n                if (!value) return $q.resolve(1);\n\n                value = value.length == 8 ? 'zz' + value : value;\n\n                return Coupon.getCouponInfo(value).then(function (res) {\n                    var coupon = res.data;\n                    var now = new Date(res.headers('date'));\n                    var startDate = new Date(coupon.startDate);\n                    var endDate = new Date(coupon.endDate);\n                    // todo: check price limit\n                    if (startDate <= now && now <= endDate) {\n                        if (coupon.couponType == \"promocodepercentage\") {\n                            scope.couponCodeType = 'promocodepercentage'\n                        }\n                        scope.couponPrice = coupon.price;\n                        // todo: 价格限制\n                    } else {\n                        return $q.reject('未在可使用期限内');\n                    }\n                })\n            }\n        }\n    }\n}]);\nangular.module('xw.directives').directive('errTip', function () {\n    return {\n        scope: {\n            form: '=',\n            error: '@',\n            name: '@'\n        },\n        transclude: true,\n        templateUrl: 'err-tip.html'\n    }\n})\nangular.module('xw.directives').directive('flashClass', function () {\n    return {\n        restrict: 'A',\n        scope: {options: '=flashClass'},\n        link: function (scope, el) {\n            var time = scope.options.duration || 700;\n            var className = scope.options.className || 'flash';\n            scope.$watch('options.exp', function (newVal) {\n                if (newVal) {\n                    setTimeout(function () {\n                        el.addClass(className);\n                        setTimeout(function () {\n                            el.removeClass(className)\n                        }, time)\n                    }, 200)\n                }\n            })\n        }\n    }\n});\nangular.module('xw.directives').directive('geetestSmsButton', [\"Debug\", \"User\", \"$interval\", \"$window\", \"Alert\", \"$http\", function (Debug, User, $interval, $window, Alert, $http) {\n    return {\n        scope: {\n            valid: '@',\n            mobile: '@',\n            type: '@',\n            triggered: '='\n        },\n        templateUrl: 'geetest-sms-button.html',\n        link : function (scope) {\n            $http.get('/api/user/signup/geetest/register').success(function(result) {\n                var s = document.createElement('script');\n                var params = {\n                    //'745d959dec1191e086febd11aa684c9d'\n                    gt: 'd41d16df5b99010ec511ec10aaaafcb8',\n                    width: document.body.offsetWidth,\n                    challenge: result.challenge\n                };\n\n                s.src = 'http://api.geetest.com/get.php?' + Object.keys(params)\n                        .map(function (key) {return key + '=' + params[key]})\n                        .join('&');\n\n\n                var fatherDom = angular.element(document.getElementById('geetestContainer'));\n\n                fatherDom.append(s);//append the script where ever you want\n\n                $window.gt_custom_ajax = function(result, id, message) {\n                    if(result) {\n                        var value = angular.element(document.getElementById('geetestContainer')).find('input');\n\n                        var data = {\n                            \"geetest_challenge\":value[0].value,\n                            \"geetest_validate\":value[1].value,\n                            \"geetest_seccode\":value[2].value,\n                            \"type\" : scope.type,\n                            \"mobile\" : scope.mobile\n                        };\n\n                        var timer = $interval(function () {\n                            if (!--scope.remains) {\n                                $interval.cancel(timer);\n                                scope.remains = remains;\n                                scope.triggered = true\n\n                                stateMachine('show-refetch', scope.valid == 'true');\n                                try {\n                                    GeeTest[0].refresh()\n                                } catch (e) {}\n                            }\n                        }, 1000);\n\n                        User.getSmsCode(data).success(function() {\n                            console.log(\"success\")\n                        }).catch(function (res) {\n                            Alert.show(res.data.validationStatus, '验证码发送失败');\n                        });\n\n                        stateMachine('hide-geetest')\n                    }\n                }\n            });\n\n            var remains = 30;\n            scope.remains = 30;\n\n            scope.$watch('mobile', function (mobile) {\n                stateMachine('mobile', scope.valid == 'true')\n            });\n\n            scope.showGeetest = function () {\n                stateMachine('show-geetest');\n            };\n\n            // {0: init-not-ready, 1: init-ready, 2: hide-btn-show-geetest,\n            //  3: hide-geetest-show-sending 4 show-re-btn-invalid, 5 re-btn}\n            scope.state = 0;\n            function stateMachine(action, data) {\n                var state = scope.state, isValid = !!data;\n                if (action == 'mobile') {\n                    if (state === 0 && isValid) {\n                        scope.state = 1;\n                    } else if (state == 1 && !isValid) {\n                        scope.state = 0;\n                    } else if (state == 2 && !isValid) {\n                        scope.state = 4;\n                    }\n                    else if (state == 4 && isValid) {\n                        scope.state = 5;\n                    } else if (state == 5 && !isValid) {\n                        scope.state = 4;\n                    }\n                } else if (action == 'show-geetest') {\n                    if (state == 1 || state == 5) {\n                        scope.state = 2;\n                    }\n                } else if (action == 'hide-geetest') {\n                    if (state == 2) {\n                        scope.state = 3;\n                    }\n                } else if (action == 'show-refetch') {\n                    if (state == 3) {\n                        scope.state = isValid ? 5 : 4;\n                    }\n                }\n            }\n        }\n    }\n}])\nangular.module('xw.directives').directive('imgLazyLoad', ['$window', '$document', '$timeout', function ($window, $document, $timeout) {\n\n    var lazyDOMs = [],\n        document = $document[0],\n        windowBottom;\n\n    /**\n     * 获取目标元素距离根元素的高度\n     */\n    function getDOMTop(elem) {\n        var top = elem.offsetTop;\n        while (elem = elem.offsetParent) {\n            top += elem.offsetTop\n        }\n        return top;\n    }\n\n    function getWindowBottom() {\n        return document.documentElement.clientHeight + ($window.scrollY ||\n            document.documentElement.scrollTop || document.body.scrollTop);\n    }\n\n    getWindowBottom.ok = true;\n\n    angular.element($window).on('scroll', function () {\n        windowBottom = getWindowBottom();\n        for (var i = 0, el; i < lazyDOMs.length;) {\n            if (getDOMTop(lazyDOMs[i][0]) < windowBottom) {\n                el = angular.element(lazyDOMs[i][0]);\n                el[0].src = lazyDOMs[i][1].$eval(el.attr('img-lazy-load'));\n                lazyDOMs.splice(i, 1);\n            } else {\n                i++;\n            }\n        }\n    });\n\n    return {\n        restrict: 'A',\n        link: function (scope, el, attr) {\n            var dom = el[0];\n            lazyDOMs.push([dom, scope]);\n            var unwatcher = scope.$watch(attr.imgLazyLoad, function (src) {\n                if (src) {\n                    unwatcher();\n                    if (getWindowBottom.ok) {\n                        windowBottom = getWindowBottom();\n                        getWindowBottom.ok = false;\n                        setTimeout(function () {\n                            getWindowBottom.ok = true;\n                        }, 120); // 120 ms内不再计算window bottom\n                        // qq 浏览器会忽略100ms以下的setTimeout !!!!\n                        // http://www.qianduan.net/qqliu-lan-qi-x5nei-he-wen-ti-hui-zong/\n                    }\n                    // todo: 试着用setTimeout来比较这里的性能\n                    if (getDOMTop(dom) < windowBottom) {\n                        lazyDOMs.some(function (pair, i) {\n                            if (pair[0] == dom) {\n                                dom.src = src;\n                                lazyDOMs.splice(i, 1);\n                                return true;\n                            }\n                        })\n                    }\n                }\n            });\n\n            if (!scope._lazyDestroyBinded) {\n                scope._lazyDestroyBinded = true;\n                scope.$on('$destroy', function () {\n                    for (var i = 0; i < lazyDOMs.length;) {\n                        if (lazyDOMs[i][1] == scope) {\n                            lazyDOMs.splice(i, 1);\n                        } else {\n                            i++;\n                        }\n                    }\n                })\n            }\n        }\n    }\n}])\nangular.module('xw.directives').directive('menuNav', function () {\n    return {\n        restrict: 'E',\n        scope: {\n            path: '@',\n            localBag: '=',\n            isAddressOk: '&'\n        },\n        templateUrl: 'menu-nav.html',\n        link: function ($scope) {\n            $scope.goToCart = function () {\n                location.href= '/mobile/cart';\n            };\n\n            if (location.pathname == '/mobile/me') {\n                $scope.path = '/mobile/me';\n            }\n        }\n    }\n})\nangular.module('xw.directives').directive('modal', function () {\n    return {\n        restrict: 'E',\n        transclude: true,\n        scope: {\n            show: \"=\",\n            close: '=',\n            toggle: '=',\n            preClose: '=?'\n        },\n        templateUrl: 'modal.html',\n        link: function (scope, el, attrs) {\n            scope.css = {show: false};\n\n            if (attrs.default == 'show') {\n                scope.css.show = true;\n            }\n\n            scope.show = function () {\n                setStatus(event, true);\n            };\n\n            scope.close = function (ignorePreClose) {\n                if (!ignorePreClose && scope.preClose) {\n                    scope.preClose();\n                }\n                setStatus(event, false);\n            };\n\n            scope.toggle = function () {\n                setStatus(event);\n            };\n\n            function setStatus(event, status) {\n                event && event.stopPropagation();\n                if (status === undefined) {\n                    scope.css.show = !scope.css.show;\n                } else {\n                    scope.css.show = status;\n                }\n            }\n        }\n    }\n});\nangular.module('xw.directives').directive('shoppingProgressBar', function () {\n    return {\n        templateUrl: 'shopping-progress-bar.html',\n        scope: true,\n        link: function (scope) {\n            var path = location.pathname;\n            if (path == '/mobile/cart') {\n                scope.state = 'state1';\n            } else if (path == '/mobile/orderaddress') {\n                scope.state = 'state2'\n            } else if (path == '/mobile/orderpay') {\n                scope.state = 'state3'\n            }\n        }\n    }\n})\nangular.module('xw.directives').directive('smsButton', [\"Debug\", \"User\", \"$interval\", function (Debug, User, $interval) {\n    return {\n        scope: {\n            valid: '@',\n            mobile: '@',\n            type: '@'\n        },\n        templateUrl: 'sms-button.html',\n        link : function (scope) {\n            scope.state = 0; // {0: init-not-ready, 1: init-ready, 2: receiving, 3: refetch-not-ready, 4: refetch-ready}\n            scope.remains = 60;\n\n            var cancel = watchMobile();\n\n            scope.getSmsCode = function () {\n                scope.state = 2;\n                if (cancel) {\n                    cancel();\n                    cancel = null;\n                }\n\n                var timer = $interval(function () {\n                    if (!--scope.remains) {\n                        $interval.cancel(timer);\n                        scope.remains = 60;\n\n                        Debug.assert(typeof scope.valid == 'string', '由@传入的valid应当是string');\n                        if (scope.valid === 'true') {\n                            scope.state = 4;\n                        } else {\n                            scope.state = 3;\n                        }\n\n                        // 重新 watch mobile\n                        cancel = watchMobile();\n                    }\n                }, 1000);\n\n                User.getSmsCode({\n                    mobile: scope.mobile,\n                    type: scope.type\n                }).then(function (res) {\n                    //dev\n                    if (res.data.code) {\n                        // todo: should alert some thing?\n                    }\n                }).catch(function (res) {\n                    // todo: should alert some thing?\n                    alert('获取验证码失败,请稍后重试');\n                    Debug.alert(res);\n                })\n            };\n\n            function watchMobile() {\n                return scope.$watch('mobile', function (mobile) {\n                    if (scope.state === 0 && mobile && mobile.length == 11) {\n                        scope.state = 1;\n                    } else if (scope.state === 1 && (!mobile || mobile.length != 11)) {\n                        scope.state = 0;\n                    } else if (scope.state === 3 && mobile && mobile.length ==11) {\n                        scope.state = 4;\n                    } else if (scope.state === 4 && (!mobile || mobile.length != 11)) {\n                        scope.state = 3;\n                    }\n                })\n            }\n        }\n    }\n}])\nangular.module('xw.directives').directive('thanksgiving', [\"$timeout\", function ($timeout) {\n    return {\n        restrict: 'E',\n        templateUrl: 'thanksgiving.html',\n        link: function (scope) {\n            $timeout(function () {\n                scope.close()\n            }, 4500);\n        }\n    }\n}]);"],"sourceRoot":"/source/"}