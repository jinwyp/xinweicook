angular.module("xw",["xw.config","xw.services","xw.controllers","xw.directives","xw.filters"]),angular.module("xw.config",["ngStorage"]),angular.module("xw.models",["ngStorage"]),angular.module("xw.controllers",["xw.models","xw.weixin"]),angular.module("xw.directives",["xw.models"]),angular.module("xw.filters",[]),angular.module("xw.weixin",[]),angular.module("xw.services",[]);
angular.module("xw.directives").directive("addDishBar",["Debug","User","$localStorage","$filter","Utils",function(r,e,t,i,n){return{scope:{dish:"=",user:"=",localBag:"="},templateUrl:"add-dish-bar.html",link:function(r){var o=r.storage=t,u=r.localBag=[],c=r.$watch("user",function(e){e&&(c(),r.localBag=u=n.mergeCarts(u,e.shoppingCart.filter(function(r){return!!r.dish})),r.totalPrice())});r.$watch("dish",function(e){if(e){var t={};r.dish.preferences.forEach(function(r){r.foodMaterial.forEach(function(r){r.outOfStock=!(r.dish.stockWarehouseObj[o.warehouse]>0||"ready to cook"==r.dish.cookingType)}),r.foodMaterial.some(function(e){return e.outOfStock?!1:(t[r.name.zh]=e.dish,!0)})}),r.dish.curSelection=t}}),r.addToCart=function(t){var i,o=t.curSelection,c={dish:t,number:t.count,subDish:Object.keys(o).map(function(r){return{dish:o[r],number:t.count}})};u.some(function(r){return n.isSameItemInCart(r,c)?(i=r,i.number+=c.number,i.subDish.forEach(function(r){r.number=i.number}),!0):void 0}),i||u.push(c),t.count=0,r.hide(),e.postCart(u.filter(function(r){return!!r.dish}).map(a)),r.totalPrice()};var a=i("postDish");r.totalPrice=function(){var r=u.filter(function(r){return!!r.dish}).reduce(function e(r,t){return r+=t.dish.priceOriginal*t.number,t.subDish&&(r+=t.subDish.reduce(e,0)),r},0);return u.price=r},r.totalPrice(),r.hide=function(){r.dish=null}}}}]);
angular.module("xw.directives").directive("autoFocus",function(){return{restrict:"A",link:function(t,i){setTimeout(function(){i[0].focus()},100)}}});
angular.module("xw.directives").directive("backButton",function(){return{template:'<div class="back-icon" ng-click="back()"></div>',link:function(i){i.back=function(){history.length<=1&&(location.href="/mobile/"),history.back()}}}});
angular.module("xw.directives").directive("couponCode",["Coupon","$q",function(e,n){return{restrict:"A",scope:{couponPrice:"=couponCode"},require:"?ngModel",link:function(o,t,r,c){c&&(c.$asyncValidators.couponCode=function(t,r){var c=t||r;return c?(c=8==c.length?"zz"+c:c,e.getCouponInfo(c).then(function(e){var t=e.data,r=new Date(e.headers("date")),c=new Date(t.startDate),a=new Date(t.endDate);return r>=c&&a>=r?void(o.couponPrice=t.price):n.reject("未在可使用期限内")})):n.resolve(1)})}}}]);
angular.module("xw.directives").directive("geetestSmsButton",["Debug","User","$interval","$window","Alert","$http",function(e,t,s,a,n,i){return{scope:{valid:"@",mobile:"@",type:"@"},templateUrl:"geetest-sms-button.html",link:function(e){function c(t,s){var a=e.state,n=!!s;"mobile"==t?0===a&&n?e.state=1:1!=a||n?2!=a||n?4==a&&n?e.state=5:5!=a||n||(e.state=4):e.state=4:e.state=0:"show-geetest"==t?(1==a||5==a)&&(e.state=2):"hide-geetest"==t?2==a&&(e.state=3):"show-refetch"==t&&3==a&&(e.state=n?5:4)}i.get("/api/user/signup/geetest/register").success(function(i){var l=document.createElement("script"),u={gt:"d41d16df5b99010ec511ec10aaaafcb8",width:document.body.offsetWidth,challenge:i.challenge};l.src="http://api.geetest.com/get.php?"+Object.keys(u).map(function(e){return e+"="+u[e]}).join("&");var r=angular.element(document.getElementById("geetestContainer"));r.append(l),a.gt_custom_ajax=function(a,i,l){if(a){var u=angular.element(document.getElementById("geetestContainer")).find("input"),r={geetest_challenge:u[0].value,geetest_validate:u[1].value,geetest_seccode:u[2].value,type:e.type,mobile:e.mobile},g=s(function(){if(!--e.remains){s.cancel(g),e.remains=o,c("show-refetch","true"==e.valid);try{GeeTest[0].refresh()}catch(t){}}},1e3);t.getSmsCode(r).success(function(){console.log("success")})["catch"](function(e){n.show(e.data.validationStatus,"验证码发送失败")}),c("hide-geetest")}}});var o=30;e.remains=30,e.$watch("mobile",function(t){c("mobile","true"==e.valid)}),e.showGeetest=function(){c("show-geetest")},e.state=0}}}]);
angular.module("xw.directives").directive("imgLazyLoad",["$window","$document","$timeout",function(o,e,n){function t(o){for(var e=o.offsetTop;o=o.offsetParent;)e+=o.offsetTop;return e}function r(){return c.documentElement.clientHeight+(o.scrollY||c.documentElement.scrollTop||c.body.scrollTop)}var i,l=[],c=e[0];return r.ok=!0,angular.element(o).on("scroll",function(){i=r();for(var o,e=0;e<l.length;)t(l[e][0])<i?(o=angular.element(l[e][0]),o[0].src=l[e][1].$eval(o.attr("img-lazy-load")),l.splice(e,1)):e++}),{restrict:"A",link:function(o,e,n){var c=e[0];l.push([c,o]);var a=o.$watch(n.imgLazyLoad,function(o){o&&(a(),r.ok&&(i=r(),r.ok=!1,setTimeout(function(){r.ok=!0},120)),t(c)<i&&l.some(function(e,n){return e[0]==c?(c.src=o,l.splice(n,1),!0):void 0}))});o._lazyDestroyBinded||(o._lazyDestroyBinded=!0,o.$on("$destroy",function(){for(var e=0;e<l.length;)l[e][1]==o?l.splice(e,1):e++}))}}}]);
angular.module("xw.directives").directive("shoppingProgressBar",function(){return{templateUrl:"shopping-progress-bar.html",scope:!0,link:function(e){var t=location.pathname;"/mobile/cart"==t?e.state="state1":"/mobile/orderaddress"==t?e.state="state2":"/mobile/orderpay"==t&&(e.state="state3")}}});
angular.module("xw.directives").directive("smsButton",["Debug","User","$interval",function(t,e,n){return{scope:{valid:"@",mobile:"@",type:"@"},templateUrl:"sms-button.html",link:function(a){function i(){return a.$watch("mobile",function(t){0===a.state&&t&&11==t.length?a.state=1:1!==a.state||t&&11==t.length?3===a.state&&t&&11==t.length?a.state=4:4!==a.state||t&&11==t.length||(a.state=3):a.state=0})}a.state=0,a.remains=60;var s=i();a.getSmsCode=function(){a.state=2,s&&(s(),s=null);var l=n(function(){--a.remains||(n.cancel(l),a.remains=60,t.assert("string"==typeof a.valid,"由@传入的valid应当是string"),a.state="true"===a.valid?4:3,s=i())},1e3);e.getSmsCode({mobile:a.mobile,type:a.type}).then(function(t){t.data.code})["catch"](function(e){alert("获取验证码失败,请稍后重试"),t.alert(e)})}}}}]);
angular.module("xw.directives").directive("flashClass",function(){return{restrict:"A",scope:{options:"=flashClass"},require:"?ngModel",link:function(s,o){var t=s.options.duration||700,e=s.options.className||"flash";s.$watch("options.exp",function(s,i){(s==i&&s||s)&&setTimeout(function(){o.addClass(e),setTimeout(function(){o.removeClass(e)},t)},200)})}}});
angular.module("xw.directives").directive("modal",function(){return{restrict:"E",transclude:!0,scope:{show:"=",close:"=",toggle:"=",preClose:"=?"},templateUrl:"modal.html",link:function(e,o,s){function t(o,s){o&&o.stopPropagation(),e.css.show=void 0===s?!e.css.show:s}e.css={show:!1},"show"==s["default"]&&(e.css.show=!0),e.show=function(){t(event,!0)},e.close=function(o){!o&&e.preClose&&e.preClose(),t(event,!1)},e.toggle=function(){t(event)}}}});
angular.module("xw.directives").directive("confirm",["$q",function(e){return{restrict:"E",transclude:!0,scope:{show:"="},templateUrl:"confirm.html",link:function(n){var o;n.show=function(){return o=e.defer(),n.showModal(),o.promise},n.confirm=function(){n.close(!0),o.resolve(!0)},n.cancel=function(){n.close()},n.preClose=function(){o.resolve(!1)}}}}]);
angular.module("xw.directives").directive("address",["$timeout","$location","Address","Utils","$q","Weixin","Map","Alert",function(e,t,r,d,s,n,i,a){return{restrict:"E",scope:{outAddress:"=",range:"=",save:"=",leave:"=",valid:"=",deleteHook:"&",hide:"&",cur:"@"},templateUrl:"address.html",link:function(e){var a,o=e.css={edit:!1,cur:"true"==e.cur,showSearchAddress:!1,form:null,locating:!1,isWeixin:n.isWeixin,isNewAddress:Object.keys(e.outAddress).length<2},u=e.data={street:""};o.isNewAddress?(a=e.addr={sortOrder:0},o.cur&&(o.edit=!0)):a=e.addr=d.regularizeAddress(angular.copy(e.outAddress),e.range),e.outAddress.cur=o.cur,e.outAddress.edit=!!o.edit,e.options=d.addressOptions.bind(null,e.range),e.$on("$locationChangeStart",function(){if(o.edit){var e=t.path();o.showSearchAddress="/search-address"==e}}),e.choose=function(){o.cur?(o.edit=!0,e.outAddress.edit=!0):(o.cur=!0,o.isNewAddress&&(o.edit=!0,e.outAddress.edit=!0)),e.outAddress.cur=!0},e.trySelectUnique=function(){var t=e.options(a.province);1==t.length&&(a.city=t[0])},e.deleteAddress=function(t){t.stopPropagation(),r["delete"](a._id),e.deleteHook&&e.deleteHook()},e.showSearchAddress=function(){u.street=a.street,t.path("search-address"),e.data.streetList&&(e.data.streetList.length=0),e.searchAddress()},e.searchAddress=function(){u.street&&i.search(u.street,a.city||"全国").then(function(t){e.data.streetList=t.data})},e.confirmStreet=function(e,r){e.stopPropagation(),t.path(""),r&&(a.street=r.address,a.geoLatitude=r.lat,a.geoLongitude=r.lng)},e.save=function(){return o.form.$invalid?s.resolve(!1):(o.edit=o.cur=!1,e.outAddress.edit=e.outAddress.cur=!1,a.isDefault=!0,r[o.isNewAddress?"addOne":"update"](a).then(function(t){return a=e.addr=t.data,e.outAddress.cur=o.cur=!0,angular.extend(e.outAddress,t.data),t.data}))},e.leave=function(){e.outAddress.cur=o.cur=!1},e.valid=function(){return o.form.$submitted=!0,!o.form.$invalid},e.initForm=function(e){o.form=e,o.showFakeInput=!a.province},e.locate=function(t){t.stopPropagation(),o.locating=!0,n.getLocation(function(t){n.getLocationName(t.latitude,t.longitude).then(function(r){var s=r.data.result;s=angular.pick(s.addressComponent,"province","city","district","street","street_number");var n=i.gcj02ToBd09({lat:t.latitude,lng:t.longitude});s.geoLatitude=n.lat,s.geoLongitude=n.lng,d.regularizeAddress(s,e.range),angular.extend(a,s)})["catch"](angular.noop).then(function(){o.locating=!1})},function(){o.locating=!1})}}}}]);
angular.module("xw.directives").directive("addressList",["$q","Alert",function(e,s){return{restrict:"E",scope:{addresses:"=",range:"=",watchAddress:"=save",editing:"=",hideOthersWhenEdit:"@"},templateUrl:"address-list.html",link:function(d){var r=d.data={newAddress:{}},t=d.handler={save:[],leave:[],valid:[]};d.hideAddress=function(e){if("true"==d.hideOthersWhenEdit&&d.addresses){var s=-1;return d.data.newAddress.edit&&(s=-2),-1==s&&d.addresses.some(function(e,d){return e.edit?(s=d,!0):void 0}),-1!=s&&e!=s}},d.editing=function(){return d.addresses?!!r.newAddress.edit||d.addresses.some(function(e){return e.edit}):!1},d.remove=function(e){d.addresses.splice(e,1),t.save.splice(e,1),t.leave.splice(e,1),t.valid.splice(e,1)},d.watchAddress=function(n){var a,i=n.target,l=i;do if(-1!=l.className.indexOf("address-item"))for(var c=l.parentElement.children,o=0,u=c.length;u>o;o++)if(c[o]==l){a=o;break}while(l=l.parentElement);var v=-1,f=-1;if(d.addresses.forEach(function(e,s){e.edit&&(v=s),e.cur&&(f=s)}),!(a==f||a==d.addresses.length&&r.newAddress.cur)){var h;if(-1!=v){if(!t.valid[v]())return n.stopPropagation();h=t.save[v]()}else if(r.newAddress.edit){if(!t.valid.newAddress())return n.stopPropagation();h=t.save.newAddress().then(function(e){return d.addresses.push(e),r.newAddress={},e})["catch"](function(e){s.show(e.data.validationStatus,"保存失败")})}return-1!=f?(t.leave[f](),-1==v&&(h=e.resolve(d.addresses[f]))):r.newAddress.cur&&t.leave.newAddress(),h}}}}}]);
angular.module("xw.directives").directive("captureClick",["$parse","$rootScope",function(e,n){return{restrict:"A",compile:function(c,t){var r=e(t.captureClick,null,!0);return function(e,c){c[0].addEventListener("click",function(c){var t=function(){r(e,{$event:c})};n.$$phase?e.$evalAsync(t):e.$apply(t)},!0)}}}}]);
angular.module("xw.directives").directive("errTip",function(){return{scope:{form:"=",error:"@",name:"@"},transclude:!0,templateUrl:"err-tip.html"}});
angular.module("xw.directives").directive("menuNav",function(){return{restrict:"E",scope:{path:"@",localBag:"=",isAddressOk:"&"},templateUrl:"menu-nav.html",link:function(e){e.goToCart=function(){location.href="/mobile/cart"},"/mobile/me"==location.pathname&&(e.path="/mobile/me")}}});
angular.module("xw.directives").directive("addressSelection",function(){return{restrict:"E",scope:{animateTrigger:"=",show:"=",address:"=",noAddress:"=",dishId:"@",path:"@"},templateUrl:"address-selection.html"}});
angular.module("xw.directives").directive("thanksgiving",["$timeout",function(t){return{restrict:"E",templateUrl:"thanksgiving.html",link:function(i){t(function(){i.close()},4500)}}}]);
angular.module("xw.services").factory("Alert",function(){var r={1110:"手机号码或密码错误",1111:"手机号码或密码错误",1112:"该用户已存在",1113:"手机号码或密码错误",2110:"手机号码错误",3110:"短信码错误",3111:"短信码已过期",3112:"无效的短信码",3113:"错误的短信码类型",3114:"短信码验证次数过多, 请重新接收短信码",3115:"发送失败, 请稍后重试",3116:"短信码发送次数达到当日最大次数",4110:"库存不足",5110:"尚未到充值码使用时间",5111:"优惠码/优惠券已过期",5112:"优惠码/优惠券已被使用",5113:"超出优惠码/优惠券最大使用次数",5121:"只能兑换一次朋友的邀请码(无论是否是同一个朋友), 您已经兑换过一次了"};return{show:function(e,n){var t=r[e];t?alert(t):n&&alert(n)},message:function(e){return r[e]||""}}});
angular.module("xw.services").provider("Debug",function(){var e=this;e.debugKey="debug",this.$get=["Utils",function(t){var r=new RegExp("\\b"+e.debugKey+"\\b"),s="",o=t.searches(location.search);r=r.test(location.search)||!!sessionStorage.getItem("debug"),r&&!sessionStorage.getItem("debug")&&sessionStorage.setItem("debug","true"),r&&"fakewarehouse"in o&&(s=o.fakewarehouse);var a={isDebug:r,alert:function(e){this.isDebug&&(console.log(e),e="[object Object]"==Object.prototype.toString.call(e)?JSON.stringify(e):e,alert(e))},assert:function(e,t){this.isDebug&&!e&&alert(t)},promiseErrFn:function(e){return function(t){a.alert(e),a.alert(t)}},fakeWarehouse:s};return a}]});
angular.module("xw.services").factory("Map",["$http","Debug",function(e,n){var a={xinweioffice:6e3,caohejing1:1560},t={bentoNoReach:999999,topDistance:{xinweioffice:6e3,caohejing1:1560},suggestion:function(n,a){return e.get("/mobile/placesuggestion?query="+n+"&region="+a)},search:function(n,a){return e.post("/api/user/address/suggestion",{query:n,region:a})},gcj02ToBd09:function(e){var n=e.lat,a=e.lng,t=Math.sqrt(a*a+n*n)+2e-5*Math.sin(n*Math.PI),r=Math.atan2(n,a)-3e-6*Math.cos(a*Math.PI);return{lng:t*Math.cos(r)+.0065,lat:t*Math.sin(r)+.006}},bd09ToGcj02:function(e){var n=e.lat-.006,a=e.lng-.0065,t=Math.sqrt(a*a+n*n)-2e-5*Math.sin(n*Math.PI),r=Math.atan2(n,a)-3e-6*Math.cos(a*Math.PI);return{lng:t*Math.cos(r),lat:t*Math.sin(r)}},lineDistance:function(e,n,a,t){var r=6371e3,i=Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.cos((n-t)*Math.PI/180),o=Math.sin(e*Math.PI/180)*Math.sin(a*Math.PI/180),s=i+o;s>1&&(s=1),-1>s&&(s=-1);var c=Math.acos(s);return c*r},lineDistance2CHJ:function(e,n){var a=this.warehouseCoords.caohejing1;return this.lineDistance(e,n,a.lat,a.lng)},fixZero:function(e,n,a){if(0!==e)return e;var t=this.lineDistance(n,a,31.189426,121.460625);return t>1500?999999:e},walkingDistance:function(n,t,r){var i;r=r||"",Array.isArray(arguments[0])?(i=arguments[0],r=t):i=[{lat:n,lng:t}];var o="";return i.forEach(function(e,n){if(!(n>=5)){var a=0==n?"":"|";o+="string"==typeof e?a+e:a+e.lat+","+e.lng}}),e.get("/mobile/distance?destinations="+encodeURIComponent(o)+"&warehouse="+r).then(function(e){for(var n,t=e.data.result.elements,r=[],i=t.length/2,o=0;i>o;o++)t[o].warehouse="xinweioffice",t[i+o].warehouse="caohejing1",n=[t[o],t[i+o]],n=angular.sort(n,function(e,n){return e.distance.value-a.xinweioffice-(n.distance.value-a.caohejing1)}),r.push(n);return r})["catch"](function(){return console.log("get distance error"),[]})},distance:function(e,r,i){return this.walkingDistance(e,r,i).then(function(n){var i=n[0][0].distance.value;i=t.fixZero(i,e,r);var o=a[n[0][0].warehouse];return{distance:i,isInRange:o>=(null===i?999999:i),warehouse:n[0][0].warehouse}})["catch"](function(e){n.alert("获取步行距离失败"),n.alert(e)})},distances:function(e,n){return e=Array.isArray(e)?e:[e],this.walkingDistance(e,n).then(function(n){return n.map(function(n,r){var i=t.fixZero(n[0].distance.value,e[r].lat,e[r].lng),o=a[n[0].warehouse];return{distance:i,isInRange:o>=(null===i?999999:i),warehouse:n[0].warehouse}})})},nearestWarehouse:function(e,t){var r=this,i=a.xinweioffice,o=a.caohejing1,s=angular.sort(["xinweioffice","caohejing1"].map(function(n){var a=r.warehouseCoords[n];return{name:n,distance:r.lineDistance(e,t,a.lat,a.lng)}}),function(e,n){return e.distance-i+1100-(n.distance-o)});return n.fakeWarehouse?n.fakeWarehouse:s[0].name},warehouseCoords:{xinweioffice:{lat:31.189426,lng:121.460625},caohejing1:{lat:31.16925,lng:121.398949}}};return t}]);
angular.module("xw.services").factory("ScopeDecorator",["$location",function(o){return{common:function(o){o&&(o.back=function(){history.length>1?history.back():location.href="/mobile/"})},nav:function(n){n&&n.$on("$locationChangeStart",function(){n.path=o.path()})}}}]);
angular.module("xw.services").factory("Utils",["$localStorage",function(e){return{utf2b64:function(e){return btoa(unescape(encodeURIComponent(e))).replace(/\+/g,"-").replace(/\//g,"_")},b642utf:function(e){return decodeURIComponent(escape(window.atob(e.replace(/-/g,"+").replace(/_/g,"/"))))},isSameItemInCart:function(e,t){return e.dish._id==t.dish._id&&e.subDish.every(function(e){return t.subDish.some(function(t){return e.dish._id==t.dish._id})})&&e.subDish.length==t.subDish.length},mergeCarts:function(e,t){if(!e||!e.length)return t;for(var n=this,r=0;r<t.length;r++){var i=e.every(function(e){return!n.isSameItemInCart(e,t[r])});i&&e.push(t[r])}return e},getStockId:function(e,t){var n={};return e.forEach("preference"==t?function(e){e.preferences.forEach(function(e){e.foodMaterial.forEach(function(e){!n[e.dish._id]&&e.dish.isPublished&&(n[e.dish._id]=!0)})})}:function(e){n[e._id]||e.outOfStock||(n[e._id]=!0)}),Object.keys(n)},cleanLocalStorage:function(){var t=["promotion","access_token","selectedAddress"];Object.keys(e).forEach(function(n){-1==t.indexOf(n)&&"$"!=n[0]&&delete e[n]})},searches:function(e){return e=e||location.search,e.slice(1).split("&").reduce(function(e,t){return t&&(t=t.split("="),e[t[0]]=decodeURIComponent(t[1]||"")),e},{})},addressEqual:function(e,t){return e=e||"",t=t||"",e&&t?!e.indexOf(t)||!t.indexOf(e):!1},regularizeAddress:function(e,t){var n,r,i=this.addressEqual;return t.some(function(t){return i(e.province,t.state)?(e.province=t.state,n=t.cities,!0):void 0}),n&&n.some(function(t){return i(e.city,t.city)?(e.city=t.city,r=t.areas,!0):void 0}),r&&r.some(function(t){return i(e.district,t)?(e.district=t,!0):void 0}),e},addressOptions:function(e,t,n){var r=arguments.length;if(1==r)return e.map(function(e){return e.state});if(2==r){if(!t)return;return e.filter(function(e){return e.state==t})[0].cities.map(function(e){return e.city})}if(3==r){if(!n)return;var i=e.filter(function(e){return e.state==t})[0].cities.filter(function(e){return e.city==n});if(i&&i.length)return i[0].areas}},stockOfDish:function(e,t){return e.stockWarehouse.some(function(e){return e.warehouse==t&&e.stock>0})},stockOfItem:function(e,t){var n=this.stockOfDish;return n(e.dish,t)&&!!e.subDish&&e.subDish.every(function(e){return n(e.dish,t)})}}}]);
angular.module("xw.weixin").factory("Weixin",["$http","Debug",function(e,n){var t={wx:{appId:"wx37a1323e488cef84",jsApiList:["getLocation","onMenuShareTimeline","onMenuShareAppMessage"]},location:{longitude:121.460625,latitude:31.189426},ak:"xnKgWtGYXf4gkLgreox7xpjI",oauthUrl:"/api/orders/payment/weixinpay/oauthcode?orderid="};return{isWeixin:/MicroMessenger/i.test(navigator.userAgent),oauthUrl:t.oauthUrl,readyState:!1,ready:function(e){this.readyState?e():this.ready.cb=e},config:function(e){var n=this,a=angular.copy(t.wx);a.timestamp=e.timestamp,a.nonceStr=e.nonceStr,a.signature=e.signature,wx.config(a),wx.ready(function(){n.ready.cb&&n.ready.cb(),n.readyState=!0})},getLocation:function(e,n){var t={type:"gcj02"};e&&(t.success=e),n&&(t.fail=n),wx.getLocation(t)},shareTimeline:function(e){wx.onMenuShareTimeline(e)},shareAppMessage:function(e){wx.onMenuShareAppMessage(e)},showOptionMenu:function(){wx.showOptionMenu()},hideOptionMenu:function(){wx.hideOptionMenu()},getLocationName:function(n,a){var o="http://api.map.baidu.com/geocoder/v2/?output=json&pois=1&coordtype=gcj02ll&callback=JSON_CALLBACK";return e.jsonp(o,{params:{ak:t.ak,location:n+","+a}})},getJsconfig:function(){return e.post("/api/orders/payment/weixinpay/config",{url:location.href.substr(0,location.href.length-location.hash.length)})}}}]);
angular.module("xw.filters").filter("adapt",function(){var e=Math.floor(document.body.offsetWidth*window.devicePixelRatio),n=Math.floor(2*e/3),t="?imageView2/1/w/",r=t+e+"/h/"+n;return function(n,u){return n+(u?t+e+"/h/"+Math.floor(e*u):r)}}),angular.module("xw.filters").filter("fraction",function(){function e(e,n){for(var t="",r=0;r<e.length;r++)t+=n[e[r]];return t}var n=["⁰","¹","²","³","⁴","⁵","⁶","⁷","⁸","⁹"],t=["₀","₁","₂","₃","₄","₅","₆","₇","₈","₉"];return function(r){return r.replace(/(\d+)\/(\d+)/g,function(r,u,i){return e(u,n)+"⁄"+e(i,t)+" "})}}),angular.module("xw.filters").filter("postDish",function(){return function(e){return{dish:e.dish._id,number:e.number,subDish:e.subDish?e.subDish.map(function(e){return{dish:e.dish._id,number:e.number}}):[]}}}),angular.module("xw.filters").filter("beautifyMobile",function(){return function(e){return/^\d{11}$/.test(e)?e.replace(/^(\d{3})(\d{4})(\d{4})$/,function(e,n,t,r){return n+" "+t+" "+r}):e}}),angular.module("xw.filters").filter("subDishTitle",function(){return function(e){var n=e.subDish.length;return n?"("+e.subDish.reduce(function(e,t,r){return e+t.dish.title.zh+(r==n-1?"":"/")},"")+")":""}}),angular.module("xw.filters").filter("orderTime",function(){return function e(n,t){var r;return"eat"==t?{deliveryDateEat:n.hour.substr(0,10),deliveryTimeEat:n.hour.substr(11,5)}:"cook"==t?(r={deliveryDateCook:n.day},r.deliveryTimeCook=n.segment?n.segment.name+":00":"12:00",r):"all"==t?(r={},n.eat&&(r=e(n.eat,"eat")),n.cook&&angular.extend(r,e(n.cook,"cook")),r):void 0}}),angular.module("xw.filters").filter("cookTimeUnion",function(){return function(e,n,t,r){if(!e||!e.length)return e;n&&(e=[{day:"2016-02-06",segment:[{name:"10",text:"10:00-20:00",status:!0}]}]),t&&(e=r?[{day:"2016-02-13",segment:[{name:"10",text:"10:00-20:00",status:!0}]},{day:"2016-02-14",segment:[{name:"10",text:"10:00-20:00",status:!0}]}]:[{day:"2016-02-14",segment:[{name:"10",text:"10:00-20:00",status:!0}]}]);var u=!!e[0].segment;return e.reduce(function(e,n){return u?n.segment.forEach(function(t){e.push({day:n.day,segment:t})}):e.push({day:n.day}),e},[])}}),angular.module("xw.filters").filter("dishes",function(){return function(e,n,t){var r;return"order"==n&&"displayCart"==t?(r=[],Object.keys(e).forEach(function(n){e[n].forEach(function(e){r.push({dish:e.dish._id,number:e.number,subDish:e.subDish.map(function(e){return{dish:e.dish._id,number:e.number}})})})}),{dishList:r}):e}}),angular.module("xw.filters").filter("coupon",function(){return function(e){var n={};return e.code&&(n.promotionCode=e.code,8==e.code.length&&(n.promotionCode="zz"+n.promotionCode)),e.card&&(n.coupon=e.card._id),n}}),angular.module("xw.filters").filter("eatTimeOptions",function(){return function(e){return e&&e.length?(e.unshift({hour:"请选择配送时间"}),e):e}}),angular.module("xw.filters").filter("eatTimeDisplay",function(){return function(e){return e.hour}}),angular.module("xw.filters").filter("cookTimeOptions",function(){return function(e){return e&&e.length?(e.unshift({day:"请选择配送时间"}),e):e}}),angular.module("xw.filters").filter("cookTimeDisplay",function(){return function(e){return"请选择配送时间"==e.day||e.segment?e.day:e.day+" 送达"}}),angular.module("xw.filters").filter("dishPrice",function(){return function(e,n){var t=e.dish.priceOriginal;if(e.subDish)for(var r=0,u=e.subDish.length;u>r;r++)t+=e.subDish[r].dish.priceOriginal;return t*(n?e.number:1)}});
angular.module("xw.directives").run(["$templateCache",function(s){s.put("add-dish-bar.html",'<div class="selection-cover" ng-cloak ng-if="dish" ng-click="hide()"></div><div class="selections-container" ng-if="dish" ng-cloak><div class="block"><h4 class="text-center">{{dish.title.zh}}<span ng-click="hide()" class="button close-button"></span></h4><ul class="properties" ng-if="dish.preferences.length"><li ng-repeat="property in dish.preferences track by property._id"><h5>{{property.name.zh}}</h5><ul class="selections"><li ng-repeat="selection in property.foodMaterial track by selection._id" ng-click="(!selection.outOfStock && selection.dish.isPublished) && (dish.curSelection[property.name.zh] = selection.dish)" ng-class="{\'no-stock\': (selection.outOfStock || !selection.dish.isPublished), selected: dish.curSelection[property.name.zh] == selection.dish}">{{selection.dish.title.zh}}</li></ul></li></ul><div class="counter-wrapper"><i>份数</i><div class="counter text-center"><span ng-click="dish.count>0 && (dish.count=dish.count-1)" class="minus">-</span> <span class="number">{{dish.count}}</span> <span ng-click="dish.count=dish.count+1" class="add">+</span></div></div><div class="add-to-cart-button text-center" ng-class="{invalid: dish.count == 0}" ng-click="dish.count>0 && addToCart(dish)">加入购物袋</div></div></div>'),s.put("address-list.html",'<ul class="address-list" capture-click="watchAddress($event)"><li class="address-item" ng-repeat="address in addresses"><address cur="{{address.isDefault}}" range="range" out-address="address" hide="hideAddress($index)" leave="handler.leave[$index]" save="handler.save[$index]" valid="handler.valid[$index]" delete-hook="remove($index)"></address></li><li ng-if="range" class="address-item"><address range="range" out-address="data.newAddress" cur="{{!addresses.length}}" hide="hideAddress(-2)" leave="handler.leave.newAddress" save="handler.save.newAddress" valid="handler.valid.newAddress"></address></li></ul>'),s.put("address-selection.html",'<div class="address-selection" flash-class="{exp: animateTrigger, duration: 400}" ng-if="show" ng-cloak><a href="/mobile/orderaddress?path={{path}}&dishId={{dishId}}"><div ng-show="path != \'/eat\' && address" class="address-tip">配送至:{{address.street + address.address | limitTo: 18}}</div><div ng-show="noAddress" class="no-address-tip">您没有可以配送的地址,请先新建地址</div><div ng-show="path == \'/eat\' && (address && !address.isAvailableForEat)" class="no-address-tip">当前地址不在便当配送范围内</div><div ng-show="path == \'/eat\' && address.isAvailableForEat" class="address-tip">配送至:{{address.street + address.address | limitTo: 18}}</div></a></div>'),s.put("address.html",'<div ng-if="css.isNewAddress && css.edit" class="new-address-tip">请填写有效的地址以便按时送达</div><div ng-hide="hide()" class="address-component" ng-class="{cur: css.cur || css.isNewAddress, edit: css.edit}" ng-click="choose($event)"><div class="address-block" ng-if="!css.isNewAddress"><span class="deliverable-tag" ng-if="addr.isAvailableForEat">便当可送达</span><div>{{addr.contactPerson}}</div><div class="cur-show">{{addr.mobile | beautifyMobile}}</div><div class="cur-show">{{addr.province + \' \' + addr.city + \' \' + addr.district}}</div><div>{{addr.street}}</div><div class="cur-show">{{addr.address}}</div><div class="user-actions"><span class="glyphicon glyphicon-pencil"></span> <span ng-click="deleteAddress($event)" class="glyphicon glyphicon-trash"></span></div></div><div class="new-address-block" ng-if="css.isNewAddress && !css.edit">+ 新建收货地址</div><form ng-model-options="{ updateOn: \'default blur\', debounce: { \'default\': 500, \'blur\': 0 } }" ng-class="{\'new-address\': css.isNewAddress}" ng-if="css.edit" name="form"><div ng-init="initForm(form, addr)" ng-class="{\'with-tag\': addr.isAvailableForEat}"><input name="contactPerson" type="text" placeholder="收货人" ng-model="addr.contactPerson" auto-focus minlength="2" required><err-tip form="form" name="contactPerson" error="required">必填</err-tip><err-tip form="form" name="contactPerson" error="minlength">联系人姓名至少2个字</err-tip></div><div><input name="mobile" type="tel" placeholder="手机号" ng-model="addr.mobile" pattern="^1\\d{10}$" required><err-tip form="form" name="mobile" error="required">必填</err-tip><err-tip form="form" name="mobile" error="pattern">请填写11位手机号</err-tip></div><div ng-show="!css.showFakeInput" class="selects"><div class="select"><select required name="province" id="province" ng-options="province for province in options()" ng-change="trySelectUnique()" ng-model="addr.province"></select></div><div class="select"><select required name="city" id="city" ng-options="city for city in options(addr.province)" ng-model="addr.city"></select></div><div class="select"><select required name="district" id="district" ng-options="district for district in options(addr.province, addr.city)" ng-model="addr.district"></select></div></div><div ng-if="css.showFakeInput"><input type="text" placeholder="省、市、区" ng-click="css.showFakeInput = false"> <span class="err-tip" ng-if="(form.province.$error.required||form.city.$error.required||form.district.$error.required) &&form.$submitted">必填</span></div><div ng-click="showSearchAddress()">{{addr.street}} <input type="hidden" name="street" placeholder="街道" ng-model="addr.street" required> <span ng-if="!addr.street" class="placeholder">街道</span><err-tip form="form" name="street" error="required">必填</err-tip></div><div><input name="address" type="text" minlength="2" placeholder="楼层、门牌号" required ng-model="addr.address"><err-tip form="form" name="address" error="required">必填</err-tip><err-tip form="form" name="address" error="minlength">至少2个字符</err-tip></div></form><div class="search-address" ng-if="css.edit && css.showSearchAddress"><form id="address-form"><div><input type="text" placeholder="小区、写字楼、地标名称" id="address" ng-model="data.street" ng-model-options="{debounce: 400}" auto-focus ng-change="searchAddress()"></div></form><div class="find-address-tip" ng-if="data.streetList.length">您要找的是不是?</div><div class="no-address-tip" ng-if="data.street && !data.streetList.length"><h4>未能找到此地址</h4><p>建议只输入小区、写字楼、地标名称等</p></div><ul class="results"><li ng-click="confirmStreet($event, street)" ng-repeat="street in data.streetList"><h4>{{street.address}}</h4><p>{{street.addressInfoBaidu}}</p></li></ul></div></div>'),s.put("confirm.html",'<div class="xw-confirm" ng-click><modal close="close" show="showModal" pre-close="preClose"><div class="text" ng-transclude></div><div class="button-group"><span ng-click="cancel()">取消</span><span ng-click="confirm()">确定</span></div></modal></div>'),s.put("err-tip.html",'<span class="err-tip" ng-if="(form[name].$dirty||form.$submitted) && form[name].$error[error]" ng-transclude></span>'),s.put("geetest-sms-button.html",'<div class="geetest-sms-button-group"><div id="geetestContainer" ng-show="state==2"></div><span class="geetest-sms-button" ng-if="state <= 1" ng-class="{invalid: state === 0}" ng-click="state == 1 && showGeetest()">获取验证码</span> <span class="geetest-sms-button invalid" ng-if="state == 3">发送成功 {{remains}}</span> <span ng-click="state == 5 && showGeetest()" class="geetest-sms-button" ng-class="{invalid: state == 4}" ng-if="state > 3">重新获取</span></div>'),s.put("menu-nav.html",'<nav class="menu-nav" ng-class="{\'empty\': !localBag.length}"><div ng-class="{active: path == \'/mobile/me\'}"><a href="/mobile/me"><span>帐号</span></a></div><div ng-class="{active: path == \'/eat\'}"><a href="/mobile/#/eat"><span>便当</span></a></div><div ng-class="{active: path == \'/cook\' || !path}"><a href="/mobile/#/cook"><span>食材包</span></a></div><div class="go-to-cart" ng-class="{invalid: !isAddressOk()}" ng-if="localBag.length" flash-class="{exp: localBag.length, duration: 400}" ng-click="isAddressOk({isClick: true}) && goToCart()"><div class="icon bag-icon"><i class="number" ng-bind="localBag.length"></i></div><span class="price" ng-bind="localBag.price || 0 | number: 1"></span></div></nav>'),s.put("modal.html",'<div class="xw-modal-container" ng-show="css.show"><div class="xw-modal-backdrop" ng-click="close()"></div><div class="xw-modal-content" ng-transclude></div></div>'),s.put("shopping-progress-bar.html",'<div class="shopping-progress-bar"><div class="states"><span ng-class="{cur: state == \'state1\'}" class="state1">筛选购物袋</span> <span ng-class="{cur: state == \'state2\'}" class="state2">确认送货地址</span> <span ng-class="{cur: state == \'state3\'}" class="state3">支付</span></div><div class="state-bar-container"><div class="indicator" ng-class="state"></div></div></div>'),s.put("sms-button.html",'<div class="sms-button-group"><span class="sms-button" ng-if="state <= 1" ng-class="{invalid: state === 0}" ng-click="state == 1 && getSmsCode()">获取验证码</span> <span class="sms-button invalid" ng-if="state == 2">{{remains}}秒后重新获取</span> <span ng-click="state == 4 && getSmsCode()" class="sms-button" ng-class="{invalid: state == 3}" ng-if="state > 2">重新获取</span></div>'),s.put("thanksgiving.html",'<div class="thanksgiving"><modal default="show" ng-click="close()" close="close"><div class="thanksgiving-main">全周好品味，新味感谢您!</div></modal></div>')}]);
angular.module("xw.models").factory("Dishes",["$http",function(e){return{getList:function(t){return t=t||"",e.get("/api/dishes?cookingType="+t)},like:function(t){return e.put("/api/dishes/"+t+"/like")},getOne:function(t){return e.get("/api/dishes/"+t)}}}]),angular.module("xw.models").factory("Orders",["$http",function(e){return{postOrder:function(t){return e.post("/api/orders",t)},deliveryTime:function(t){return e.post("/api/orders/delivery/time",t)},deliveryEatTime:function(t){return e.post("/api/orders/delivery/time/eat/warehouse",t)},getOrder:function(t){return e.get("/api/orders/"+t)},updateOrder:function(t,n){return e.put("/api/orders/"+t,n)},getList:function(){return e.get("/api/orders")},getUnifiedOrder:function(t){return e.post("/api/orders/payment/weixinpay/unifiedorder",t)},price:function(t){return e.post("/api/orderprice",t)}}}]),angular.module("xw.models").factory("User",["$http","$localStorage",function(e,t){var n=Date.now(),r=500,o=null;return{login:function(n,r,o){var u={username:n,password:r,grant_type:"password"};return o&&(u.couponcode=o),e.post("/api/user/token",u).then(function(e){return e.data&&e.data.access_token&&(t.access_token=e.data.access_token),e})},signup:function(n,r,o,u){var i={mobile:n,pwd:r,code:o};return u&&(i.couponcode=u),e.post("/api/user/signup",i).then(function(e){return e.data&&e.data.access_token&&(t.access_token=e.data.access_token),e})},getSmsCode:function(t){return e.post("/api/user/sms",t)},logout:function(){return e.post("/api/user/logout",{token_type_hint:"access_token",token:t.access_token})},getUserInfo:function(){return e.get("/api/user").then(function(e){return localStorage.uid=e.data._id,window.trackJs.configure({userId:e.data._id}),e})},updateUser:function(t){return e.put("/api/user",t)},resetPwd:function(t,n,r){return e.post("/api/user/resetpassword",{mobile:t,pwd:n,code:r})},postCart:function(t){var u=Date.now();return u-n>r?(clearTimeout(o),e.post("/api/user/shoppingcart",{shoppingCart:t})):(clearTimeout(o),o=setTimeout(this.postCart.bind(this,t),r+100),n=u,{"catch":angular.noop})},applyInvitationCode:function(t){return e.get("/api/user/coupon/invitation/"+t)},invitedFriends:function(){return e.get("/api/user/coupon/friends")},getWeixinUserInfo:function(t){return e.get("/api/user/weixin/userinfo?userId="+t)}}}]),angular.module("xw.models").factory("Address",["$http",function(e){return{getList:function(){return e.get("/api/user/address")},addOne:function(t){return e.post("/api/user/address",t)},update:function(t){return e.put("/api/user/address/"+t._id,t)},"delete":function(t){return e["delete"]("/api/user/address/"+t)},range:function(){return e.get("/api/orders/delivery/range")}}}]),angular.module("xw.models").factory("Coupon",["$http",function(e){return{getCouponInfo:function(t){return e.get("/api/coupons/code/"+t)},exchangeCouponCode:function(t){return e.get("/api/user/coupon/code/"+t)}}}]),angular.module("xw.models").factory("Alipay",["$http",function(e){return{notify:function(t,n){var r=n?"/api/orders/payment/alipay/notify/account":"/api/orders/payment/alipay/mobile";return e.post(r,{out_trade_no:t})}}}]),angular.module("xw.models").factory("Balance",["$http","Debug",function(e,t){return{balance:function(){return e.get("/api/user/account")},chargeByCode:function(t){return e.post("/api/user/account/chargecode",{accountChargeCode:t})},chargeOnline:function(t){return e.post("/api/user/account/details",t)},balanceRecords:function(){return e.get("/api/user/account/details?skip=0&limit=200")["catch"](t.promiseErrFn("获取余额记录失败"))}}}]);
angular.module("xw.config").constant("errCode",function(){return{user:{wrongMobile:1110,wrongPassword:1111,alreadyExist:1112,notFound:1113,userReferrerWrong:1140,userIdWrong:1150,userGenderWrong:1152,userOldAddressWrong:1155,invitationSendCodeWrong:1190,addressIdWrong:1210,addressNotFound:1212,addressNotInUser:1214,addressLatitudeWrong:1220,addressLongitudeWrong:1221,addressCoordTypeWrong:1222,addressProvinceWrong:1225,addressCityWrong:1226,addressDistrictWrong:1227,addressStreetWrong:1228,addressStreetNumberWrong:1229,addressAddressWrong:1230,addressContactPersonWrong:1235,addressMobileWrong:1236,addressSortOrderWrong:1237,addressNotDeliver:1270,addressBaiduMapNotFoundError:1280,addressBaiduMapQueryWrong:1290,addressBaiduMapRegionWrong:1291,shoppingCartNotArray:1500,shoppingCartDishIdWrong:1502,shoppingCartDishNumberWrong:1504,shoppingCartSubDishIdWrong:1506,shoppingCartSubDishNumberWrong:1508},order:{notFound:2010,orderNumberWrong:2010,orderIdWrong:2011,warehouseIdWrong:2012,cookingTypeWrong:2110,clientFromWrong:2112,creditWrong:2115,freightWrong:2117,paymentWrong:2119,paymentUsedCashWrong:2120,deliveryDateCookWrong:2122,deliveryTimeCookWrong:2124,deliveryDateEatWrong:2126,deliveryTimeEatWrong:2128,dishListArrayWrong:2130,dishListDishNumberWrong:2132,dishListDishIdWrong:2134,dishListSubDishArrayWrong:2136,dishListSubDishNumberWrong:2138,dishListSubDishIdWrong:2139,addressLatitudeWrong:2140,addressLongitudeWrong:2142,addressProvinceWrong:2144,addressCityWrong:2145,addressDistrictWrong:2146,addressStreetWrong:2147,addressStreetNumberWrong:2148,addressAddressWrong:2149,addressContactPersonWrong:2152,addressMobileWrong:2154,addressIdWrong:2160,userCommentWrong:2180,dishIdInvalid:2190,notOnlyDrink:2192,notOverTenDrinks:2194,orderStatusWrong:2300,orderPaymentStatusWrong:2310},sms:{wrongCode:3110,expired:3111,invalidCode:3112,wrongType:3113,tooManyTries:3114,sendFailed:3115,reachSendLimitation:3116},dish:{outOfStock:4110},coupon:{notStart:5110,expired:5111,used:5112,outOfCount:5113,notFound:5120,exchanged:5121,couponIdWrong:5210,promotionCodeWrong:5212},announcement:{announcementIdWrong:8110,notFound:8112}}}),angular.module("xw.config").factory("commonInterceptor",["$localStorage","$q",function(r,o){var e=[/^\/mobile\/$/,/^\/mobile\/login/,/^\/mobile\/cook/,/^\/mobile\/resetpwd$/],n=["/api/user","/api/user/token","/api/user/shoppingcart","/api/user/address"],s=["/mobile/me","/mobile/addresslist","/mobile/orderaddress","/mobile/orderlist","/mobile/invite","/mobile/coupons","/mobile/cook","/mobile/balance","/mobile/chargebalanceonline","/mobile/promotion01"];return{request:function(o){return r.access_token&&(o.headers.Authorization="Bearer "+r.access_token),o},responseError:function(r){var d="";if(401==r.status){if(e.some(function(r){return r.test(location.pathname)})&&-1!=n.indexOf(r.config.url))return o.reject(r);s.some(function(r){return-1!=location.pathname.indexOf(r)})&&(d="?redirect="+location.pathname),setTimeout(function(){location.replace("/mobile/login"+d)},120)}return o.reject(r)}}}]),angular.module("xw.config").config(["$httpProvider","$compileProvider",function(r,o){r.defaults.headers.common.Accept="application/vnd.cook.v1+json",r.defaults.headers.common["Access-Control-Allow-Origin"]="http://m.xinweicook.com",r.defaults.headers.common["Accept-Language"]="zh-CN"==navigator.language?"zh-CN":"en-US",r.defaults.headers.common["Content-Type"]="application/json",r.interceptors.push("commonInterceptor"),o.debugInfoEnabled(!1)}]),angular.pick=function(r){var o=Array.prototype.slice.call(arguments,1);return o.reduce(function(o,e){return o[e]=r[e],o},{})},angular.sort=function(r,o){for(var e,n=r.slice(0),s=n.length-1;s>=1;s--)for(var d=0;s>d;d++){var t=o(n[d],n[d+1]);t>0&&(e=n[d],n[d]=n[d+1],n[d+1]=e)}return n};
//# sourceMappingURL=app-3a12f4fd36.min.js.map
